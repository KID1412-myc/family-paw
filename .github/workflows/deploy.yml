name: Deploy to Aliyun

# è§¦å‘æ¡ä»¶ï¼šå½“ main åˆ†æ”¯æœ‰æ¨é€åˆ° GitHub æ—¶æ‰§è¡Œ
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          # è¯»å– GitHub Secrets é‡Œçš„é…ç½®
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: 22
          # é‡åˆ°é”™è¯¯ç«‹å³åœæ­¢
          script_stop: true
          script: |
            # 1. è¿›å…¥é¡¹ç›®ç›®å½• (æ ¹æ®ä½ çš„å®é™…è·¯å¾„ï¼Œé€šå¸¸æ˜¯è¿™ä¸ª)
            cd /home/family-paw
            
            # 2. æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸš€ Starting Git Pull..."
            git pull origin main
            
            # 3. [æ ‡é…] æ¿€æ´»è™šæ‹Ÿç¯å¢ƒå¹¶æ›´æ–°ä¾èµ–
            # å“ªæ€•ä¾èµ–æ²¡å˜ï¼Œpip ä¹Ÿä¼šå¿«é€Ÿæ£€æŸ¥ä¸€éï¼Œä¸ä¼šæµªè´¹å¤ªå¤šæ—¶é—´
            echo "ğŸ“¦ Checking Dependencies..."
            source venv/bin/activate
            pip install -r requirements.txt
            
            # 4. é‡å¯ Gunicorn æœåŠ¡
            echo "ğŸ”„ Restarting Service..."
            systemctl restart familypaw
            
            # 5. æ£€æŸ¥æœåŠ¡çŠ¶æ€ (åªçœ‹æœ€åå‡ è¡Œæ—¥å¿—ï¼Œç¡®è®¤æ²¡æŒ‚)
            echo "âœ… Deployment Finished!"
            systemctl status familypaw --no-pager
