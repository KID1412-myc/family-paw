<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>{{ pet.name }}çš„æ¡£æ¡ˆ</title>

    <!-- PWA é…ç½® -->
    <link rel="manifest" href="/static/manifest.json?v={{ app_version }}">
    <link rel="apple-touch-icon" href="/static/icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #f0f4f8; /* æµ…è“ç°åº•è‰²ï¼Œæ›´æœ‰è´¨æ„Ÿ */
            padding-bottom: 50px;
            font-family: "Nunito", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        /* === 1. å¼§å½¢å¤´éƒ¨ === */
        .pet-header {
            height: 320px;
            background-image: url('{{ pet.cover_url }}');
            background-size: cover;
            background-position: center;
            position: relative;
            /* å…³é”®ï¼šåº•éƒ¨åšä¸€ä¸ªåœ†å¼§ */
            border-radius: 0 0 40px 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        .pet-header::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 0.6) 100%);
        }

        .header-content {
            position: absolute;
            bottom: 40px;
            left: 25px;
            right: 25px;
            z-index: 2;
            color: white;
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
        }

        .pet-name {
            font-size: 36px;
            font-weight: 900;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pet-tags span {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(5px);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            margin-right: 5px;
        }

        .edit-fab {
            background: white;
            color: #333;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
            border: none;
        }

        .edit-fab:active {
            transform: scale(0.9);
        }

        .back-btn {
            position: absolute;
            top: max(20px, env(safe-area-inset-top));
            left: 20px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-decoration: none;
        }

        /* === 2. æ‚¬æµ®æ•°æ®å¡ç‰‡ (å¤šå½©ç‰ˆ) === */
        .status-container {
            margin-top: 15px; /* å‘ä¸Šæ’å…¥å¤´éƒ¨ */
            padding: 0 20px;
            position: relative;
            z-index: 5;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }

        .status-card {
            background: white;
            border-radius: 18px;
            padding: 15px 10px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .sc-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .sc-label {
            font-size: 11px;
            color: #888;
            margin-bottom: 2px;
        }

        .sc-val {
            font-size: 15px;
            font-weight: 800;
            color: #333;
        }

        /* ä¸åŒç±»å‹çš„å¡ç‰‡é…è‰² */
        .sc-weight {
            border-bottom: 4px solid #74b9ff;
        }

        .sc-vac {
            border-bottom: 4px solid #ff7675;
        }

        .sc-deworm {
            border-bottom: 4px solid #55efc4;
        }

        /* === 3. æ‹ç«‹å¾—ç›¸å†Œå¢™ === */
        .gallery-section {
            padding: 25px 20px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 800;
            color: #2d3436;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .section-title i {
            color: #fdcb6e;
            margin-right: 8px;
        }

        .polaroid-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .polaroid {
            background: white;
            padding: 8px 8px 25px 8px; /* åº•éƒ¨ç•™ç™½å†™å­— */
            border-radius: 4px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transform: rotate(var(--rot));
            transition: transform 0.2s, z-index 0s;
            position: relative;
        }

        .polaroid:active {
            transform: scale(1.05) rotate(0deg);
            z-index: 10;
        }

        .polaroid img {
            width: 100%;
            aspect-ratio: 1/1;
            object-fit: cover;
            border: 1px solid #eee;
        }

        .polaroid-date {
            position: absolute;
            bottom: 5px;
            right: 10px;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            color: #888;
        }

        /* è£…é¥°å…ƒç´  */
        .tape {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 12px;
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* === å›¾ç‰‡æŸ¥çœ‹å™¨å¼¹çª— === */
        #photo-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        #viewer-img {
            max-width: 95%;
            max-height: 70vh;
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s;
        }

        .viewer-info {
            color: white;
            margin-top: 20px;
            text-align: center;
        }

        /* åˆ é™¤æŒ‰é’® (å¹³æ—¶éšè—) */
        #delete-photo-btn {
            margin-top: 20px;
            background: rgba(220, 53, 69, 0.2);
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
            padding: 8px 25px;
            border-radius: 50px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: none; /* é»˜è®¤éšè— */
        }

        #delete-photo-btn:active {
            background: #ff6b6b;
            color: white;
        }

        .viewer-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
            opacity: 0.7;
        }
    </style>
</head>
<body>

<!-- 1. æ²‰æµ¸å¼å¤´éƒ¨ -->
<a href="/" class="back-btn"><i class="fas fa-arrow-left"></i></a>
<div class="pet-header">
    <div class="header-content">
        <div>
            <div class="pet-name">
                {{ pet.name }}
                {% if pet.gender == 'male' %}
                    <i class="fas fa-mars text-info fs-5"></i>
                {% elif pet.gender == 'female' %}
                    <i class="fas fa-venus text-danger fs-5"></i>
                {% endif %}
            </div>
            <div class="pet-tags mt-2">
                <span>ğŸ‚ {{ pet.age_display }}</span>
                <span>
                        {% if pet.type=='dog' %}ğŸ¶ æ±ªæ˜Ÿäºº{% else %}ğŸ± å–µæ˜Ÿäºº{% endif %}
                    </span>
            </div>
        </div>

        {% if pet.is_owner %}
            <button class="edit-fab" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                <i class="fas fa-pencil-alt"></i>
            </button>
        {% endif %}
    </div>
</div>

<!-- 2. æ•°æ®ä»ªè¡¨ç›˜ (å¤šå½©å¡ç‰‡) -->
<div class="status-container">
    <div class="status-card sc-weight">
        <div class="sc-icon">âš–ï¸</div>
        <div class="sc-label">å½“å‰ä½“é‡</div>
        <div class="sc-val">{{ pet.weight or '--' }} <small>kg</small></div>
    </div>
    <div class="status-card sc-vac">
        <div class="sc-icon">ğŸ’‰</div>
        <div class="sc-label">ä¸Šæ¬¡ç–«è‹—</div>
        <div class="sc-val">{{ pet.vaccine_date or 'æœªè®°å½•' }}</div>
    </div>
    <div class="status-card sc-deworm">
        <div class="sc-icon">ğŸ’Š</div>
        <div class="sc-label">ä¸Šæ¬¡é©±è™«</div>
        <div class="sc-val">{{ pet.deworm_date or 'æœªè®°å½•' }}</div>
    </div>
</div>

<!-- 3. æ—¶å…‰ç›¸å†Œ (æ‹ç«‹å¾—é£æ ¼) -->
<div class="gallery-section">
    <div class="section-title">
        <i class="fas fa-images"></i> æˆé•¿æ—¶å…‰æœº <small class="text-muted ms-2 fw-normal fs-6">({{ pet.photos|length }}å¼ )</small>
    </div>

    <div class="polaroid-grid">
        {% for p in pet.photos %}
            <!-- éšæœºæ—‹è½¬è§’åº¦: -3deg åˆ° 3deg -->
            <div class="polaroid" style="--rot: {{ range(-3, 3)|random }}deg"
                 onclick="openPhotoViewer('{{ p.url }}', '{{ p.user_id }}', '{{ p.id }}', '{{ p.display_date }}')">
                <!-- é¡¶éƒ¨èƒ¶å¸¦è£…é¥° -->
                <div class="tape"></div>
                <img src="{{ p.url }}" loading="lazy">
                <!-- [ä¿®æ”¹] ä½¿ç”¨åç«¯ç®—å¥½çš„åŒ—äº¬æ—¥æœŸ -->
                <div class="polaroid-date">{{ p.display_date }}</div>
            </div>
        {% else %}
            <!-- [ä¿®æ”¹] ç©ºçŠ¶æ€ï¼šå¼ºåˆ¶è·¨è¶Šæ‰€æœ‰ç½‘æ ¼åˆ— (grid-column: 1/-1) å¹¶å±…ä¸­ -->
            <div class="text-center text-muted py-5 d-flex flex-column align-items-center justify-content-center"
                 style="grid-column: 1 / -1; min-height: 200px;">

                <img src="https://cdn-icons-png.flaticon.com/512/7486/7486747.png" width="80" style="opacity: 0.5;">
                <p class="mt-3 small">ç›¸å†Œç©ºç©ºå¦‚ä¹Ÿ<br>å¿«å»é¦–é¡µç»™å®ƒæ‹å¼ ç…§å§ï¼</p>

            </div>
        {% endfor %}
    </div>
</div>

<!-- ç¼–è¾‘æ¡£æ¡ˆå¼¹çª— (ä¿æŒé€»è¾‘ä¸å˜ï¼Œåªç¾åŒ–æŒ‰é’®) -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">ğŸ“ å®Œå–„å°æ¡£æ¡ˆ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form action="/update_pet_detail" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="pet_id" value="{{ pet.id }}">

                    <div class="mb-3">
                        <label class="form-label small text-muted">ä»–æ˜¯å¼Ÿå¼Ÿè¿˜æ˜¯å¦¹å¦¹ï¼Ÿ</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="gender" id="g_male" value="male"
                                   {% if pet.gender=='male' %}checked{% endif %}>
                            <label class="btn btn-outline-primary py-2" for="g_male">ğŸ’™ å¼Ÿå¼Ÿ</label>
                            <input type="radio" class="btn-check" name="gender" id="g_female" value="female"
                                   {% if pet.gender=='female' %}checked{% endif %}>
                            <label class="btn btn-outline-danger py-2" for="g_female">ğŸ’– å¦¹å¦¹</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small text-muted">ç”Ÿæ—¥ (ç”¨äºç®—å¹´é¾„)</label>
                        <input type="date" name="birthday" class="form-control form-control-lg"
                               value="{{ pet.birthday }}">
                    </div>

                    <div class="mb-3">
                        <label class="form-label small text-muted">ä½“é‡ (kg)</label>
                        <input type="number" step="0.1" name="weight" class="form-control form-control-lg"
                               value="{{ pet.weight }}" placeholder="0.0">
                    </div>

                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label small text-muted">ğŸ’‰ ä¸Šæ¬¡ç–«è‹—</label>
                            <input type="date" name="vaccine_date" class="form-control" value="{{ pet.vaccine_date }}">
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label small text-muted">ğŸ’Š ä¸Šæ¬¡é©±è™«</label>
                            <input type="date" name="deworm_date" class="form-control" value="{{ pet.deworm_date }}">
                        </div>
                    </div>

                    <button class="btn btn-dark w-100 fw-bold rounded-3 py-3 mt-2">ä¿å­˜æ¡£æ¡ˆ</button>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- å…¨å±çœ‹å›¾å¼¹çª— -->
<div id="photo-viewer" onclick="closePhotoViewer()">
    <div class="viewer-close">Ã—</div>

    <img id="viewer-img" src="" onclick="event.stopPropagation()"> <!-- ç‚¹å‡»å›¾ç‰‡ä¸å…³é—­ -->

    <div class="viewer-info" onclick="event.stopPropagation()">
        <div id="viewer-date" class="small opacity-75"></div>
    </div>

    <!-- åˆ é™¤è¡¨å• -->
    <form action="/delete_pet_photo" method="POST" id="delete-photo-form" onclick="event.stopPropagation()">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="pet_id" value="{{ pet.id }}">
        <input type="hidden" name="log_id" id="delete-log-id">

        <button type="button" id="delete-photo-btn" onclick="confirmDelete()">
            <i class="fas fa-trash-alt me-1"></i> åˆ é™¤è¿™å¼ ç…§ç‰‡
        </button>
    </form>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // === å›¾ç‰‡æŸ¥çœ‹ä¸åˆ é™¤é€»è¾‘ ===
    const currentUserId = '{{ current_user_id }}'; // è·å–å½“å‰ç”¨æˆ·ID

    function openPhotoViewer(url, uploaderId, logId, dateStr) {
        document.getElementById('photo-viewer').style.display = 'flex';
        document.getElementById('viewer-img').src = url;
        document.getElementById('viewer-date').innerText = dateStr;

        // è®¾ç½®åˆ é™¤æ‰€éœ€çš„ ID
        document.getElementById('delete-log-id').value = logId;

        // [æ ¸å¿ƒæƒé™åˆ¤æ–­] å¦‚æœä¸Šä¼ è€…æ˜¯æˆ‘ï¼Œæ˜¾ç¤ºåˆ é™¤æŒ‰é’®
        const delBtn = document.getElementById('delete-photo-btn');
        if (uploaderId === currentUserId) {
            delBtn.style.display = 'inline-block';
        } else {
            delBtn.style.display = 'none';
        }
    }

    function closePhotoViewer() {
        document.getElementById('photo-viewer').style.display = 'none';
    }

    function confirmDelete() {
        if (confirm('âš ï¸ ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿ')) {
            document.getElementById('delete-photo-form').submit();
        }
    }
</script>
</body>
</html>