<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>ğŸ„ æˆ‘ä»¬çš„è®°å¿†åœ£è¯æ ‘</title>
    <!-- å¼•å…¥ä¸­æ–‡å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0; overflow: hidden;
            background-color: #050505; /* çº¯é»‘èƒŒæ™¯ */
            font-family: sans-serif;
            touch-action: none;
        }

        #exit-btn {
            position: absolute; top: 20px; right: 20px;
            width: 44px; height: 44px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(8px);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; text-decoration: none; font-size: 24px;
            z-index: 100; border: 1px solid rgba(255,255,255,0.3);
        }

        #title-overlay {
            position: absolute; top: 8%; width: 100%;
            text-align: center; pointer-events: none; z-index: 50;
        }
        .main-title {
            font-family: 'Ma Shan Zheng', cursive; /* ä¹¦æ³•ä½“ */
            color: #d63031; /* åœ£è¯çº¢ */
            font-size: 50px; margin: 0;
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
            letter-spacing: 5px;
        }
        .sub-title {
            color: #b2bec3; font-size: 12px; letter-spacing: 4px;
            margin-top: 5px; opacity: 0.8;
        }

        #loading {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 999;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            color: #d4af37; transition: opacity 0.5s;
        }

        /* ç…§ç‰‡å¼¹çª— */
        #photo-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none; align-items: center; justify-content: center; flex-direction: column;
            z-index: 200; backdrop-filter: blur(10px);
        }
        .polaroid-card {
            background: #fff; padding: 10px 10px 40px 10px;
            border-radius: 4px;
            transform: scale(0.8); transition: transform 0.3s;
            max-width: 90%;
        }
        .polaroid-card.show { transform: scale(1); }
        #modal-img { max-width: 100%; max-height: 50vh; background: #eee; display: block; }
        #modal-text { color: #222; margin-top: 15px; font-weight: bold; text-align: center; }

        #instruction {
            position: absolute; bottom: 40px; width: 100%;
            text-align: center; color: rgba(255,255,255,0.3);
            font-size: 12px; letter-spacing: 1px;
            pointer-events: none;
        }

        /* ç¤¼ç‰©å¼¹çª— */
        .gift-alert {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #fff 0%, #f0f0f0 100%);
            padding: 25px; border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); text-align: center;
            z-index: 300; display: none; min-width: 280px;
            border: 2px solid #ffd700;
        }
    </style>
</head>
<body>
    <a href="/" id="exit-btn">Ã—</a>

    <div id="loading">
        <div style="font-size: 40px; margin-bottom: 15px;">ğŸ„</div>
        <div style="color: #bbb; font-size: 14px;">æ­£åœ¨å¸ƒç½®åœ£è¯æ ‘...</div>
    </div>

    <div id="title-overlay">
        <h1 class="main-title">åœ£è¯å¿«ä¹</h1>
        <div class="sub-title">å±äºæˆ‘ä»¬çš„ç‹¬å®¶è®°å¿†</div>
    </div>

    <div id="instruction">ä¸‹æ»‘ç‚¸å¼€ / æåˆ / æ‘‡ä¸€æ‘‡</div>

    <!-- ç…§ç‰‡å¼¹çª— -->
    <div id="photo-modal" onclick="closeModal()">
        <div class="polaroid-card" id="polaroid-card" onclick="event.stopPropagation()">
            <img id="modal-img" src="">
            <div id="modal-text"></div>
        </div>
    </div>

    <!-- ç¤¼ç‰©å¼¹çª— -->
    <div class="gift-alert" id="gift-alert">
        <div style="font-size: 50px; margin-bottom: 15px;">ğŸ</div>
        <div style="color:#999; font-size:12px; margin-bottom:5px;">å®¶äººçš„æ„¿æœ›</div>
        <div id="gift-content" style="font-weight: bold; font-size:18px; color:#333; margin-bottom: 20px;"></div>
        <button onclick="document.getElementById('gift-alert').style.display='none'"
                style="border:none; background:#d63031; color:white; padding:10px 30px; border-radius:25px; font-weight:bold; font-size:14px;">æ”¶åˆ°</button>
    </div>

    <div id="scene-container"></div>

    <!-- ä¾èµ– -->
    <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <!-- åæœŸå¤„ç† -->
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

    <script>
        let scene, camera, renderer, composer, controls;
        let mainGroup = new THREE.Group(); // æ•´ä¸ªæ ‘ç»„
        let photosGroup = new THREE.Group();
        let giftsGroup = new THREE.Group();
        let leavesMesh, lightsMesh;

        // åŠ¨ç”»å˜é‡
        let explosionProgress = 0;
        let targetProgress = 0;
        const leavesData = [];
        const lightsData = [];
        const photosData = [];
        const dummy = new THREE.Object3D();

        fetch('/api/christmas_data')
            .then(res => res.json())
            .then(data => {
                init(data);
                animate();
            })
            .catch(err => {
                console.error(err);
                document.getElementById('loading').innerHTML = "åŠ è½½å¤±è´¥";
            });

        function init(data) {
            const container = document.getElementById('scene-container');
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.02);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 38); // [ä¿®å¤] ç›¸æœºæ‹‰è¿œç‚¹ï¼Œä½ä¸€ç‚¹

            renderer = new THREE.WebGLRenderer({ antialias: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            // [ä¿®å¤] é™ä½æ›å…‰åº¦ï¼Œé˜²æ­¢äº®ççœ¼
            renderer.toneMapping = THREE.ReinhardToneMapping;
            renderer.toneMappingExposure = 1.2;
            container.appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableZoom = false;
            controls.enablePan = false;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 0.6;
            controls.enableDamping = true;

            // [ä¿®å¤] ç¯å…‰è°ƒæ•´
            const ambient = new THREE.AmbientLight(0xffffff, 0.4); // è°ƒä½ç¯å¢ƒå…‰
            scene.add(ambient);
            const pointLight = new THREE.PointLight(0xffaa00, 1, 50); // å†…éƒ¨æš–å…‰
            pointLight.position.set(0, 10, 0);
            scene.add(pointLight);

            // [ä¿®å¤] æŠŠæ•´æ£µæ ‘å¾€ä¸‹ç§»ï¼Œè®©å®ƒå±…ä¸­
            mainGroup.position.y = -10;

            // === 1. æ„å»ºæ ‘ ===
            createSolidTree();

            // === 2. æŒ‚ç…§ç‰‡ ===
            if (data.photos) {
                const pList = data.photos.slice(0, 20);
                pList.forEach((p, i) => createFloatingPhoto(p, i, pList.length));
                mainGroup.add(photosGroup);
            }

            // === 3. å †ç¤¼ç‰© ===
            if (data.wishes) {
                createGifts(data.wishes);
                mainGroup.add(giftsGroup);
            }

            scene.add(mainGroup);

            // [ä¿®å¤] è¾‰å…‰å‚æ•°å¾®è°ƒ (å¼ºåº¦å‡å¼±ï¼Œé˜ˆå€¼æé«˜)
            const renderScene = new THREE.RenderPass(scene, camera);
            const bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloomPass.threshold = 0.2; // åªæœ‰æ¯”è¾ƒäº®çš„ä¸œè¥¿æ‰å‘å…‰
            bloomPass.strength = 0.6;  // å¼ºåº¦å¤§å¤§é™ä½
            bloomPass.radius = 0.5;

            composer = new THREE.EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloomPass);

            // äº¤äº’
            setupInteractions();
            if(window.DeviceMotionEvent) setupShake();

            setTimeout(() => {
                const l = document.getElementById('loading');
                l.style.opacity = 0;
                setTimeout(()=>l.style.display='none', 800);
            }, 1000);
        }

        function createSolidTree() {
            // A. æ ‘å¶ (ç»¿è‰²æ–¹å—ï¼Œä¸å‘å…‰ï¼Œåªåå…‰)
            const leafGeo = new THREE.BoxGeometry(0.5, 0.5, 0.5);
            const leafMat = new THREE.MeshStandardMaterial({
                color: 0x0f6d36, // ç»å…¸çš„åœ£è¯æ·±ç»¿
                roughness: 0.6,
                metalness: 0.1
            });
            const leavesCount = 2800;
            leavesMesh = new THREE.InstancedMesh(leafGeo, leafMat, leavesCount);

            // B. çº¢è‰²å½©çƒ (å‘å¾®å…‰)
            const lightGeo = new THREE.SphereGeometry(0.25, 16, 16);
            const lightMat = new THREE.MeshStandardMaterial({
                color: 0xff0000, // çº¯çº¢
                emissive: 0xaa0000, // æš—çº¢è‡ªå‘å…‰
                emissiveIntensity: 0.8, // äº®åº¦é€‚ä¸­
                roughness: 0.2,
                metalness: 0.5
            });
            const lightsCount = 400;
            lightsMesh = new THREE.InstancedMesh(lightGeo, lightMat, lightsCount);

            // èºæ—‹æ’åˆ—
            for(let i=0; i<leavesCount; i++) {
                const y = Math.random() * 22;
                const maxR = 9 * (1 - y/24);
                const angle = y * 6 + Math.random() * Math.PI * 2;
                const r = maxR + (Math.random()-0.5) * 1.5;

                const x = r * Math.cos(angle);
                const z = r * Math.sin(angle);

                dummy.position.set(x, y, z);
                dummy.rotation.set(Math.random(), Math.random(), Math.random());
                dummy.scale.setScalar(Math.random() * 0.8 + 0.5);
                dummy.updateMatrix();
                leavesMesh.setMatrixAt(i, dummy.matrix);

                leavesData.push({
                    homePos: new THREE.Vector3(x,y,z),
                    chaosPos: new THREE.Vector3((Math.random()-0.5)*80, (Math.random()-0.5)*80+10, (Math.random()-0.5)*80),
                    rotSpeed: {x:Math.random()*0.02, y:Math.random()*0.02}
                });
            }

            // å½©çƒæ’åˆ—
            for(let i=0; i<lightsCount; i++) {
                const y = Math.random() * 22;
                const maxR = 9 * (1 - y/24);
                const r = maxR + 0.3; // æŒ‚å¤–é¢
                const angle = Math.random() * Math.PI * 2;

                dummy.position.set(r*Math.cos(angle), y, r*Math.sin(angle));
                dummy.scale.setScalar(1);
                dummy.updateMatrix();
                lightsMesh.setMatrixAt(i, dummy.matrix);

                lightsData.push({
                    homePos: dummy.position.clone(),
                    chaosPos: new THREE.Vector3((Math.random()-0.5)*80, (Math.random()-0.5)*80+10, (Math.random()-0.5)*80)
                });
            }

            mainGroup.add(leavesMesh);
            mainGroup.add(lightsMesh);

            // æ ‘é¡¶æ˜Ÿæ˜Ÿ
            const starGeo = new THREE.IcosahedronGeometry(0.8, 0);
            const starMat = new THREE.MeshBasicMaterial({ color: 0xffff00 });
            const star = new THREE.Mesh(starGeo, starMat);
            star.position.set(0, 23, 0);
            mainGroup.add(star);
        }

        // === 2. æ‹ç«‹å¾—ç…§ç‰‡ (ä¿®å¤æœå‘) ===
        function createFloatingPhoto(data, index, total) {
            const loader = new THREE.TextureLoader();
            loader.setCrossOrigin('anonymous');

            const group = new THREE.Group();

            // ç›¸çº¸
            const paperGeo = new THREE.BoxGeometry(2.4, 2.8, 0.05);
            const paperMat = new THREE.MeshBasicMaterial({ color: 0xffffff });
            const paper = new THREE.Mesh(paperGeo, paperMat);
            group.add(paper);

            const y = 2 + (index/total) * 18;
            const r = 10 * (1 - y/25) + 1.2;
            const angle = index * 1.5;

            const treePos = new THREE.Vector3(r*Math.cos(angle), y, r*Math.sin(angle));
            const chaosPos = new THREE.Vector3((Math.random()-0.5)*70, (Math.random()-0.5)*70, (Math.random()-0.5)*70);

            group.position.copy(treePos);
            // [æ ¸å¿ƒä¿®å¤] å…ˆçœ‹å‘ä¸­å¿ƒ
            group.lookAt(0, y, 0);
            // [æ ¸å¿ƒä¿®å¤] å†è½¬180åº¦ï¼ŒèƒŒå¯¹ä¸­å¿ƒï¼Œé¢å‘è§‚ä¼—
            group.rotateY(Math.PI);
            // éšæœºæ­ªä¸€ç‚¹
            group.rotateZ((Math.random()-0.5)*0.3);

            group.userData = { isPhoto: true, info: data };

            photosData.push({
                mesh: group,
                homePos: treePos,
                chaosPos: chaosPos,
            });

            loader.load(data.url, (tex) => {
                tex.center.set(0.5, 0.5);
                const imgGeo = new THREE.PlaneGeometry(2, 2);
                const imgMat = new THREE.MeshBasicMaterial({ map: tex });
                const img = new THREE.Mesh(imgGeo, imgMat);
                // è¿™é‡Œçš„ z æ˜¯å±€éƒ¨åæ ‡ï¼Œ0.03 ä¿è¯åœ¨çº¸å‰é¢
                img.position.set(0, 0.2, 0.03);
                // å›¾ç‰‡ä¹Ÿè¦è½¬è¿‡æ¥å—ï¼Ÿä¸ç”¨ï¼Œå› ä¸ºçˆ¶çº§groupå·²ç»è½¬äº†
                group.add(img);
            });

            photosGroup.add(group);
        }

        // === 3. ç¤¼ç‰©ç›’ (ç¡®ä¿åœ¨æ ‘ä¸‹) ===
        function createGifts(wishes) {
            const boxGeo = new THREE.BoxGeometry(1.2, 1.2, 1.2);

            wishes.forEach((w, i) => {
                const group = new THREE.Group();
                const color = new THREE.Color(w.color);

                const boxMat = new THREE.MeshStandardMaterial({ color: color, roughness: 0.3 });
                const box = new THREE.Mesh(boxGeo, boxMat);
                group.add(box);

                // ç®€å•çš„ä¸å¸¦
                const ribbonMat = new THREE.MeshStandardMaterial({ color: 0xffffff });
                const r1 = new THREE.Mesh(new THREE.BoxGeometry(1.25, 1.25, 0.2), ribbonMat);
                const r2 = new THREE.Mesh(new THREE.BoxGeometry(0.2, 1.25, 1.25), ribbonMat);
                group.add(r1); group.add(r2);

                // ä½ç½®ï¼šåœ¨æ ‘åº•ä¸‹ä¸€åœˆ
                const angle = (i / wishes.length) * Math.PI * 2 + Math.random();
                const r = 5 + Math.random() * 3;
                // y=0 æ˜¯æ ‘æ ¹ï¼Œç¤¼ç‰©æ”¾åœ°ä¸Š y=0.6 (ç›’å­ä¸€åŠé«˜åº¦)
                const treePos = new THREE.Vector3(r*Math.cos(angle), 0.6, r*Math.sin(angle));

                group.position.copy(treePos);
                group.rotation.y = Math.random();

                group.userData = { isGift: true, text: w.content };

                // ç¤¼ç‰©ä¹Ÿå‚ä¸çˆ†ç‚¸
                photosData.push({
                    mesh: group,
                    homePos: treePos,
                    chaosPos: new THREE.Vector3((Math.random()-0.5)*50, -10, (Math.random()-0.5)*50)
                });

                giftsGroup.add(group);
            });
        }

        // === äº¤äº’ ===
        function setupInteractions() {
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();
            let isDrag = false; let downTime = 0;

            window.addEventListener('mousedown', ()=>{isDrag=false; downTime=Date.now()});
            window.addEventListener('mousemove', ()=>{isDrag=true});
            window.addEventListener('touchstart', ()=>{isDrag=false; downTime=Date.now()});
            window.addEventListener('touchmove', ()=>{isDrag=true});

            const onClick = (x, y) => {
                if(isDrag || Date.now()-downTime > 300) return;

                mouse.x = (x / window.innerWidth) * 2 - 1;
                mouse.y = -(y / window.innerHeight) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);

                const hits = raycaster.intersectObjects([...photosGroup.children, ...giftsGroup.children], true);

                if (hits.length > 0) {
                    let target = hits[0].object;
                    while(target.parent !== photosGroup && target.parent !== giftsGroup) {
                        if(!target.parent) break;
                        target = target.parent;
                    }

                    if (target.userData.isPhoto) {
                        showModal(target.userData.info);
                        controls.autoRotate = false;
                    } else if (target.userData.isGift) {
                        document.getElementById('gift-content').innerText = target.userData.text;
                        document.getElementById('gift-alert').style.display = 'block';
                    }
                } else {
                    controls.autoRotate = true;
                }
            };

            window.addEventListener('mouseup', e => onClick(e.clientX, e.clientY));
            window.addEventListener('touchend', e => {
                if(e.changedTouches.length>0) onClick(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
            });

            // ç‚¸å¼€é€»è¾‘
            const handleProgress = (delta) => {
                targetProgress += delta;
                targetProgress = Math.max(0, Math.min(1, targetProgress));
            };
            window.addEventListener('wheel', e => {
                e.preventDefault();
                handleProgress(e.deltaY * 0.001);
            }, {passive:false});

            let startDist = 0;
            window.addEventListener('touchstart', e => {
                if(e.touches.length===2) startDist = Math.hypot(e.touches[0].pageX-e.touches[1].pageX, e.touches[0].pageY-e.touches[1].pageY);
            }, {passive:false});

            window.addEventListener('touchmove', e => {
                if(e.touches.length===2) {
                    e.preventDefault();
                    const dist = Math.hypot(e.touches[0].pageX-e.touches[1].pageX, e.touches[0].pageY-e.touches[1].pageY);
                    handleProgress((dist - startDist) * 0.005);
                    startDist = dist;
                }
            }, {passive:false});
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth/window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                composer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        function setupShake() {
             let lastX=0, lastY=0, lastZ=0;
             window.addEventListener('devicemotion', e => {
                 const acc = e.accelerationIncludingGravity;
                 if(!acc) return;
                 const d = Math.abs(acc.x+acc.y+acc.z - lastX-lastY-lastZ);
                 if(d > 25) { targetProgress = 1; setTimeout(()=>targetProgress=0, 3000); }
                 lastX=acc.x; lastY=acc.y; lastZ=acc.z;
             });
        }

        function showModal(info) {
            document.getElementById('modal-img').src = info.url;
            document.getElementById('modal-text').innerText = info.text || "ç¾å¥½å›å¿†";
            document.getElementById('photo-modal').style.display = 'flex';
            setTimeout(()=>document.querySelector('.polaroid-card').classList.add('show'), 10);
        }
        window.closeModal = () => {
            document.querySelector('.polaroid-card').classList.remove('show');
            setTimeout(()=>document.getElementById('photo-modal').style.display='none', 300);
            controls.autoRotate = true;
        }

        function animate(time) {
            requestAnimationFrame(animate);
            TWEEN.update(time);
            controls.update();

            explosionProgress += (targetProgress - explosionProgress) * 0.05;

            const isExploding = explosionProgress > 0.01;

            if(isExploding) {
                // ç²’å­åŠ¨ç”»
                const pos = particles.geometry.attributes.position.array;
                for(let i=0; i<leavesData.length; i++) {
                    const d = leavesData[i];
                    pos[i*3] = d.homePos.x + (d.chaosPos.x - d.homePos.x) * explosionProgress;
                    pos[i*3+1] = d.homePos.y + (d.chaosPos.y - d.homePos.y) * explosionProgress;
                    pos[i*3+2] = d.homePos.z + (d.chaosPos.z - d.homePos.z) * explosionProgress;
                }
                particles.geometry.attributes.position.needsUpdate = true;

                // ç¯çƒåŠ¨ç”»
                for(let i=0; i<lightsData.length; i++) {
                    const d = lightsData[i];
                    dummy.position.lerpVectors(d.homePos, d.chaosPos, explosionProgress);
                    dummy.scale.setScalar(1);
                    dummy.updateMatrix();
                    lightsMesh.setMatrixAt(i, dummy.matrix);
                }
                lightsMesh.instanceMatrix.needsUpdate = true;
            }

            // ç…§ç‰‡/ç¤¼ç‰©åŠ¨ç”»
            photosData.forEach(p => {
                p.mesh.position.lerpVectors(p.homePos, p.chaosPos, explosionProgress);
                if(explosionProgress > 0.1) {
                    p.mesh.rotation.x += 0.01; p.mesh.rotation.y += 0.01;
                } else {
                    // [æ ¸å¿ƒä¿®å¤] å½’ä½æ—¶ï¼Œå¿…é¡»èƒŒå¯¹ä¸­å¿ƒï¼Œé¢å‘ç›¸æœº
                    p.mesh.lookAt(0, p.mesh.position.y, 0);
                    p.mesh.rotateY(Math.PI);
                }
            });

            composer.render();
        }
    </script>
</body>
</html>