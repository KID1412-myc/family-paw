<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>ğŸ„ æˆ‘ä»¬çš„è®°å¿†åœ£è¯æ ‘</title>
    <style>
        body {
            margin: 0; overflow: hidden;
            background: radial-gradient(circle at center, #500000 0%, #1a0000 100%); /* æ·±çº¢ä¸ç»’èƒŒæ™¯ */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            touch-action: none; /* [å…³é”®] ç¦æ­¢æµè§ˆå™¨é»˜è®¤æ‰‹åŠ¿ */
        }

        /* é€€å‡ºæŒ‰é’® */
        #exit-btn {
            position: absolute; top: 20px; right: 20px;
            width: 44px; height: 44px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(8px);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; text-decoration: none; font-size: 24px;
            z-index: 100; border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        /* åº•éƒ¨æç¤º */
        #instruction {
            position: absolute; bottom: 40px; width: 100%;
            text-align: center; color: #ffbf00;
            font-size: 13px; letter-spacing: 1px;
            pointer-events: none; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            animation: float 3s infinite ease-in-out;
            z-index: 50;
        }

        /* æƒé™å¼•å¯¼å±‚ (iOSä¸“ç”¨) */
        #ios-permission {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 9999;
            display: none; align-items: center; justify-content: center; flex-direction: column;
            color: white; text-align: center;
        }

        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }

        #loading {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #2b0a0a; z-index: 999;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            color: #ffd700; transition: opacity 0.5s;
        }

        /* å¼¹çª—æ ·å¼ */
        #photo-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: none; align-items: center; justify-content: center; flex-direction: column;
            z-index: 200; backdrop-filter: blur(10px);
        }
        .polaroid-card {
            background: #fff; padding: 12px 12px 40px 12px;
            border-radius: 6px; box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            transform: rotate(-2deg) scale(0.9);
            max-width: 85%; max-height: 80%;
            text-align: center; transition: transform 0.3s;
        }
        .polaroid-card.show { transform: rotate(0deg) scale(1); }

        #modal-img {
            max-width: 100%; max-height: 50vh;
            background: #eee; object-fit: contain;
            border: 1px solid #ddd;
        }
        #modal-text { color: #222; margin-top: 15px; font-weight: bold; font-size: 16px; font-family: cursive, sans-serif; }
        #modal-date { color: #888; font-size: 12px; margin-top: 5px; font-family: monospace; }

        /* ç¤¼ç‰© Alert ç¾åŒ– */
        .gift-alert {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 20px; border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center;
            z-index: 300; display: none; min-width: 260px;
        }
    </style>
</head>
<body>
    <a href="/" id="exit-btn">Ã—</a>

    <div id="loading">
        <div style="font-size: 50px;">ğŸ„</div>
        <div style="margin-top:15px; font-size: 14px;">å‡†å¤‡æƒŠå–œä¸­...</div>
    </div>

    <div id="ios-permission" onclick="requestMotion()">
        <div style="font-size: 40px; margin-bottom: 20px;">ğŸ“±</div>
        <p>ç‚¹æˆ‘ä¸€ä¸‹<br>å¼€å¯â€œæ‘‡ä¸€æ‘‡â€ç‰¹æ•ˆ</p>
    </div>

    <div id="instruction">âœ¨ åŒæŒ‡æåˆ / æ‘‡ä¸€æ‘‡ / ç‚¹å‡»æŒ‚ä»¶ âœ¨</div>

    <!-- ç…§ç‰‡å¼¹çª— -->
    <div id="photo-modal" onclick="closeModal()">
        <div class="polaroid-card" id="polaroid-card" onclick="event.stopPropagation()">
            <img id="modal-img" src="">
            <div id="modal-text"></div>
            <div id="modal-date"></div>
        </div>
    </div>

    <!-- ç¤¼ç‰©å¼¹çª— -->
    <div class="gift-alert" id="gift-alert">
        <div style="font-size: 40px; margin-bottom: 10px;">ğŸ</div>
        <div id="gift-content" style="font-weight: bold; margin-bottom: 15px;"></div>
        <button onclick="document.getElementById('gift-alert').style.display='none'"
                style="border:none; background:#ff4757; color:white; padding:8px 20px; border-radius:20px; font-weight:bold;">å¼€å¿ƒ</button>
    </div>

    <div id="scene-container"></div>

    <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

    <script>
        let scene, camera, renderer, controls;
        let photosGroup = new THREE.Group();
        let giftsGroup = new THREE.Group();
        let treeGroup = new THREE.Group();
        let particles;

        let explosionProgress = 0;
        let targetProgress = 0;

        const photosData = [];
        const particlesData = [];

        // ç‚¹å‡»åˆ¤æ–­å˜é‡
        let isDragging = false;
        let mouseDownTime = 0;
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        // 1. è·å–æ•°æ®
        fetch('/api/christmas_data')
            .then(res => res.json())
            .then(data => {
                init(data);
                animate();
            })
            .catch(err => {
                console.error(err);
                document.getElementById('loading').innerHTML = "åŠ è½½å¤±è´¥<br><small>è¯·åˆ·æ–°é‡è¯•</small>";
            });

        function init(data) {
            const container = document.getElementById('scene-container');
            scene = new THREE.Scene();

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 14, 32);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.outputEncoding = THREE.sRGBEncoding;
            container.appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableZoom = false;
            controls.enablePan = false;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 0.8;
            controls.enableDamping = true;

            const ambient = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambient);
            const dirLight = new THREE.DirectionalLight(0xffeeb1, 1.2);
            dirLight.position.set(10, 20, 10);
            scene.add(dirLight);
            const pointLight = new THREE.PointLight(0xff0000, 0.5, 20);
            pointLight.position.set(-10, 5, 10);
            scene.add(pointLight);

            createGlowingTree();

            if (data.photos) {
                data.photos.forEach((p, i) => createPolaroid(p, i, data.photos.length));
                treeGroup.add(photosGroup);
            }

            if (data.wishes) {
                createFancyGifts(data.wishes);
                treeGroup.add(giftsGroup);
            }

            scene.add(treeGroup);

            // [ä¿®å¤] è¿™é‡Œè°ƒç”¨äº†ï¼Œä¸‹é¢å¿…é¡»å®šä¹‰
            setupInteractions();

            checkIOSPermission();

            setTimeout(() => {
                const l = document.getElementById('loading');
                l.style.opacity = 0;
                setTimeout(()=>l.style.display='none', 500);
            }, 800);
        }

        // === 1. å‘å…‰ç²’å­æ ‘ ===
        function createGlowingTree() {
            const count = 3500;
            const geometry = new THREE.BufferGeometry();
            const positions = [];
            const colors = [];

            const colorGreen = new THREE.Color(0x00b894);
            const colorGold = new THREE.Color(0xf1c40f);

            for(let i=0; i<count; i++) {
                const y = Math.random() * 22;
                const radius = 9 * (1 - y/24);
                const angle = y * 8 + Math.random() * Math.PI * 2;
                const r = radius + (Math.random()-0.5) * 1.0;

                const x = r * Math.cos(angle);
                const z = r * Math.sin(angle);

                positions.push(x, y, z);

                particlesData.push({
                    home: new THREE.Vector3(x, y, z),
                    chaos: new THREE.Vector3(
                        (Math.random()-0.5)*80,
                        (Math.random()-0.5)*80 + 10,
                        (Math.random()-0.5)*80
                    )
                });

                const isGold = Math.random() > 0.8;
                const c = isGold ? colorGold : colorGreen;
                colors.push(c.r, c.g, c.b);
            }

            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

            const material = new THREE.PointsMaterial({
                size: 0.5,
                vertexColors: true,
                map: getSprite(),
                transparent: true,
                alphaTest: 0.1,
                depthWrite: false,
                blending: THREE.AdditiveBlending
            });

            particles = new THREE.Points(geometry, material);
            treeGroup.add(particles);

            const starGeo = new THREE.IcosahedronGeometry(0.8, 0);
            const starMat = new THREE.MeshStandardMaterial({ color: 0xffff00, emissive: 0xffaa00, emissiveIntensity: 0.5 });
            const star = new THREE.Mesh(starGeo, starMat);
            star.position.set(0, 22.5, 0);

            new TWEEN.Tween(star.rotation)
                .to({ y: Math.PI * 2 }, 5000)
                .repeat(Infinity).start();

            treeGroup.add(star);
        }

        // === 2. æ‹ç«‹å¾—ç…§ç‰‡ ===
        function createPolaroid(data, index, total) {
            const loader = new THREE.TextureLoader();
            loader.setCrossOrigin('anonymous');

            const group = new THREE.Group();

            const paperGeo = new THREE.BoxGeometry(2.4, 2.8, 0.05);
            const paperMat = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.8 });
            const paper = new THREE.Mesh(paperGeo, paperMat);
            group.add(paper);

            const y = 1.5 + (index/total) * 18;
            const r = 9 * (1 - y/24) + 0.8;
            const angle = index * 1.8;

            const treePos = new THREE.Vector3(r*Math.cos(angle), y, r*Math.sin(angle));
            const chaosPos = new THREE.Vector3((Math.random()-0.5)*70, (Math.random()-0.5)*70, (Math.random()-0.5)*70);

            group.position.copy(treePos);
            group.lookAt(0, y, 0);
            group.rotateZ((Math.random()-0.5)*0.3);

            group.userData = {
                isPhoto: true,
                info: data,
                treePos: treePos,
                chaosPos: chaosPos
            };

            loader.load(data.url, (tex) => {
                tex.center.set(0.5, 0.5);
                const imgGeo = new THREE.PlaneGeometry(2, 2);
                const imgMat = new THREE.MeshBasicMaterial({ map: tex });
                const img = new THREE.Mesh(imgGeo, imgMat);
                img.position.set(0, 0.2, 0.04);
                group.add(img);
            });

            photosGroup.add(group);
        }

        // === 3. ç¤¼ç‰©ç›’ ===
        function createFancyGifts(wishes) {
            const boxGeo = new THREE.BoxGeometry(1, 1, 1);

            wishes.forEach(w => {
                const group = new THREE.Group();
                const color = new THREE.Color(w.color);

                const boxMat = new THREE.MeshStandardMaterial({ color: color, roughness: 0.2 });
                const box = new THREE.Mesh(boxGeo, boxMat);
                group.add(box);

                const ribbonMat = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.1 });
                const r1 = new THREE.Mesh(new THREE.BoxGeometry(1.05, 1.05, 0.2), ribbonMat);
                const r2 = new THREE.Mesh(new THREE.BoxGeometry(0.2, 1.05, 1.05), ribbonMat);
                group.add(r1);
                group.add(r2);

                const angle = Math.random() * 6.28;
                const r = 4 + Math.random() * 5;
                const treePos = new THREE.Vector3(r*Math.cos(angle), -0.5 + Math.random()*0.5, r*Math.sin(angle));

                group.position.copy(treePos);
                group.rotation.y = Math.random();
                const s = 1 + Math.random()*0.5;
                group.scale.set(s,s,s);

                group.userData = {
                    isGift: true,
                    text: w.content,
                    treePos: treePos,
                    chaosPos: new THREE.Vector3((Math.random()-0.5)*50, -10, (Math.random()-0.5)*50)
                };

                giftsGroup.add(group);
            });
        }

        // === [æ ¸å¿ƒä¿®å¤] äº¤äº’é€»è¾‘ ===
        function setupInteractions() {
            // A. é¼ æ ‡/è§¦æ‘¸ çŠ¶æ€ç›‘å¬
            window.addEventListener('mousedown', () => { isDragging = false; mouseDownTime = Date.now(); });
            window.addEventListener('mousemove', () => isDragging = true);
            window.addEventListener('touchstart', () => { isDragging = false; mouseDownTime = Date.now(); });
            window.addEventListener('touchmove', () => isDragging = true);

            // B. é¼ æ ‡/è§¦æ‘¸ ç»“æŸäº‹ä»¶ (ç‚¹å‡»æ£€æµ‹)
            window.addEventListener('mouseup', handleMouseUp);
            window.addEventListener('touchend', handleTouchEnd);

            // C. æ»šè½®äº‹ä»¶ (çˆ†ç‚¸)
            window.addEventListener('wheel', (e) => {
                e.preventDefault();
                targetProgress += e.deltaY * 0.001;
                targetProgress = Math.max(0, Math.min(1, targetProgress));
            }, { passive: false });

            // D. åŒæŒ‡äº‹ä»¶ (çˆ†ç‚¸)
            let initialDist = 0;
            window.addEventListener('touchstart', e => {
                if(e.touches.length===2) {
                    initialDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                }
            }, { passive: false });

            window.addEventListener('touchmove', e => {
                if(e.touches.length===2) {
                    e.preventDefault();
                    const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                    const delta = dist - initialDist;
                    if(delta > 0) targetProgress += 0.02;
                    else targetProgress -= 0.02;
                    targetProgress = Math.max(0, Math.min(1, targetProgress));
                    initialDist = dist;
                }
            }, { passive: false });

            // E. çª—å£å¤§å°è°ƒæ•´
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth/window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // å¤„ç†é¼ æ ‡ç‚¹å‡»
        function handleMouseUp(e) {
            if (isDragging || (Date.now() - mouseDownTime > 300)) return;
            checkIntersection(e.clientX, e.clientY);
        }

        // å¤„ç†è§¦æ‘¸ç‚¹å‡»
        function handleTouchEnd(e) {
            if (isDragging || (Date.now() - mouseDownTime > 300)) return;
            // touchend æ²¡æœ‰ clientXï¼Œå– changedTouches
            if(e.changedTouches.length > 0) {
                const t = e.changedTouches[0];
                checkIntersection(t.clientX, t.clientY);
            }
        }

        // å°„çº¿æ£€æµ‹
        function checkIntersection(x, y) {
            mouse.x = (x / window.innerWidth) * 2 - 1;
            mouse.y = -(y / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);

            // æ£€æµ‹ç…§ç‰‡å’Œç¤¼ç‰©
            const objects = [...photosGroup.children, ...giftsGroup.children];
            const hits = raycaster.intersectObjects(objects, true);

            if (hits.length > 0) {
                // é€’å½’æ‰¾çˆ¶çº§ï¼Œç›´åˆ°æ‰¾åˆ°æœ‰ userData çš„é‚£ä¸ª Mesh/Group
                let target = hits[0].object;
                while(target && !target.userData.isPhoto && !target.userData.isGift) {
                    target = target.parent;
                    if(target === scene) break;
                }

                if (target) {
                    if (target.userData.isPhoto) {
                        showModal(target.userData.info);
                        controls.autoRotate = false;
                    } else if (target.userData.isGift) {
                        document.getElementById('gift-content').innerText = target.userData.text;
                        document.getElementById('gift-alert').style.display = 'block';
                    }
                }
            } else {
                controls.autoRotate = true; // ç‚¹ç©ºç™½å¤„æ¢å¤æ—‹è½¬
            }
        }

        function checkIOSPermission() {
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                document.getElementById('ios-permission').style.display = 'flex';
            } else {
                setupShake();
            }
        }

        window.requestMotion = function() {
            DeviceMotionEvent.requestPermission()
                .then(res => {
                    if (res === 'granted') {
                        document.getElementById('ios-permission').style.display = 'none';
                        setupShake();
                    }
                });
        };

        function setupShake() {
            let lastX=0, lastY=0, lastZ=0;
            window.addEventListener('devicemotion', (e) => {
                const acc = e.accelerationIncludingGravity;
                if(!acc) return;
                const delta = Math.abs(acc.x+acc.y+acc.z - lastX-lastY-lastZ);
                if(delta > 25) triggerExplosion();
                lastX=acc.x; lastY=acc.y; lastZ=acc.z;
            });
        }

        function triggerExplosion() {
            targetProgress = 1;
            if(navigator.vibrate) navigator.vibrate([50,50,50]);
            setTimeout(() => targetProgress = 0, 3000);
        }

        function showModal(info) {
            document.getElementById('modal-img').src = info.url;
            document.getElementById('modal-text').innerText = info.text || "ç¾å¥½å›å¿†";
            document.getElementById('modal-date').innerText = info.date || "";
            document.getElementById('photo-modal').style.display = 'flex';
            setTimeout(() => document.getElementById('polaroid-card').classList.add('show'), 10);
        }

        window.closeModal = function() {
            document.getElementById('polaroid-card').classList.remove('show');
            setTimeout(() => document.getElementById('photo-modal').style.display = 'none', 300);
            controls.autoRotate = true;
        }

        function getSprite() {
            const c = document.createElement('canvas');
            c.width=32; c.height=32;
            const ctx = c.getContext('2d');
            const g = ctx.createRadialGradient(16,16,0, 16,16,16);
            g.addColorStop(0, 'rgba(255,255,255,1)');
            g.addColorStop(0.2, 'rgba(255,255,255,0.8)');
            g.addColorStop(0.5, 'rgba(255,255,255,0.2)');
            g.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle = g;
            ctx.fillRect(0,0,32,32);
            return new THREE.CanvasTexture(c);
        }

        function animate(time) {
            requestAnimationFrame(animate);
            TWEEN.update(time);
            controls.update();

            explosionProgress += (targetProgress - explosionProgress) * 0.05;

            const pos = particles.geometry.attributes.position.array;
            for(let i=0; i<particlesData.length; i++) {
                const d = particlesData[i];
                pos[i*3] = d.home.x + (d.chaos.x - d.home.x) * explosionProgress;
                pos[i*3+1] = d.home.y + (d.chaos.y - d.home.y) * explosionProgress;
                pos[i*3+2] = d.home.z + (d.chaos.z - d.home.z) * explosionProgress;
            }
            particles.geometry.attributes.position.needsUpdate = true;

            const updateObj = (obj) => {
                if(obj.userData.treePos) {
                    obj.position.lerpVectors(obj.userData.treePos, obj.userData.chaosPos, explosionProgress);
                    if(explosionProgress > 0.1) {
                        obj.rotation.x += 0.02; obj.rotation.y += 0.03;
                    }
                }
            };
            photosGroup.children.forEach(updateObj);
            giftsGroup.children.forEach(updateObj);

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>