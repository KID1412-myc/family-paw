<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- è§†å£è®¾ç½®ï¼šé€‚é…ç§»åŠ¨ç«¯ï¼Œç¦æ­¢ç¼©æ”¾ï¼Œè¦†ç›–åˆ˜æµ·å± -->
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">

    <title>å…¨å®¶äº²å¯†åœˆ</title>

    <!-- PWA é…ç½® -->
    <link rel="manifest" href="/static/manifest.json?v={{ app_version }}">
    <link rel="apple-touch-icon" href="/static/icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="èŒå® åœˆ">
    <meta name="theme-color" content="#667eea">
    <meta name="format-detection" content="telephone=no">

    <!-- å¼•å…¥ Bootstrap 5 å’Œ FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- å¼•å…¥å›¾ç‰‡å‹ç¼©åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>

    <style>
        /* ================= å…¨å±€åŸºç¡€æ ·å¼ ================= */
        body {
            background-color: #f2f4f7;
            padding-bottom: 90px; /* ä¸ºåº•éƒ¨å¯¼èˆªæ ç•™å‡ºç©ºé—´ */
            -webkit-tap-highlight-color: transparent; /* å»é™¤ç§»åŠ¨ç«¯ç‚¹å‡»é«˜äº® */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        /* é¡¶éƒ¨æ¸å˜å¯¼èˆªæ  */
        .navbar-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 0 0 24px 24px;
            box-shadow: 0 4px 20px rgba(118, 75, 162, 0.25);
            /* é€‚é… iPhone åˆ˜æµ·å± */
            padding-top: max(15px, env(safe-area-inset-top));
        }

        /* é€šç”¨ç™½è‰²å¡ç‰‡å®¹å™¨ */
        .card-box {
            background: white;
            border-radius: 16px;
            border: none;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
            margin-bottom: 20px;
            overflow: hidden;
            position: relative;
            transition: transform 0.2s;
        }

        /* æš–è‰²æ¸å˜ (å³å°†å›å®¶) */
        .bg-gradient-warm {
            background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 99%) !important;
            color: white !important;
        }

        /* å†·è‰²æ¸å˜ (å¹³æ—¶/æœªè®¾ç½®) */
        .bg-gradient-cool {
            background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%) !important;
            color: white !important;
        }

        /* ================= èŒå® é¡µæ ·å¼ (Pets Tab) ================= */
        .pet-photo-wrapper {
            position: relative;
            height: 260px;
            background: #eee;
            overflow: hidden;
        }

        .pet-photo-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        /* ç‚¹å‡»å›¾ç‰‡å¾®åŠ¨æ•ˆ */
        .pet-photo-wrapper img:active {
            transform: scale(1.02);
        }

        /* ç…§ç‰‡å³ä¸‹è§’ä¸Šä¼ è€…æ ‡ç­¾ */
        .uploader-badge {
            position: absolute;
            bottom: 12px;
            right: 12px;
            background: rgba(0, 0, 0, 0.65);
            color: white;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 20px;
            backdrop-filter: blur(4px);
            pointer-events: none;
        }

        /* å³ä¸Šè§’åˆ é™¤æŒ‰é’® */
        .delete-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }

        .delete-btn:active {
            transform: scale(0.9);
        }

        /* çŠ¶æ€å¾½ç«  (å·²å–‚é£Ÿ/å¾…å–‚é£Ÿ) */
        .status-badge {
            font-size: 0.85rem;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 500;
        }

        /* è™šçº¿ä¸Šä¼ æŒ‰é’® */
        .btn-upload-dashed {
            border: 2px dashed #dee2e6;
            color: #6c757d;
            background: transparent;
            transition: all 0.2s;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        .btn-upload-dashed:active {
            background: #f8f9fa;
            border-color: #adb5bd;
        }

        /* ================= åŠ¨æ€é¡µæ ·å¼ (Life Tab) ================= */
        .moment-item {
            padding: 20px;
            border-bottom: 1px solid #f8f9fa;
        }

        .moment-item:last-child {
            border-bottom: none;
        }

        /* åŠ¨æ€å¤´éƒ¨: å¤´åƒ+åå­—+æ—¶é—´ */
        .moment-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .avatar-circle {
            width: 42px;
            height: 42px;
            background: #f0f2f5;
            color: #764ba2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
            font-size: 16px;
            flex-shrink: 0;
            overflow: hidden;
            border: 1px solid #eee;
        }

        .avatar-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .moment-user {
            font-weight: bold;
            color: #333;
            font-size: 15px;
            line-height: 1.2;
        }

        .moment-time {
            font-size: 12px;
            color: #999;
            margin-top: 3px;
        }

        .moment-content {
            font-size: 15px;
            color: #333;
            margin-bottom: 10px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .moment-img {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 12px;
            border: 1px solid #f0f0f0;
            cursor: pointer;
        }

        .moment-delete-btn {
            color: #dc3545;
            background: none;
            border: none;
            font-size: 14px;
            margin-left: auto;
            opacity: 0.6;
            padding: 8px;
        }

        .moment-delete-btn:active {
            opacity: 1;
        }

        /* ================= ä¸ªäººä¸­å¿ƒæ ·å¼ (Mine Tab) ================= */
        .my-avatar-container {
            position: relative;
            width: 90px;
            height: 90px;
            margin: 0 auto 15px;
        }

        .my-avatar {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            background: #eee;
        }

        .avatar-edit-icon {
            position: absolute;
            bottom: 0;
            right: 0;
            background: #764ba2;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* é‚€è¯·ç ç›’å­ */
        .invite-code-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            font-family: monospace;
            letter-spacing: 4px;
            font-weight: bold;
            font-size: 24px;
            border: 2px dashed #ccc;
            cursor: pointer;
            transition: 0.2s;
            color: #333;
            user-select: all;
        }

        .invite-code-box:active {
            background: #e9ecef;
            border-color: #adb5bd;
            transform: scale(0.98);
        }

        /* ================= åº•éƒ¨å¯¼èˆªæ  ================= */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            height: 70px;
            display: flex;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.03);
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #adb5bd;
            text-decoration: none;
            font-size: 11px;
            transition: 0.2s;
            padding-top: 5px;
        }

        .nav-item i {
            font-size: 22px;
            margin-bottom: 4px;
        }

        .nav-item.active {
            color: #764ba2;
            font-weight: 600;
        }

        .nav-item.active i {
            transform: scale(1.1);
        }

        /* ================= è¾…åŠ©ç»„ä»¶ ================= */
        .hidden-input {
            display: none;
        }

        .d-none {
            display: none !important;
        }

        .w-fit-content {
            width: fit-content;
        }

        /* å…¨å± Loading */
        #loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.85);
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        /* å›¾ç‰‡é¢„è§ˆåŒº */
        #preview-container {
            margin-bottom: 10px;
        }

        .remove-preview {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #333;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            text-align: center;
            line-height: 22px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            border: 2px solid white;
        }
    </style>
</head>
<body>

<!-- å…¨å±åŠ è½½åŠ¨ç”» -->
<div id="loading-overlay">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    <div class="mt-3 fw-bold text-secondary" style="letter-spacing: 1px;">å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</div>
</div>

<!-- é¡¶éƒ¨å¯¼èˆªæ  -->
<div class="navbar-custom">
    <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-3">
            <div>
                <h5 class="mb-0 fw-bold">
                    {% if current_tab == 'mine' %}ä¸ªäººä¸­å¿ƒ{% else %}ğŸ‘‹ å—¨ï¼Œ{{ user_name }}{% endif %}
                </h5>
                {% if current_tab != 'mine' %}
                    <small style="opacity: 0.8; font-size: 0.85rem;">ğŸ“… {{ today }}</small>
                {% endif %}
            </div>

            {% if current_role == 'admin' or session.get('is_impersonator') %}
                <a href="/admin"
                   class="text-white bg-white bg-opacity-25 rounded-circle d-flex align-items-center justify-content-center shadow-sm"
                   style="width: 34px; height: 34px; text-decoration: none;" title="å›åˆ°ç®¡ç†åå°">
                    <i class="fas fa-cogs"></i>
                </a>
            {% endif %}
        </div>

        {% if current_tab != 'mine' %}
            <a href="/logout" class="text-white opacity-75 p-2"><i class="fas fa-sign-out-alt fa-lg"></i></a>
        {% endif %}
    </div>
</div>

<div class="container mt-3">

    <!-- Flash æ¶ˆæ¯æç¤ºåŒº -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm border-0 mb-3"
                     role="alert">
                    <i class="fas fa-info-circle me-1"></i> {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- ================= Tab: èŒå®  ================= -->
    <div id="tab-pets" class="{% if current_tab != 'pets' %}d-none{% endif %}">
        <!-- ================= å½’å®¶å€’è®¡æ—¶å¡ç‰‡ ================= -->
        {% if my_families %}
            {% for fam in my_families %}
                <!-- åªæœ‰è®¾ç½®äº†æ—¥æœŸï¼Œæˆ–è€…æˆ‘æ˜¯å½“å‰æŸ¥çœ‹è€…æ—¶æ˜¾ç¤ºè®¾ç½®æŒ‰é’® -->
                <div class="card-box mb-3 shadow-sm {% if fam.days_left is not none and fam.days_left >= 0 %}bg-gradient-warm{% else %}bg-gradient-cool{% endif %}">
                    <div class="p-3 position-relative">
                        <!-- è®¾ç½®æŒ‰é’® (å³ä¸Šè§’) -->
                        <button class="btn btn-sm btn-light bg-white bg-opacity-25 border-0 text-white position-absolute top-0 end-0 m-2 rounded-circle"
                                style="width:32px;height:32px;"
                                onclick="openReunionModal('{{ fam.id }}', '{{ fam.reunion_name or '' }}', '{{ fam.reunion_date or '' }}')">
                            <i class="fas fa-edit"></i>
                        </button>

                        <!-- å†…å®¹åŒº -->
                        {% if fam.days_left is not none %}
                            <div class="text-center py-2">
                                {% if fam.days_left > 0 %}
                                    <div class="small opacity-75 mb-1">{{ fam.reunion_name or 'è·ç¦»å›¢åœ†è¿˜æœ‰' }}</div>
                                    <div class="display-1 fw-bold" style="line-height: 1;">{{ fam.days_left }}</div>
                                    <div class="small opacity-75 mt-1">å¤©</div>
                                    <div class="badge bg-white text-danger mt-3 px-3 rounded-pill shadow-sm"
                                         style="font-weight:800;">
                                        ğŸ“… {{ fam.reunion_date }}
                                    </div>
                                {% elif fam.days_left == 0 %}
                                    <!-- å½“å¤©ç‰¹æ•ˆ -->
                                    <div class="display-4 fw-bold mb-2">ğŸ‰ ä»Šå¤©å›¢åœ†ï¼</div>
                                    <div class="small">æ¬¢è¿å›å®¶</div>
                                {% else %}
                                    <!-- è¿‡æœŸ -->
                                    <div class="opacity-50">
                                        <div class="fs-4 fw-bold">{{ fam.reunion_name }}</div>
                                        <div class="small">å·²ç»è¿‡å» {{ fam.days_left|abs }} å¤©å•¦</div>
                                    </div>
                                {% endif %}
                            </div>
                        {% else %}
                            <!-- æœªè®¾ç½®çŠ¶æ€ -->
                            <div class="text-center py-3" onclick="openReunionModal('{{ fam.id }}', '', '')"
                                 style="cursor: pointer;">
                                <i class="far fa-clock fa-2x mb-2 opacity-50"></i>
                                <div class="fw-bold">è®¾ç½®{{ fam.name }}çš„å›¢åœ†å€’è®¡æ—¶</div>
                                <small class="opacity-75">ç»™ç›¼å¤´å®šä¸ªæ—¥å­ ğŸ“…</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% endif %}
        <!-- é¡¶éƒ¨æ“ä½œæ  -->
        {% if my_families %}
            <div class="d-flex justify-content-between align-items-center mb-3 px-1">
                <span class="text-muted small">å…± {{ pets|length }} åªèŒå® </span>
                <button class="btn btn-sm btn-primary rounded-pill fw-bold shadow-sm" data-bs-toggle="modal"
                        data-bs-target="#addPetModal">
                    <i class="fas fa-plus me-1"></i>æ·»æ–°å® 
                </button>
            </div>
        {% endif %}

        {% for pet in pets %}
            <div class="card-box">
                <!-- å® ç‰©æ ‡é¢˜æ  -->
                <div class="p-3 d-flex justify-content-between align-items-center border-bottom border-light">
                    <h5 class="mb-0 fw-bold d-flex align-items-center">
                        {% if pet.type == 'dog' %}
                            <i class="fas fa-dog text-secondary me-2 fa-lg"></i>
                        {% else %}
                            <i class="fas fa-cat text-secondary me-2 fa-lg"></i>
                        {% endif %}
                        {{ pet.name }}
                        {% if pet.family_name %}
                            <span class="badge bg-light text-muted border ms-2 fw-normal"
                                  style="font-size: 10px;">{{ pet.family_name }}</span>
                        {% endif %}
                    </h5>

                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-light text-dark border">{{ pet.type }}</span>
                        <!-- ç¼–è¾‘æŒ‰é’® (ä»…ä¸»äººå¯è§) -->
                        {% if pet.is_owner %}
                            <!-- [ä¿®æ”¹] å¢åŠ äº†ç¬¬4ä¸ªå‚æ•°: pet.owner_ids | tojson -->
                            <!-- æ³¨æ„ï¼šonclick= åé¢ç”¨çš„æ˜¯å•å¼•å· ' -->
                            <button class="btn btn-sm btn-link text-muted p-0"
                                    onclick='openEditPetModal("{{ pet.id }}", "{{ pet.name }}", "{{ pet.family_id }}", {{ pet.owner_ids | tojson }})'>
                                <i class="fas fa-cog"></i>
                            </button>
                        {% endif %}
                    </div>
                </div>

                <!-- (ä¸­é—´çš„ç…§ç‰‡ã€å–‚é£Ÿã€é›ç‹—ä»£ç ä¿æŒä¸å˜ï¼Œç›´æ¥å¤åˆ¶åŸæ¥çš„å³å¯) -->
                {% if pet.latest_photo %}
                    <div class="pet-photo-wrapper">
                        <img src="{{ pet.latest_photo }}" onclick="window.open(this.src)">
                        <div class="uploader-badge"><i class="fas fa-camera"></i> {{ pet.photo_uploader }}</div>
                        {% if pet.latest_user_id == current_user_id %}
                            <form action="/delete_log/{{ pet.latest_log_id }}" method="POST"
                                  onsubmit="return confirm('åˆ ç…§ç‰‡ï¼Ÿ')">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <button type="submit" class="delete-btn"><i class="fas fa-trash-alt"></i></button>
                            </form>
                        {% endif %}
                    </div>
                {% endif %}

                <div class="p-3">
                    <!-- å–‚é£ŸåŒºåŸŸ -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="small fw-bold text-muted">ğŸš åƒé¥­äº†å—ï¼Ÿ</span>
                            <span class="badge {% if pet.today_feed %}bg-success text-success bg-opacity-10{% else %}bg-danger text-danger bg-opacity-10{% endif %}">
                                {% if pet.today_feed %}âœ… å·²å–‚é£Ÿ{% else %}â³ å¾…å–‚é£Ÿ{% endif %}
                            </span>
                        </div>
                        {% if not pet.today_feed %}
                            <form action="/action" method="POST">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <input type="hidden" name="pet_id" value="{{ pet.id }}">
                                <button type="submit" name="action" value="feed"
                                        class="btn btn-success w-100 fw-bold py-2"><i
                                        class="fas fa-bone me-1"></i> å–‚é¥­æ‰“å¡
                                </button>
                            </form>
                        {% else %}
                            <div class="alert alert-success py-2 px-3 mb-0 small border-0 bg-success bg-opacity-10 text-success">
                                <i class="fas fa-check-circle me-1"></i> {{ pet.feed_info }}
                            </div>
                        {% endif %}
                    </div>

                    <!-- é›ç‹—åŒºåŸŸ -->
                    {% if pet.type == 'dog' %}
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="small fw-bold text-muted">ğŸ¦® é›å¼¯äº†å—ï¼Ÿ</span>
                                <span class="badge {% if pet.today_walk %}bg-primary text-primary bg-opacity-10{% else %}bg-warning text-dark bg-opacity-10{% endif %}">
                                {% if pet.today_walk %}âœ… å·²é›å¼¯{% else %}â³ å¾…é›å¼¯{% endif %}
                            </span>
                            </div>
                            {% if not pet.today_walk %}
                                <form action="/action" method="POST">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <input type="hidden" name="pet_id" value="{{ pet.id }}">
                                    <button type="submit" name="action" value="walk"
                                            class="btn btn-primary w-100 fw-bold py-2"><i
                                            class="fas fa-running me-1"></i> å‡ºå‘é›ç‹—
                                    </button>
                                </form>
                            {% else %}
                                <div class="alert alert-primary py-2 px-3 mb-0 small border-0 bg-primary bg-opacity-10 text-primary">
                                    <i class="fas fa-check-circle me-1"></i> {{ pet.walk_info }}
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}

                    <!-- æ‹ç…§æŒ‰é’® -->
                    <form action="/upload_pet" method="POST" enctype="multipart/form-data" id="petForm-{{ pet.id }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="pet_id" value="{{ pet.id }}">
                        <label class="btn btn-upload-dashed w-100 rounded-3">
                            <i class="fas fa-camera text-muted me-2"></i> æ‹å¼ ç…§
                            <input type="file" name="photo" class="hidden-input" accept="image/*"
                                   onchange="handleCompressAndSubmit(this, 'petForm-{{ pet.id }}')">
                        </label>
                    </form>
                </div>
            </div>
        {% else %}
            <div class="text-center py-5 text-muted">
                <i class="fas fa-paw fa-3x mb-3 opacity-25"></i>
                <p>è¿˜æ²¡æœ‰å® ç‰©</p>
                {% if not my_families %}
                    <small>è¯·å…ˆåŠ å…¥å®¶åº­</small>
                {% else %}
                    <button class="btn btn-primary btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#addPetModal">
                        æ·»åŠ ç¬¬ä¸€åªå® ç‰©
                    </button>
                {% endif %}
            </div>
        {% endfor %}
        <div style="height: 40px;"></div>
    </div>

    <!-- ============ æ”¾åœ¨ body ç»“æŸå‰çš„å¼¹çª—ä»£ç  ============ -->

    <!-- æ·»åŠ å® ç‰©å¼¹çª— -->
    <div class="modal fade" id="addPetModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0 shadow">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">ğŸ¶ æ·»åŠ æ–°æˆå‘˜</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form action="/create_pet" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                        <div class="mb-3">
                            <label class="form-label small text-muted">åå­—</label>
                            <input type="text" name="name" class="form-control" placeholder="å¦‚: æ—ºè´¢" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small text-muted">ç±»å‹</label>
                            <select name="type" class="form-select">
                                <option value="dog">ğŸ¶ ç‹—ç‹—</option>
                                <option value="cat">ğŸ± çŒ«çŒ«</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small text-muted">å½’å±å®¶åº­</label>
                            <select name="family_id" class="form-select">
                                {% for f in my_families %}
                                    <option value="{{ f.id }}">{{ f.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 fw-bold rounded-3 py-2">ç¡®è®¤æ·»åŠ </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘å® ç‰©å¼¹çª— -->
    <div class="modal fade" id="editPetModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0 shadow">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">âš™ï¸ ç®¡ç†å® ç‰©</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">

                    <!-- ä¿®æ”¹åå­—éƒ¨åˆ† -->
                    <form action="/update_pet" method="POST" class="mb-4 border-bottom pb-4">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="pet_id" id="edit_pet_id">

                        <label class="form-label small text-muted fw-bold">ä¿®æ”¹èµ„æ–™</label>
                        <div class="input-group mb-2">
                            <input type="text" name="name" id="edit_pet_name" class="form-control" required>
                            <button type="submit" name="action" value="update" class="btn btn-success fw-bold">ä¿å­˜
                            </button>
                        </div>
                        <div class="text-end">
                            <button type="submit" name="action" value="delete"
                                    class="btn btn-link text-danger text-decoration-none p-0 small"
                                    onclick="return confirm('âš ï¸ ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ')">åˆ é™¤æ­¤å® ç‰©
                            </button>
                        </div>
                    </form>

                    <!-- æ·»åŠ å…±ç®¡äººéƒ¨åˆ† -->
                    <form action="/add_pet_owner" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="pet_id" id="add_owner_pet_id">

                        <label class="form-label small text-muted fw-bold">æ·»åŠ å…±ç®¡ä¸»äºº (å¯¹è±¡/çˆ¶æ¯)</label>
                        <div class="input-group">
                            <select name="new_owner_id" class="form-select">
                                <option value="" disabled selected>é€‰æ‹©å®¶åº­æˆå‘˜...</option>
                                <!-- éå†æ‰€æœ‰å¯è§çš„å®¶åº­æˆå‘˜ -->
                                {% for uid, info in user_map.items() %}
                                    <!-- ä¸æ˜¾ç¤ºæˆ‘è‡ªå·± -->
                                    {% if uid != current_user_id %}
                                        <option value="{{ uid }}">{{ info.name }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                            <button class="btn btn-outline-primary fw-bold">æ·»åŠ </button>
                        </div>
                        <div class="form-text small">æ·»åŠ åï¼Œä»–/å¥¹ä¹Ÿèƒ½ä¿®æ”¹å® ç‰©ä¿¡æ¯ã€‚</div>
                    </form>

                </div>
            </div>
        </div>
    </div>

    <!-- æ›´æ–°å…¬å‘Šå¼¹çª— -->
    {% if latest_update %}
        <div class="modal fade" id="updateModal" tabindex="-1" data-bs-backdrop="static">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content rounded-4 border-0 shadow-lg">
                    <div class="modal-header border-0 bg-success bg-opacity-10">
                        <h5 class="modal-title fw-bold text-success">
                            ğŸš€ æ–°ç‰ˆæœ¬ v{{ latest_update.version }}
                        </h5>
                        <!-- è¿™é‡Œçš„å…³é—­æŒ‰é’®æœ‰ç‰¹æ®Šé€»è¾‘ï¼Œè§JS -->
                        <button type="button" class="btn-close"
                                onclick="closeUpdateModal('{{ latest_update.version }}')"></button>
                    </div>
                    <div class="modal-body p-4">
                        <div class="fs-6" style="line-height: 1.8;">
                            {{ latest_update.content | safe }}
                        </div>
                    </div>
                    <div class="modal-footer border-0 pt-0">
                        <button type="button" class="btn btn-success w-100 rounded-pill fw-bold"
                                onclick="closeUpdateModal('{{ latest_update.version }}')">
                            æˆ‘çŸ¥é“äº†
                        </button>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
    <!-- è®¾ç½®å€’è®¡æ—¶å¼¹çª— -->
    <div class="modal fade" id="reunionModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">ğŸ“… ä»€ä¹ˆæ—¶å€™å›¢åœ†ï¼Ÿ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form action="/set_reunion" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="family_id" id="reunion_fam_id">

                        <div class="mb-3">
                            <label class="form-label small text-muted">æ ‡é¢˜</label>
                            <input type="text" name="reunion_name" id="reunion_name" class="form-control"
                                   placeholder="ä¾‹å¦‚: å¯’å‡å›å®¶ / çˆ¸å¦ˆæ¥å—äº¬">
                        </div>

                        <div class="mb-4">
                            <label class="form-label small text-muted">ç›®æ ‡æ—¥æœŸ</label>
                            <input type="date" name="reunion_date" id="reunion_date"
                                   class="form-control form-control-lg fw-bold text-center">
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary fw-bold">ä¿å­˜è®¾ç½®</button>
                            <button type="button" class="btn btn-light text-danger" onclick="clearReunionDate()">
                                æ¸…é™¤/å–æ¶ˆå€’è®¡æ—¶
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- ================= Tab: åŠ¨æ€ ================= -->
    <div id="tab-life" class="{% if current_tab != 'life' %}d-none{% endif %}">

        <!-- å‘å¸ƒæ¡† (ä¿®æ”¹ç‚¹ï¼šåˆ¤æ–­ my_families æ˜¯å¦å­˜åœ¨) -->
        {% if my_families %}
            <div class="card-box p-3 shadow-sm">
                <form action="/post_moment" method="POST" enctype="multipart/form-data" id="momentForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="mb-2">
                    <textarea name="content" class="form-control border-0 bg-light rounded-3" rows="3"
                              placeholder="åˆ†äº«æ­¤æ—¶æ­¤åˆ»... (æ¯”å¦‚: åˆšä¸‹è¯¾å¥½é¥¿)"
                              style="resize:none; padding: 12px;"></textarea>
                    </div>
                    <!-- é¢„è§ˆåŒº -->
                    <div id="preview-container" class="d-none mb-2 position-relative w-fit-content">
                        <img id="preview-img" src="" style="max-height: 150px; border-radius: 8px;">
                        <div onclick="clearPreview()"
                             class="position-absolute top-0 end-0 bg-dark text-white rounded-circle"
                             style="width:20px;height:20px;line-height:18px;text-align:center;cursor:pointer;margin:-5px;">
                            Ã—
                        </div>
                    </div>
                    <!-- åº•éƒ¨æŒ‰é’® -->
                    <div class="d-flex justify-content-between align-items-center border-top pt-2">
                        <label class="btn btn-sm btn-outline-primary rounded-pill px-3">
                            <i class="fas fa-image me-1"></i> åŠ å›¾ç‰‡
                            <input type="file" name="photo" id="momentPhotoInput" class="hidden-input" accept="image/*"
                                   onchange="handleCompressAndPreview(this)">
                        </label>
                        <button type="submit" class="btn btn-sm btn-primary rounded-pill px-4 fw-bold shadow-sm">
                            <i class="fas fa-paper-plane me-1"></i> å‘å¸ƒ
                        </button>
                    </div>
                </form>
            </div>
        {% else %}
            <!-- å¦‚æœæ²¡åŠ å…¥å®¶åº­ï¼Œæ˜¾ç¤ºæç¤º -->
            <div class="alert alert-warning text-center small rounded-4 shadow-sm border-0 mb-3">
                <i class="fas fa-exclamation-circle me-1"></i> åŠ å…¥å®¶åº­åæ‰èƒ½å‘å¸ƒåŠ¨æ€å“¦
            </div>
        {% endif %}

        <!-- åŠ¨æ€åˆ—è¡¨ -->
        <div class="card-box">
            {% for moment in moments %}
                <div class="moment-item">
                    <div class="moment-header">
                        <div class="avatar-circle">
                            {% if moment.user_avatar %}
                                <img src="{{ moment.user_avatar }}">
                            {% else %}
                                {{ moment.user_name[0] }}
                            {% endif %}
                        </div>
                        <div class="flex-grow-1">
                            <div class="moment-user">{{ moment.user_name }}</div>
                            <div class="moment-time">{{ moment.time_str }}</div>
                        </div>
                        {% if moment.user_id == current_user_id %}
                            <form action="/delete_moment/{{ moment.id }}" method="POST"
                                  onsubmit="return confirm('ç¡®å®šåˆ é™¤è¿™æ¡åŠ¨æ€å—ï¼Ÿ')" class="ms-auto">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <button type="submit" class="moment-delete-btn" title="åˆ é™¤"><i
                                        class="fas fa-trash-alt"></i>
                                </button>
                            </form>
                        {% endif %}
                    </div>
                    {% if moment.content %}
                        <div class="moment-content">{{ moment.content }}</div>
                    {% endif %}
                    {% if moment.image_url %}<img src="{{ moment.image_url }}" class="moment-img shadow-sm"
                                                  onclick="window.open(this.src)">{% endif %}
                </div>
            {% else %}
                <div class="text-center p-5 text-muted">
                    <div class="mb-3 opacity-50"><i class="fas fa-seedling fa-3x text-success"></i></div>
                    <p>è¿˜æ²¡æœ‰åŠ¨æ€å“¦</p>
                    {% if not my_families %}
                        <small>å¿«åŠ å…¥å®¶åº­ï¼Œå’Œå®¶äººåˆ†äº«ç”Ÿæ´»ï¼</small>
                    {% else %}
                        <small>å¿«æ¥å‘ç¬¬ä¸€æ¡çŠ¶æ€ï¼Œè®©å®¶äººçŸ¥é“ä½ åœ¨å¹²å˜›ï¼</small>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
        <div style="height: 40px;"></div>
    </div>

    <!-- ================= Tab: ä¸ªäººä¸­å¿ƒ ================= -->
    <div id="tab-mine" class="{% if current_tab != 'mine' %}d-none{% endif %}">

        <div class="card-box p-4 text-center">
            <!-- å¤´åƒä¿®æ”¹ -->
            <form action="/update_profile" method="POST" enctype="multipart/form-data" id="avatarForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <label class="my-avatar-container" style="cursor: pointer;">
                    {% if my_profile.full_avatar_url %}
                        <img src="{{ my_profile.full_avatar_url }}" class="my-avatar">
                    {% else %}
                        <img src="https://ui-avatars.com/api/?name={{ user_name }}&background=random" class="my-avatar">
                    {% endif %}
                    <div class="avatar-edit-icon"><i class="fas fa-camera"></i></div>
                    <input type="file" name="avatar" class="hidden-input" accept="image/*"
                           onchange="handleCompressAndSubmit(this, 'avatarForm')">
                </label>
            </form>

            <!-- æ˜µç§°ä¿®æ”¹ -->
            <form action="/update_profile" method="POST"
                  class="d-flex justify-content-center align-items-center gap-2 mb-2">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="text" name="display_name" value="{{ my_profile.display_name }}"
                       class="form-control form-control-sm text-center fw-bold fs-5"
                       style="width: 150px; border:none; border-bottom: 1px dashed #ccc; background:transparent; padding:0;"
                       onblur="this.form.submit()">
                <i class="fas fa-pen text-muted" style="font-size: 12px;"></i>
            </form>

            <div class="text-muted small mb-3 opacity-50 font-monospace">ID: {{ my_profile.id|truncate(8, True) }}</div>

            <!-- å®¶åº­çŠ¶æ€é€»è¾‘ -->
            <div class="mt-4 text-start">
                <h6 class="fw-bold mb-3"><i class="fas fa-users me-2 text-primary"></i>æˆ‘çš„å®¶åº­åˆ—è¡¨</h6>

                {% if my_families %}
                    <div class="d-grid gap-3">
                        {% for fam in my_families %}
                            <div class="bg-light p-3 rounded-3 border position-relative">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-bold text-dark">{{ fam.name }}</span>
                                    <span class="badge bg-primary bg-opacity-10 text-primary">æˆå‘˜</span>
                                </div>

                                <div class="d-flex align-items-center justify-content-between bg-white p-2 rounded border border-light">
                                    <div class="text-muted small font-monospace"
                                         style="letter-spacing:1px;">{{ fam.invite_code }}
                                    </div>
                                    <button class="btn btn-sm btn-link text-decoration-none p-0"
                                            onclick="copyCode(this.previousElementSibling)" style="font-size:12px;">
                                        å¤åˆ¶é‚€è¯·ç 
                                    </button>
                                </div>

                                <!-- é€€å‡ºå…·ä½“æŸä¸ªå®¶åº­ -->
                                <form action="/leave_family" method="POST"
                                      onsubmit="return confirm('ç¡®å®šè¦é€€å‡º [{{ fam.name }}] å—ï¼Ÿ')"
                                      class="mt-2 text-end">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <input type="hidden" name="family_id" value="{{ fam.id }}">
                                    <button class="btn btn-sm text-danger p-0" style="font-size: 11px; opacity: 0.7;">
                                        <i class="fas fa-sign-out-alt me-1"></i>é€€å‡ºæ­¤å®¶åº­
                                    </button>
                                </form>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-secondary small text-center">
                        ä½ è¿˜æ²¡æœ‰åŠ å…¥ä»»ä½•å®¶åº­
                    </div>
                {% endif %}
            </div>
            <!-- æœªåŠ å…¥å®¶åº­ï¼šæ˜¾ç¤ºåˆ›å»º/åŠ å…¥é€‰é¡¹ -->
            <div class="mt-4 text-start bg-white rounded-3 pt-3 border-top">
                <ul class="nav nav-tabs nav-fill mb-3" id="famTab" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active fw-bold small" data-bs-toggle="tab" data-bs-target="#joinFam">
                            åŠ å…¥æ–°å®¶
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link fw-bold small" data-bs-toggle="tab" data-bs-target="#createFam">
                            åˆ›å»ºæ–°å®¶
                        </button>
                    </li>
                </ul>
                <div class="tab-content p-2">
                    <div class="tab-pane fade show active" id="joinFam">
                        <form action="/join_family" method="POST">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <div class="input-group mb-2">
                                <span class="input-group-text"><i class="fas fa-key"></i></span>
                                <input type="text" name="invite_code" class="form-control text-uppercase"
                                       placeholder="è¾“å…¥6ä½é‚€è¯·ç " required>
                            </div>
                            <button class="btn btn-primary w-100 fw-bold btn-sm">åŠ å…¥</button>
                        </form>
                    </div>
                    <div class="tab-pane fade" id="createFam">
                        <form action="/create_family" method="POST">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <div class="input-group mb-2">
                                <span class="input-group-text"><i class="fas fa-house-user"></i></span>
                                <input type="text" name="family_name" class="form-control" placeholder="ç»™å®¶èµ·ä¸ªåå­—"
                                       required>
                            </div>
                            <button class="btn btn-success w-100 fw-bold btn-sm">åˆ›å»º</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- å®‰å…¨è®¾ç½®å¡ç‰‡ -->
        <div class="card-box p-3">
            <h6 class="mb-3 fw-bold text-dark"><i class="fas fa-lock me-2 text-secondary"></i>å®‰å…¨è®¾ç½®</h6>
            <form action="/change_password" method="POST" class="d-flex gap-2">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="password" name="new_password" class="form-control" placeholder="è¾“å…¥æ–°å¯†ç  (è‡³å°‘6ä½)"
                       required>
                <button class="btn btn-outline-primary px-3">ç¡®è®¤</button>
            </form>
        </div>

        <!-- é€€å‡ºç™»å½•æŒ‰é’® -->
        <div class="d-grid gap-2 mb-4">
            <a href="/logout" class="btn btn-light text-danger fw-bold py-3 rounded-4 shadow-sm border">
                <i class="fas fa-sign-out-alt me-2"></i> é€€å‡ºç™»å½•
            </a>
        </div>

        <div style="height: 20px;"></div>
    </div>

</div>

<!-- åº•éƒ¨å¯¼èˆªæ  -->
<div class="bottom-nav">
    <a href="/?tab=pets" class="nav-item {% if current_tab == 'pets' %}active{% endif %}">
        <i class="fas fa-paw"></i>
        <span>èŒå® </span>
    </a>
    <a href="/?tab=life" class="nav-item {% if current_tab == 'life' %}active{% endif %}">
        <i class="fas fa-camera-retro"></i>
        <span>åŠ¨æ€</span>
    </a>
    <a href="/?tab=mine" class="nav-item {% if current_tab == 'mine' %}active{% endif %}">
        <i class="fas fa-user"></i>
        <span>æˆ‘çš„</span>
    </a>
</div>

<!-- å¼•å…¥ Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // 1. å®‰å…¨æ¥æ”¶æ•°æ® (åŠ äº†é»˜è®¤å€¼ {})
    const familyMembersMap = {{ family_members_dict | tojson | safe }} || {};
    const userMap = {{ user_map | tojson | safe }} || {};
    const currentUserId = '{{ current_user_id }}';

    // æ˜¾ç¤ºåŠ è½½å±‚
    function showLoading() {
        const overlay = document.getElementById('loading-overlay');
        if (overlay) overlay.style.display = 'flex';
    }

    // [ä¿®æ”¹] å¢åŠ äº†ç¬¬4ä¸ªå‚æ•° ownerIds (å·²æœ‰ä¸»äººçš„IDåˆ—è¡¨)
    function openEditPetModal(id, name, familyId, ownerIds) {
        console.log("ç‚¹å‡»ç¼–è¾‘:", id, name, familyId, ownerIds);

        // 1. å¡«å……åŸºç¡€ä¿¡æ¯
        document.getElementById('edit_pet_id').value = id;
        document.getElementById('add_owner_pet_id').value = id;
        document.getElementById('edit_pet_name').value = name;

        // 2. åŠ¨æ€ç”Ÿæˆä¸‹æ‹‰æ¡†
        const select = document.querySelector('select[name="new_owner_id"]');
        select.innerHTML = '<option value="" disabled selected>é€‰æ‹©å®¶åº­æˆå‘˜...</option>';

        // ç¡®ä¿ ownerIds æ˜¯ä¸ªæ•°ç»„ (é˜²é”™)
        const currentOwners = ownerIds || [];

        const members = (familyId && familyMembersMap[String(familyId)]) ? familyMembersMap[String(familyId)] : [];

        if (members.length === 0) {
            const opt = new Option("æš‚æ— å…¶ä»–æˆå‘˜", "");
            select.add(opt);
        } else {
            members.forEach(uid => {
                // æ’é™¤æˆ‘è‡ªå·±ï¼Œä¸”ç”¨æˆ·å­˜åœ¨
                if (uid !== currentUserId && userMap[uid]) {
                    let displayName = userMap[uid].name;
                    let isDisabled = false;

                    // [æ ¸å¿ƒé€»è¾‘] å¦‚æœè¯¥ç”¨æˆ·å·²ç»åœ¨ä¸»äººåˆ—è¡¨é‡Œ
                    if (currentOwners.includes(uid)) {
                        displayName += " (å·²æ˜¯ä¸»äºº)";
                        isDisabled = true;
                    }

                    const opt = new Option(displayName, uid);
                    if (isDisabled) {
                        opt.disabled = true; // ç¦ç”¨é€‰æ‹©
                    }
                    select.add(opt);
                }
            });
        }

        // 3. æ˜¾ç¤ºå¼¹çª—
        new bootstrap.Modal(document.getElementById('editPetModal')).show();
    }


    /**
     * åœºæ™¯1ï¼šå‹ç¼©å¹¶è‡ªåŠ¨æäº¤ (ç”¨äºï¼šå® ç‰©æ‹ç…§ã€å¤´åƒä¸Šä¼ )
     * é€‰ä¸­å›¾ç‰‡ -> å‹ç¼© -> æ„é€ æ–°æ–‡ä»¶ -> æ›¿æ¢ Input -> æäº¤ Form
     */
    function handleCompressAndSubmit(input, formId) {
        const file = input.files[0];
        if (!file) return;

        showLoading(); // å¼€å¯ Loading

        new Compressor(file, {
            quality: 0.6, // 0.6 è´¨é‡é€šå¸¸åªæœ‰åŸå›¾ 10% å¤§å°
            maxWidth: 1200, // é™åˆ¶å®½åº¦ï¼Œé˜²æ­¢è¶…å¤§å›¾
            success(result) {
                const dt = new DataTransfer();
                dt.items.add(new File([result], file.name, {type: file.type}));
                input.files = dt.files;
                document.getElementById(formId).submit();
            },
            error(err) {
                console.error('å‹ç¼©å¤±è´¥ï¼Œå°è¯•åŸå›¾ä¸Šä¼ ', err);
                document.getElementById(formId).submit();
            },
        });
    }

    /**
     * åœºæ™¯2ï¼šå‹ç¼©å¹¶é¢„è§ˆ (ç”¨äºï¼šå‘å¸ƒåŠ¨æ€)
     * é€‰ä¸­å›¾ç‰‡ -> å‹ç¼© -> æ›¿æ¢ Input -> æ˜¾ç¤ºé¢„è§ˆå›¾ -> (ç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‘å¸ƒ)
     */
    function handleCompressAndPreview(input) {
        const file = input.files[0];
        if (!file) return;

        new Compressor(file, {
            quality: 0.6,
            maxWidth: 1600,
            success(result) {
                // æ›¿æ¢ input ä¸­çš„æ–‡ä»¶
                const dt = new DataTransfer();
                dt.items.add(new File([result], file.name, {type: file.type}));
                input.files = dt.files;

                // è¯»å–å¹¶é¢„è§ˆ
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('preview-img').src = e.target.result;
                    document.getElementById('preview-container').classList.remove('d-none');
                }
                reader.readAsDataURL(result);
            },
            error(err) {
                console.error(err.message);
            }
        });
    }

    function clearPreview() {
        document.getElementById('momentPhotoInput').value = "";
        document.getElementById('preview-container').classList.add('d-none');
    }

    // å¤åˆ¶é‚€è¯·ç 
    function copyCode(el) {
        const text = el.innerText;
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text).then(() => {
                alert('é‚€è¯·ç  [' + text + '] å·²å¤åˆ¶ï¼');
            }).catch(err => {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é•¿æŒ‰å¤åˆ¶');
            });
        } else {
            alert('è¯·é•¿æŒ‰é‚€è¯·ç æ‰‹åŠ¨å¤åˆ¶');
        }
    }

    // åŠ¨æ€è¡¨å•æ‰‹åŠ¨æäº¤æ—¶ï¼Œä¹Ÿæ˜¾ç¤º loading
    const momentForm = document.getElementById('momentForm');
    if (momentForm) {
        momentForm.addEventListener('submit', function () {
            showLoading();
        });
    }
    // æ›´æ–°æ—¥å¿—é€»è¾‘
    document.addEventListener('DOMContentLoaded', function () {
        {% if latest_update %}
            const serverVersion = '{{ latest_update.version }}';
            // [æ ¸å¿ƒä¿®æ”¹] Key åŠ ä¸Šå½“å‰ç”¨æˆ·IDï¼Œå®ç°å¤šè´¦å·éš”ç¦»
            const storageKey = 'app_version_' + '{{ current_user_id }}';
            const localVersion = localStorage.getItem(storageKey);

            // å¦‚æœæœ¬åœ°æ²¡å­˜ç‰ˆæœ¬ï¼Œæˆ–è€…ç‰ˆæœ¬ä¸ä¸€è‡´ -> å¼¹çª—
            if (localVersion !== serverVersion) {
                const modal = new bootstrap.Modal(document.getElementById('updateModal'));
                modal.show();
            }
        {% endif %}
    });

    function closeUpdateModal(version) {
        // [æ ¸å¿ƒä¿®æ”¹] å­˜çš„æ—¶å€™ä¹Ÿå¸¦ä¸Šç”¨æˆ·ID
        const storageKey = 'app_version_' + '{{ current_user_id }}';
        localStorage.setItem(storageKey, version);

        const modalEl = document.getElementById('updateModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();
    }

    // æ‰“å¼€å€’è®¡æ—¶è®¾ç½®
    function openReunionModal(fid, name, date) {
        document.getElementById('reunion_fam_id').value = fid;
        document.getElementById('reunion_name').value = name;
        document.getElementById('reunion_date').value = date;
        new bootstrap.Modal(document.getElementById('reunionModal')).show();
    }

    // æ¸…é™¤æ—¥æœŸ (é€šè¿‡æŠŠæ—¥æœŸè®¾ä¸ºç©ºæäº¤)
    function clearReunionDate() {
        if (confirm('ç¡®å®šè¦ç§»é™¤è¿™ä¸ªå€’è®¡æ—¶å—ï¼Ÿ')) {
            document.getElementById('reunion_date').value = '';
            // æäº¤è¡¨å•
            document.querySelector('#reunionModal form').submit();
        }
    }

</script>
</body>
</html>