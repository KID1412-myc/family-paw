<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- è§†å£è®¾ç½®ï¼šé€‚é…ç§»åŠ¨ç«¯ï¼Œç¦æ­¢ç¼©æ”¾ï¼Œè¦†ç›–åˆ˜æµ·å± -->
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">

    <title>å…¨å®¶ç‰µæŒ‚</title>

    <!-- PWA é…ç½® -->
    <link rel="manifest" href="/static/manifest.json?v={{ app_version }}">
    <link rel="apple-touch-icon" href="/static/icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å…¨å®¶ç‰µæŒ‚">
    <meta name="theme-color" content="#667eea">
    <meta name="format-detection" content="telephone=no">

    <!-- å¼•å…¥ Bootstrap 5 å’Œ FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- å¼•å…¥å›¾ç‰‡å‹ç¼©åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>

    <style>
        /* ================= å…¨å±€åŸºç¡€æ ·å¼ ================= */
        body {
            background-color: #f2f4f7;
            padding-bottom: 90px; /* ä¸ºåº•éƒ¨å¯¼èˆªæ ç•™å‡ºç©ºé—´ */
            -webkit-tap-highlight-color: transparent; /* å»é™¤ç§»åŠ¨ç«¯ç‚¹å‡»é«˜äº® */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        /* é¡¶éƒ¨æ¸å˜å¯¼èˆªæ  */
        .navbar-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 0 0 24px 24px;
            box-shadow: 0 4px 20px rgba(118, 75, 162, 0.25);
            /* é€‚é… iPhone åˆ˜æµ·å± */
            padding-top: max(15px, env(safe-area-inset-top));
        }

        /* é€šç”¨ç™½è‰²å¡ç‰‡å®¹å™¨ */
        .card-box {
            background: white;
            border-radius: 16px;
            border: none;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
            margin-bottom: 20px;
            overflow: hidden;
            position: relative;
            transition: transform 0.2s;
        }

        /* === æ‹Ÿç‰©åŒ–æ—¥å†å¡ç‰‡ === */
        .calendar-wrapper {
            position: relative;
            margin-bottom: 25px;
            padding-top: 10px; /* ç»™é‡‘å±ç¯ç•™ç©ºé—´ */
        }

        .calendar-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
            text-align: center;
        }

        /* æ—¥å†å¤´éƒ¨ (è£…è®¢æ¡) */
        .cal-header-bar {
            height: 40px;
            background: #ff7675; /* é»˜è®¤çº¢è‰² */
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.9);
            font-size: 12px;
            font-weight: bold;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        /* ä¸åŒçš„å¤´éƒ¨é¢œè‰² */
        .cal-header-warm {
            background: linear-gradient(135deg, #ff9a9e 0%, #ff6b6b 100%);
        }

        .cal-header-cool {
            background: linear-gradient(135deg, #a18cd1 0%, #bc93d1 100%);
        }

        .cal-header-empty {
            background: #b2bec3;
        }

        /* é‡‘å±ç¯ (ç”¨ä¼ªå…ƒç´ ç”»ä¸¤ä¸ªåœˆ) */
        .calendar-card::before, .calendar-card::after {
            content: '';
            position: absolute;
            top: -8px;
            width: 12px;
            height: 25px;
            background: #dfe6e9;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        .calendar-card::before {
            left: 20%;
        }

        .calendar-card::after {
            right: 20%;
        }

        /* æ—¥å†çº¸å¼ ä¸»ä½“ */
        .cal-body {
            padding: 20px;
            background-color: #fff;
            background-image: radial-gradient(#f0f0f0 1px, transparent 1px); /* çº¸å¼ çº¹ç† */
            background-size: 20px 20px;
        }

        /* å·¨å¤§çš„å€’æ•°æ•°å­— */
        .cal-number {
            font-size: 56px;
            font-weight: 900;
            color: #2d3436;
            line-height: 1;
            margin-bottom: 5px;
            font-family: 'Arial', sans-serif; /* ç”¨æ— è¡¬çº¿å­—ä½“æ›´ç°ä»£ */
        }

        .cal-label {
            font-size: 14px;
            color: #636e72;
            margin-bottom: 10px;
        }

        .cal-target-date {
            display: inline-block;
            background: #f1f2f6;
            color: #747d8c;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
        }

        /* [æ–°å¢] é¡¶éƒ¨è®¾ç½®å›¾æ ‡ */
        .cal-header-icon {
            position: absolute;
            right: 10px;
            top: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            padding: 0 5px;
            transition: color 0.2s;
        }

        .cal-header-icon:active {
            color: white;
        }

        /* [ä¿®æ”¹] è®©æ•´ä¸ªå¡ç‰‡éƒ½æœ‰ç‚¹å‡»æ„Ÿ */
        .calendar-card:active {
            transform: scale(0.98);
        }

        /* === æ–°ç‰ˆåŒåŸå¤©æ°”æ ·å¼ === */
        .weather-card {
            border-radius: 20px;
            overflow: hidden;
            color: white;
            margin-bottom: 24px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            background: white; /* åº•è‰² */
        }

        .weather-col {
            flex: 1;
            padding: 20px 15px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .weather-col:active {
            filter: brightness(0.95);
            transform: scale(0.98);
        }

        /* å·¦ä¾§ï¼šè€å®¶ (æš–é˜³æ©™) */
        .weather-home-bg {
            background: linear-gradient(160deg, #fad0c4 0%, #ffd1ff 100%);
            color: #555;
        }

        /* å³ä¾§ï¼šè¿œæ–¹ (æ¸…çˆ½è“) */
        .weather-away-bg {
            background: linear-gradient(160deg, #a1c4fd 0%, #c2e9fb 100%);
            color: #555;
        }

        /* å¸ƒå±€å¾®è°ƒ */
        .weather-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .weather-city {
            font-weight: bold;
            font-size: 15px;
            opacity: 0.8;
        }

        .weather-bell {
            font-size: 12px;
            background: rgba(255, 255, 255, 0.5);
            padding: 4px 8px;
            border-radius: 12px;
        }

        .weather-main {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .weather-temp {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -1px;
            line-height: 1;
        }

        .weather-icon {
            width: 48px;
            height: 48px;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
        }

        .weather-footer {
            margin-top: 10px;
            font-size: 11px;
            opacity: 0.8;
            display: flex;
            gap: 5px;
        }

        .weather-tag {
            background: rgba(255, 255, 255, 0.6);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* ç©ºçŠ¶æ€ */
        .weather-empty {
            background: #f8f9fa;
            color: #adb5bd;
            align-items: center;
            justify-content: center;
            padding: 30px;
            border: 2px dashed #e9ecef;
        }

        /* ================= èŒå® é¡µæ ·å¼ (Pets Tab) ================= */
        .pet-photo-wrapper {
            position: relative;
            height: 260px;
            background: #eee;
            overflow: hidden;
        }

        .pet-photo-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        /* ç‚¹å‡»å›¾ç‰‡å¾®åŠ¨æ•ˆ */
        .pet-photo-wrapper img:active {
            transform: scale(1.02);
        }

        /* ç…§ç‰‡å³ä¸‹è§’ä¸Šä¼ è€…æ ‡ç­¾ */
        .uploader-badge {
            position: absolute;
            bottom: 12px;
            right: 12px;
            background: rgba(0, 0, 0, 0.65);
            color: white;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 20px;
            backdrop-filter: blur(4px);
            pointer-events: none;
        }

        /* å³ä¸Šè§’åˆ é™¤æŒ‰é’® */
        .delete-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }

        .delete-btn:active {
            transform: scale(0.9);
        }

        /* çŠ¶æ€å¾½ç«  (å·²å–‚é£Ÿ/å¾…å–‚é£Ÿ) */
        .status-badge {
            font-size: 0.85rem;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 500;
        }

        /* è™šçº¿ä¸Šä¼ æŒ‰é’® */
        .btn-upload-dashed {
            border: 2px dashed #dee2e6;
            color: #6c757d;
            background: transparent;
            transition: all 0.2s;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        .btn-upload-dashed:active {
            background: #f8f9fa;
            border-color: #adb5bd;
        }

        /* ================= åŠ¨æ€é¡µæ ·å¼ (Life Tab) ================= */
        .moment-item {
            padding: 20px;
            border-bottom: 1px solid #f8f9fa;
        }

        .moment-item:last-child {
            border-bottom: none;
        }

        /* åŠ¨æ€å¤´éƒ¨: å¤´åƒ+åå­—+æ—¶é—´ */
        .moment-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .avatar-circle {
            width: 42px;
            height: 42px;
            background: #f0f2f5;
            color: #764ba2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
            font-size: 16px;
            flex-shrink: 0;
            overflow: hidden;
            border: 1px solid #eee;
        }

        .avatar-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .moment-user {
            font-weight: bold;
            color: #333;
            font-size: 15px;
            line-height: 1.2;
        }

        .moment-time {
            font-size: 12px;
            color: #999;
            margin-top: 3px;
        }

        .moment-content {
            font-size: 15px;
            color: #333;
            margin-bottom: 10px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .moment-img {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 12px;
            border: 1px solid #f0f0f0;
            cursor: pointer;
        }

        .moment-delete-btn {
            color: #dc3545;
            background: none;
            border: none;
            font-size: 14px;
            margin-left: auto;
            opacity: 0.6;
            padding: 8px;
        }

        .moment-delete-btn:active {
            opacity: 1;
        }

        /* ================= ä¸ªäººä¸­å¿ƒæ ·å¼ (Mine Tab) ================= */
        .my-avatar-container {
            position: relative;
            width: 90px;
            height: 90px;
            margin: 0 auto 15px;
        }

        .my-avatar {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            background: #eee;
        }

        .avatar-edit-icon {
            position: absolute;
            bottom: 0;
            right: 0;
            background: #764ba2;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* é‚€è¯·ç ç›’å­ */
        .invite-code-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            font-family: monospace;
            letter-spacing: 4px;
            font-weight: bold;
            font-size: 24px;
            border: 2px dashed #ccc;
            cursor: pointer;
            transition: 0.2s;
            color: #333;
            user-select: all;
        }

        .invite-code-box:active {
            background: #e9ecef;
            border-color: #adb5bd;
            transform: scale(0.98);
        }

        /* ================= åº•éƒ¨å¯¼èˆªæ  ================= */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            height: 70px;
            display: flex;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.03);
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #adb5bd;
            text-decoration: none;
            font-size: 11px;
            transition: 0.2s;
            padding-top: 5px;
        }

        .nav-item i {
            font-size: 22px;
            margin-bottom: 4px;
        }

        .nav-item.active {
            color: #764ba2;
            font-weight: 600;
        }

        .nav-item.active i {
            transform: scale(1.1);
        }

        /* ================= è¾…åŠ©ç»„ä»¶ ================= */
        .hidden-input {
            display: none;
        }

        .d-none {
            display: none !important;
        }

        .w-fit-content {
            width: fit-content;
        }

        /* å…¨å± Loading */
        #loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.85);
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        /* å›¾ç‰‡é¢„è§ˆåŒº */
        #preview-container {
            margin-bottom: 10px;
        }

        .remove-preview {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #333;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            text-align: center;
            line-height: 22px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            border: 2px solid white;
        }

        /* === è®¸æ„¿èœå• (å¤šå½©ç¥¨æ®é£) === */
        .wish-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .wish-card {
            background: white;
            border-radius: 16px;
            padding: 15px;
            position: relative;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            border: 2px solid transparent;
            transition: all 0.2s;
            overflow: hidden;
        }

        /* çŠ¶æ€ä¸€ï¼šæƒ³åƒ (çº¢è‰²ç³» - é¥¥é¥¿æ„Ÿ) */
        .wish-wanted {
            background: linear-gradient(145deg, #fff0f0 0%, #ffffff 100%);
            border-left: 6px solid #ff6b6b;
        }

        .wish-wanted .wish-status-btn {
            background: #ff6b6b;
            color: white;
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
        }

        /* çŠ¶æ€äºŒï¼šå·²ä¹°/åšé¥­ä¸­ (æ©™é»„è‰²ç³» - æœŸå¾…æ„Ÿ) */
        .wish-bought {
            background: linear-gradient(145deg, #fffcf0 0%, #ffffff 100%);
            border-left: 6px solid #feca57;
        }

        .wish-bought .wish-status-btn {
            background: #feca57;
            color: white;
            box-shadow: 0 4px 10px rgba(254, 202, 87, 0.3);
        }

        /* çŠ¶æ€ä¸‰ï¼šåƒåˆ°äº† (ç»¿è‰²/ç°è‰²ç³» - æ»¡è¶³æ„Ÿ) */
        .wish-eaten {
            background: #f8f9fa;
            border-left: 6px solid #b2bec3;
            opacity: 0.8;
        }

        .wish-eaten .wish-title {
            text-decoration: line-through;
            color: #999;
        }

        .wish-eaten .wish-stamp {
            position: absolute;
            right: 50px;
            top: 5px;
            border: 3px solid #1dd1a1;
            color: #1dd1a1;
            font-weight: 900;
            padding: 5px 10px;
            transform: rotate(-15deg);
            font-size: 14px;
            border-radius: 8px;
            opacity: 0.8;
            pointer-events: none; /* é˜²æ­¢æŒ¡ä½ç‚¹å‡» */
        }

        /* å¸ƒå±€å¾®è°ƒ */
        .wish-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .wish-title {
            font-size: 18px;
            font-weight: bold;
            color: #2d3436;
            margin-bottom: 4px;
        }

        .wish-meta {
            font-size: 11px;
            color: #b2bec3;
        }

        /* é‚£ä¸ªå¤§æŒ‰é’® */
        .wish-status-btn {
            border: none;
            border-radius: 20px;
            padding: 6px 16px;
            font-size: 13px;
            font-weight: bold;
            transition: transform 0.1s;
        }

        .wish-status-btn:active {
            transform: scale(0.95);
        }

        /* åƒåœ¾æ¡¶ (åšå°ä¸€ç‚¹ï¼Œè—åœ¨å³ä¸Šè§’) */
        .wish-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            color: #dfe6e9;
            background: none;
            border: none;
            font-size: 14px;
            transition: color 0.2s;
        }

        .wish-delete:active {
            color: #ff7675;
        }

        /* === å‡çº§ç‰ˆï¼šå®¶åº­å°å‰§åœº (å¸¦Qå¼¹ç‰¹æ•ˆ) === */
        /* === å‡çº§ç‰ˆï¼šæ¸©é¦¨å®¢å…é£æ ¼ === */
        /* === å‡çº§ç‰ˆï¼šæš–æš–çš„å°å±‹ === */
        .family-stage-card {
            /* æš–ç±³è‰²èƒŒæ™¯ï¼Œä¸å†æ˜¯æƒ¨ç™½ */
            background: #fffef9;
            /* åŠ ä¸Šå¾®å¾®çš„å†…å‘å…‰ */
            background-image: radial-gradient(circle at 50% 0%, #fffbf0 0%, #fffef9 100%);

            border-radius: 20px;
            padding: 15px 10px 12px 10px; /* åº•éƒ¨paddingå‡å°ï¼Œè´´è¿‘åœ°æ¿ */
            margin-bottom: 20px;

            /* æŠ•å½±åŠ æ·±ä¸€ç‚¹ï¼Œæ›´æœ‰ç«‹ä½“æ„Ÿ */
            box-shadow: 0 4px 15px rgba(139, 119, 101, 0.1);

            position: relative;
            overflow: hidden;
            border: 1px solid #fcf4e6; /* å¥¶èŒ¶è‰²è¾¹æ¡† */

            /* [æ ¸å¿ƒ] åœ°æ¿æ•ˆæœï¼šåŠ ç²—åº•éƒ¨è¾¹æ¡†ï¼Œç”¨æ·±æœ¨è‰² */
            border-bottom: 8px solid #ecdcb0;
        }

        /* æ°›å›´å…‰ä¿æŒä¸å˜ */
        .family-stage-card::before {
            content: '';
            position: absolute;
            top: -50px;
            right: -50px;
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, #ffeaa7 0%, transparent 70%);
            opacity: 0.6;
            pointer-events: none;
        }

        .stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px 10px 10px;
            border-bottom: 1px dashed #f0f0f0;
            margin-bottom: 15px;
        }

        .living-room {
            display: flex;
            align-items: flex-end; /* åƒååœ¨æ²™å‘ä¸Š */
            gap: 15px;
            overflow-x: auto;
            padding: 10px 5px;
            scrollbar-width: none;
        }

        .living-room::-webkit-scrollbar {
            display: none;
        }

        .member-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 68px;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s;
            /* é˜²æ­¢é•¿æŒ‰é€‰ä¸­æ–‡å­—å½±å“ä½“éªŒ */
            user-select: none;
            -webkit-user-select: none;
        }

        .member-item:active {
            transform: scale(0.95);
            filter: brightness(0.95);
        }

        /* å¤´åƒå®¹å™¨ */
        .head-wrapper {
            position: relative;
            margin-bottom: 8px;
            /* å…³é”®ï¼šç¡®ä¿åŠ¨ç”»ä¸ä¼šè¢«é®æŒ¡ */
            transform-origin: bottom center;
        }

        /* ğŸŸ¢ [è¶…çº§ç‰¹æ•ˆ] Qå¼¹è·³è·ƒåŠ¨ç”» */
        .shake-animation {
            animation: jelly-jump 0.6s;
        }

        @keyframes jelly-jump {
            0% {
                transform: scale(1, 1);
            }
            30% {
                transform: scale(1.25, 0.75);
            }
            /* è“„åŠ›å‹æ‰ */
            40% {
                transform: scale(0.75, 1.25) translateY(-15px);
            }
            /* å¼¹èµ·æ‹‰é•¿ */
            50% {
                transform: scale(1.15, 0.85) translateY(-5px);
            }
            /* å›è½ */
            65% {
                transform: scale(0.95, 1.05);
            }
            /* è½åœ°ç¼“å†² */
            75% {
                transform: scale(1.05, 0.95);
            }
            100% {
                transform: scale(1, 1);
            }
        }

        .member-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #fff;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            background: #f8f9fa;
        }

        /* â€œæˆ‘â€çš„é‡‘è‰²å…‰ç¯ */
        .is-me .member-avatar {
            border-color: #fff8dc;
            box-shadow: 0 0 0 2px #ffeaa7, 0 6px 15px rgba(253, 203, 110, 0.3);
        }

        /* çŠ¶æ€æ°”æ³¡ (å‘¼å¸åŠ¨ç”») */
        .status-bubble {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 26px;
            height: 26px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
            border: 2px solid white;
            z-index: 2;
            animation: floatBubble 3s ease-in-out infinite;
        }

        /* åå­—èƒ¶å›Š */
        .member-name {
            font-size: 11px;
            color: #666;
            background: #f1f3f5;
            padding: 3px 10px;
            border-radius: 12px;
            font-weight: bold;
            max-width: 80px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .is-me .member-name {
            background: #fff3cd;
            color: #d35400;
        }

        /* é‚€è¯·æŒ‰é’® */
        .invite-btn {
            font-size: 12px;
            color: #999;
            border: 1px dashed #ddd;
            padding: 4px 10px;
            border-radius: 20px;
            cursor: pointer;
            background: #fcfcfc;
        }

        .invite-btn:active {
            background: #eee;
        }

        @keyframes floatBubble {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-4px);
            }
        }

        /* === å®¶åº­ç­›é€‰æ¡ === */
        .family-filter-bar {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 5px 2px 15px 2px;
            margin-bottom: 5px;
            scrollbar-width: none;
        }

        .family-filter-bar::-webkit-scrollbar {
            display: none;
        }

        .filter-btn {
            white-space: nowrap;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            border: 1px solid #eee;
            background: white;
            color: #666;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
        }

        /* é€‰ä¸­çŠ¶æ€ */
        .filter-btn.active {
            background: #667eea; /* ä¸»é¢˜è‰² */
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
            transform: scale(1.05);
        }

        /* =========================================
           ğŸ‘´ é•¿è¾ˆå…³æ€€æ¨¡å¼ (Elder Mode) æ ¸å¿ƒè¡¥ä¸
           ========================================= */
        body.elder-mode {
            /* 1. å…¨å±€å­—å·æš´åŠ›æå‡ */
            font-size: 18px !important;
        }

        body.elder-mode .small,
        body.elder-mode small,
        body.elder-mode .text-muted {
            /* è®©è¾…åŠ©æ–‡å­—å˜å¤§ã€å˜æ·± */
            font-size: 16px !important;
            color: #333 !important; /* æ‹’ç»æµ…ç°ï¼Œæ”¹ç”¨æ·±ç° */
            opacity: 1 !important; /* æ‹’ç»åŠé€æ˜ */
        }

        body.elder-mode h5,
        body.elder-mode .fw-bold {
            font-size: 20px !important;
            font-weight: 900 !important; /* è¶…ç²—ä½“ */
        }

        /* 2. å¡ç‰‡å¢å¼º */
        body.elder-mode .card-box,
        body.elder-mode .calendar-card,
        body.elder-mode .weather-card {
            border: 2px solid #000 !important; /* åŠ é»‘è¾¹æ¡†ï¼Œè½®å»“æ›´æ¸…æ™° */
            box-shadow: none !important; /* å»æ‰é˜´å½±ï¼Œå‡å°‘è§†è§‰å¹²æ‰° */
        }

        /* 3. åŒåŸå¤©æ°”ï¼šå¼ºåˆ¶å˜æˆä¸Šä¸‹æ’åˆ— */
        body.elder-mode .weather-card {
            flex-direction: column !important;
        }

        body.elder-mode .weather-col {
            border-bottom: 1px solid #ccc;
            padding: 25px !important;
        }

        body.elder-mode .weather-temp {
            font-size: 48px !important; /* æ¸©åº¦å·¨æ— éœ¸ */
            color: #000 !important;
        }

        /* 4. å€’è®¡æ—¶æ•°å­— */
        body.elder-mode .cal-number {
            font-size: 80px !important;
            color: #d63031 !important;
        }

        /* 5. æŒ‰é’®æ”¾å¤§ */
        body.elder-mode .btn,
        body.elder-mode .nav-item {
            font-size: 18px !important;
            padding: 12px !important;
        }

        /* 6. åº•éƒ¨å¯¼èˆªæ  */
        body.elder-mode .bottom-nav {
            height: 80px !important;
        }

        body.elder-mode .nav-item i {
            font-size: 30px !important;
        }

        /* 7. éšè—ä¸éœ€è¦çš„å…ƒç´  (æ¯”å¦‚ç¼–è¾‘æŒ‰é’®) */
        /* é•¿è¾ˆé€šå¸¸åªéœ€è¦çœ‹ï¼Œä¸éœ€è¦æ”¹ */
        body.elder-mode .cal-header-icon,
        body.elder-mode .btn-link .fa-cog {
            display: none !important;
        }

        /* === ğŸ§˜â€â™‚ï¸ èµ›åšæœ¨é±¼å½©è›‹æ ·å¼ === */
        #zen-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            touch-action: manipulation; /* é˜²æ­¢åŒå‡»æ”¾å¤§ */
        }

        .muyu-icon {
            font-size: 120px;
            cursor: pointer;
            transition: transform 0.1s;
            filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.2));

            /* [æ ¸å¿ƒ] iOS å®Œç¾é€‚é… */
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .muyu-icon:active {
            transform: scale(0.9);
        }

        .merit-counter {
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 24px;
            margin-top: 30px;
            opacity: 0.8;
        }

        /* é£˜å­—åŠ¨ç”» */
        .float-text {
            position: absolute;
            color: #ffd700;
            font-weight: bold;
            font-size: 20px;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(1.5);
                opacity: 0;
            }
        }

        /* é€€å‡ºæŒ‰é’® */
        .zen-close {
            position: absolute;
            top: 40px;
            right: 30px;
            color: #555;
            font-size: 30px;
            cursor: pointer;
        }

        /* ç‚¹èµæŒ‰é’®åŠ¨ç”» */
        .like-btn {
            background: none;
            border: none;
            padding: 5px 10px;
            display: flex;
            align-items: center;
            gap: 5px;
            color: #888;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .like-btn:active {
            transform: scale(1.2);
        }

        /* å·²ç‚¹èµçŠ¶æ€ (çº¢è‰²) */
        .like-btn.liked {
            color: #ff6b6b;
        }

        .like-btn.liked i {
            font-weight: 900;
        }

        /* å®å¿ƒå¿ƒ */
        /* æœ‹å‹åœˆé£æ ¼çš„ç‚¹èµæ¡† */
        .likes-area {
            background: #f7f7f7;
            border-radius: 8px;
            padding: 8px 10px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #555;
            position: relative;
        }

        /* é‚£ä¸ªæŒ‡å‘ä¸Šé¢æ“ä½œæ çš„å°ä¸‰è§’ */
        .likes-area::before {
            content: '';
            position: absolute;
            top: -6px;
            left: 20px;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 6px solid #f7f7f7;
        }

        .like-heart-icon {
            color: #576b95;
            margin-top: 2px;
            align-self: flex-start;
        }

        .liker-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .liker-avatar {
            width: 24px;
            height: 24px;
            border-radius: 4px; /* å¾®ä¿¡é£æ ¼æ˜¯åœ†è§’çŸ©å½¢ */
            object-fit: cover;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .liker-name {
            display: none;
        }

        /* æ—¢ç„¶çœ‹å¤´åƒå°±ä¸æ˜¾ç¤ºåå­—äº†ï¼Œçœç©ºé—´ */
        /* === ğŸ¡ å¹¸è¿å¤§è½¬ç›˜ (è±ªåç‰ˆ) === */
        .wheel-wrapper {
            position: relative;
            width: 320px;
            height: 320px;
            margin: 0 auto 20px auto;
            /* å¤–å±‚åº•åº§ï¼šçº¢è‰²å¸¦é˜´å½± */
            background: #e55039;
            border-radius: 50%;
            padding: 10px;
            box-shadow: 0 10px 0 #c0392b, 0 15px 20px rgba(0, 0, 0, 0.2);
            /* è£…é¥°ç¯åœˆ (ç”¨è™šçº¿æ¨¡æ‹Ÿ) */
            border: 4px dashed #f6b93b;
        }

        .wheel-container {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
            position: relative;
            border: 4px solid #fff; /* å†…åœˆç™½è¾¹ */
            box-sizing: border-box;
        }

        #wheel-canvas {
            width: 100%;
            height: 100%;
            transform: rotate(0deg);
            transition: transform 4s cubic-bezier(0.15, 0.9, 0.35, 1.05); /* æ›´æœ‰å¼¹æ€§çš„åˆ¹è½¦ */
        }

        /* é¡¶éƒ¨æŒ‡é’ˆ (æ”¹ä¸ºæ·±ç°è‰²é‡‘å±è´¨æ„Ÿ) */
        .wheel-pointer {
            position: absolute;
            top: -20px; /* ç¨å¾®è°ƒä½ä¸€ç‚¹ */
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            width: 36px; /* ç¨å¾®ç˜¦ä¸€ç‚¹æ›´ç²¾è‡´ */
            height: 50px;
            background: #2d3436; /* [ä¿®æ”¹] æ·±æªç°è‰²ï¼Œç™¾æ­ä¸”é«˜çº§ */
            clip-path: polygon(50% 100%, 0 0, 100% 0); /* å€’ä¸‰è§’ */
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.5)); /* é˜´å½±åŠ é‡ï¼Œæ›´ç«‹ä½“ */
        }

        /* æŒ‡é’ˆä¸­å¿ƒç‚¹ (æ”¹ä¸ºé“¶è‰²é“†é’‰) */
        .wheel-pointer::after {
            content: '';
            position: absolute;
            top: 6px; left: 50%;
            transform: translateX(-50%);
            width: 14px; height: 14px;
            background: #dfe6e9; /* [ä¿®æ”¹] é“¶ç™½è‰² */
            border-radius: 50%;
            box-shadow: inset 0 -2px 2px rgba(0,0,0,0.1); /* å¾®å¼±çš„å†…é˜´å½± */
        }
        /* ä¸­å¿ƒæŒ‰é’® GO */
        .wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background: radial-gradient(circle at 30% 30%, #fff, #f1c40f);
            border-radius: 50%;
            border: 4px solid #fff;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 900;
            color: #e67e22;
            cursor: pointer;
            user-select: none;
        }

        .wheel-center:active {
            transform: translate(-50%, -50%) scale(0.95);
        }

        /* === é¡¶éƒ¨æ“ä½œåŒºæç®€é£ === */

        /* 1. å¤§è½¬ç›˜å›¾æ ‡æŒ‰é’® */
        .btn-icon-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s;
            border: none;
            background: linear-gradient(135deg, #ff9f43 0%, #ff6b6b 100%); /* æ´»åŠ›æ©™çº¢ */
            color: white;
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
        }

        .btn-icon-circle:active {
            transform: scale(0.9);
        }

        /* 2. é‚€è¯·ç èƒ¶å›Š */
        .code-pill {
            display: flex;
            align-items: center;
            background: #f1f2f6;
            color: #747d8c;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-family: monospace; /* ç­‰å®½å­—ä½“æ›´åƒéªŒè¯ç  */
            cursor: pointer;
            border: 1px solid #e1e2e6; /* å®çº¿è¾¹æ¡†ï¼Œä¸å†æ˜¯è™šçº¿ */
        }

        .code-pill i {
            font-size: 10px;
            margin-right: 4px;
            opacity: 0.7;
        }

        .code-pill:active {
            background: #eccc68;
            color: white;
            border-color: #eccc68;
        }
    </style>
    <!-- [æ–°å¢] æ”¾åœ¨ <head> é‡Œ -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- ECharts æ ¸å¿ƒ -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- ä¸­å›½åœ°å›¾æ•°æ® (è¿™ä¸ªCDNæ¯”è¾ƒç¨³) -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@4.9.0/map/js/china.js"></script>
</head>
<body class="{% if my_profile.is_elder_mode %}elder-mode{% endif %}">

<!-- å…¨å±åŠ è½½åŠ¨ç”» -->
<!-- [å…¨èƒ½åŠ è½½å±‚] å¼€æœº + æ•°æ®å¤„ç†éƒ½ç”¨å®ƒ -->
<div id="global-loader"
     style="display:flex; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:99999; flex-direction:column; align-items:center; justify-content:center; transition:opacity 0.3s;">
    <!-- å¿ƒè·³åŠ¨ç”» -->
    <div style="font-size:48px; animation: heartbeat 1.2s infinite ease-in-out;">â¤ï¸</div>
    <!-- æ–‡å­—æç¤º -->
    <div style="color:#999; font-size:12px; margin-top:15px; letter-spacing:2px; font-weight:bold;">
        å…¨å®¶ç‰µæŒ‚
    </div>
</div>

<!-- é…å¥— CSS -->
<style>
    @keyframes heartbeat {
        0% {
            transform: scale(1);
        }
        15% {
            transform: scale(1.25);
        }
        /* å™— */
        30% {
            transform: scale(1);
        }
        /* é€š */
        45% {
            transform: scale(1.15);
        }
        /* å™— */
        60% {
            transform: scale(1);
        }
        /* é€š */
        100% {
            transform: scale(1);
        }
        /* (ä¼‘æ¯) */
    }
</style>

<!-- é¡¶éƒ¨å¯¼èˆªæ  -->
<div class="navbar-custom">
    <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-3">
            <div>
                <h5 class="mb-0 fw-bold">
                    {% if current_tab == 'mine' %}ä¸ªäººä¸­å¿ƒ{% else %}ğŸ‘‹ å—¨ï¼Œ{{ user_name }}{% endif %}
                </h5>
                {% if current_tab != 'mine' %}
                    <small style="opacity: 0.8; font-size: 0.85rem;">ğŸ“… {{ today }}</small>
                {% endif %}
            </div>

            {% if current_role == 'admin' or session.get('is_impersonator') %}
                <a href="/admin"
                   class="text-white bg-white bg-opacity-25 rounded-circle d-flex align-items-center justify-content-center shadow-sm"
                   style="width: 34px; height: 34px; text-decoration: none;" title="å›åˆ°ç®¡ç†åå°">
                    <i class="fas fa-cogs"></i>
                </a>
            {% endif %}
        </div>

        {% if current_tab != 'mine' %}
            <a href="/logout" class="text-white opacity-75 p-2"><i class="fas fa-sign-out-alt fa-lg"></i></a>
        {% endif %}
    </div>
</div>

<div class="container mt-3">

    <!-- Flash æ¶ˆæ¯æç¤ºåŒº -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm border-0 mb-3"
                     role="alert">
                    <i class="fas fa-info-circle me-1"></i> {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    <!-- [æ–°å¢] å®¶åº­ç­›é€‰æ¡ -->
    {% if my_families|length > 1 %} <!-- åªæœ‰ä¸€ä¸ªå®¶å°±ä¸æ˜¾ç¤ºæ¡äº† -->
        <div class="family-filter-bar">
            <!-- ç»™"å…¨éƒ¨"æŒ‰é’®åŠ  id -->
            <button id="filter-btn-all" class="filter-btn active" onclick="filterFamily('all', this)">ğŸ  å…¨éƒ¨</button>

            {% for f in my_families %}
                <!-- ç»™æ¯ä¸ªå®¶åº­æŒ‰é’®åŠ  id="filter-btn-å®¶åº­ID" -->
                <button id="filter-btn-{{ f.id }}" class="filter-btn"
                        onclick="filterFamily('{{ f.id }}', this)">{{ f.name }}</button>
            {% endfor %}
        </div>
    {% endif %}
    <!-- ================= å®¶åº­å®¢å… (å‡çº§ç‰ˆ) ================= -->
    {% if my_families %}
        {% for fam in my_families %}
            <div class="family-stage-card fam-item fam-{{ fam.id }}">
                <!-- é¡¶éƒ¨ï¼šå®¶åº­å + æç®€åŠŸèƒ½åŒº -->
                <div class="stage-header">
                    <!-- å·¦ä¾§ï¼šå®¶åº­å -->
                    <div class="fw-bold text-dark d-flex align-items-center text-truncate" style="max-width: 55%;">
                        <i class="fas fa-home text-warning me-2"></i>{{ fam.name }}
                    </div>

                    <!-- å³ä¾§ï¼šå›¾æ ‡ + éªŒè¯ç  -->
                    <div class="d-flex align-items-center gap-2">
                        <!-- [æ–°å¢] è¶³è¿¹åœ°å›¾å…¥å£ -->

                        <div class="btn-icon-circle"
                             style="background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); box-shadow: 0 4px 10px rgba(161, 140, 209, 0.3);"
                             onclick='openMapModal("{{ fam.id }}",
                                     "{{ fam.location_home_name or "" }}", {{ fam.location_home_lat or 0 }}, {{ fam.location_home_lon or 0 }},
                                     "{{ fam.location_away_name or "" }}", {{ fam.location_away_lat or 0 }}, {{ fam.location_away_lon or 0 }},
                                     {{ fam.footprints | tojson | safe }})'>
                            <i class="fas fa-map-marked-alt"></i>
                        </div>
                        <!-- [ä¿®æ”¹] å¤§è½¬ç›˜ (åœ†å½¢å›¾æ ‡) -->
                        <div class="btn-icon-circle" onclick="openWheelModal('{{ fam.id }}')">
                            <i class="fas fa-dharmachakra fa-lg"></i> <!-- æˆ–è€…ç”¨ fa-dice -->
                        </div>
                        <!-- [ä¿®æ”¹] é‚€è¯·ç  (èƒ¶å›Šæ ·å¼) -->
                        <div class="code-pill" onclick="copyCode(this)" title="ç‚¹å‡»å¤åˆ¶">
                            <i class="fas fa-key"></i>{{ fam.invite_code }}
                        </div>

                    </div>
                </div>

                <!-- æˆå‘˜åº§ä½å¸­ -->
                <div class="living-room">

                    {% if family_members_dict[fam.id] %}
                        {% for uid in family_members_dict[fam.id] %}
                            {% if user_map[uid] %}
                                <div class="member-item {% if uid == current_user_id %}is-me{% endif %}"
                                     onclick="handleMemberClick('{{ uid }}', '{{ user_map[uid].name }}', '{{ fam.id }}')">

                                    <div class="head-wrapper" id="head-{{ fam.id }}-{{ uid }}">
                                        <!-- å¤´åƒ -->
                                        {% if user_map[uid].avatar %}
                                            <img src="{{ user_map[uid].avatar }}" class="member-avatar">
                                        {% else %}
                                            <div class="member-avatar d-flex align-items-center justify-content-center bg-light text-secondary fw-bold fs-4">
                                                {{ user_map[uid].name[0] }}
                                            </div>
                                        {% endif %}

                                        <!-- çŠ¶æ€æ°”æ³¡ (æ ¹æ® status æ˜¾ç¤ºä¸åŒ Emoji) -->
                                        <div class="status-bubble">
                                            {% if user_map[uid].status == 'busy' %}ğŸ“š
                                            {% elif user_map[uid].status == 'sleep' %}ğŸ˜´
                                            {% elif user_map[uid].status == 'food' %}ğŸ˜‹
                                            {% elif user_map[uid].status == 'game' %}ğŸ®
                                            {% else %}ğŸŒ{% endif %}
                                        </div>
                                    </div>

                                    <!-- åå­— -->
                                    <div class="member-name">
                                        {{ 'æˆ‘' if uid == current_user_id else user_map[uid].name }}
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}

                    <!-- [æ–°å¢] æœ€åä¸€ä¸ªè™šçº¿åœˆåœˆï¼Œæ–¹ä¾¿ç›´æ¥åŠ äºº -->
                    <div class="member-item"
                         onclick="copyCode(this.parentNode.previousElementSibling.querySelector('.invite-btn'))">
                        <div class="head-wrapper">
                            <div class="member-avatar d-flex align-items-center justify-content-center"
                                 style="border: 2px dashed #ddd; box-shadow: none;">
                                <i class="fas fa-plus text-muted"></i>
                            </div>
                        </div>
                        <div class="member-name" style="background:transparent; color:#aaa;">é‚€è¯·</div>
                    </div>

                </div>
            </div>
        {% endfor %}
    {% endif %}
    <!-- ================= å®¶åº­ç•™è¨€æ¿ (24å°æ—¶è‡ªåŠ¨è¿‡æœŸ) ================= -->
    {% if my_families %}
        {% for fam in my_families %}
            {% if fam.reminders %}
                <div class="mb-3 fam-item fam-{{ fam.id }}">
                    {% for rem in fam.reminders %}
                        <div class="alert shadow-sm border-0 rounded-4 d-flex align-items-start mb-2 fade show"
                             id="reminder-box-{{ rem.id }}"
                             role="alert"
                             style="background: #fff8e1; color: #856404;">

                            <!-- å¤´åƒæˆ–é“ƒé“› -->
                            <div class="me-2 fs-5">ğŸ””</div>

                            <div class="w-100">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold small text-uppercase" style="opacity: 0.7;">
                                        {{ rem.sender_name }}
                                        <span class="fw-normal mx-1">Â·</span>
                                        {{ fam.name }}
                                    </span>
                                    <!-- æ˜¾ç¤ºå¤§æ¦‚æ—¶é—´ -->
                                    <span class="small" style="opacity: 0.5; font-size: 10px;">
                                        {{ rem.time_display }}
                                    </span>
                                </div>
                                <div class="fw-bold mt-1" style="font-size: 14px;">
                                    {{ rem.content }}
                                </div>
                            </div>

                            <!-- å…³é—­æŒ‰é’® (å‰ç«¯å‡å…³é—­ï¼Œåˆ·æ–°è¿˜åœ¨ï¼Œé™¤éè¿‡äº†24å°æ—¶) -->
                            <button type="button" class="btn-close btn-sm ms-2"
                                    onclick="dismissReminder('{{ rem.id }}')"
                                    data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endfor %}
    {% endif %}

    <!-- ================= Tab: èŒå®  ================= -->
    <div id="tab-pets" class="{% if current_tab != 'pets' %}d-none{% endif %}">


        {% if my_families %}
            {% for fam in my_families %}
                <!-- ================= å…¨èƒ½æ—¶é—´å¡ç‰‡ (ä¿®å¤ç‚¹å‡» + ä¼˜åŒ–UI) ================= -->
                <div class="calendar-card fam-item fam-{{ fam.id }}">

                    {% if fam.top_event %}
                        {% set days = fam.top_event.data.days %}

                        <!-- 1. å¤´éƒ¨è£…è®¢æ¡ (é€»è¾‘å‡çº§) -->
                        <!-- å°äº0(è¿‡æœŸ): ç° | 0-30(ä¸´è¿‘): çº¢ | å¤§äº30(è¿œ): è“ -->
                        <div class="cal-header-bar {% if days < 0 %}cal-header-empty{% elif days <= 30 %}cal-header-warm{% else %}cal-header-cool{% endif %}">
                            <!-- æ ‡é¢˜ -->
                            <span>
                                    {{ fam.top_event.title }}
                                {% if fam.top_event.is_lunar %}<span class="badge bg-white text-danger ms-1"
                                                                     style="font-size:9px; padding:1px 3px;">å†œ</span>{% endif %}
                                </span>

                            <!-- å³ä¸Šè§’åˆ—è¡¨æŒ‰é’® -->
                            <div class="cal-header-icon"
                                 onclick='event.stopPropagation(); openEventListModal("{{ fam.id }}", {{ fam.all_events | tojson }})'>
                                <i class="fas fa-list-ul"></i>
                            </div>
                        </div>

                        <!-- 2. çº¸å¼ å†…å®¹ -->
                        <div class="cal-body"
                             onclick='openEventListModal("{{ fam.id }}", {{ fam.all_events | tojson }})'>

                            {% if days == 0 %}
                                <!-- ä»Šå¤© -->
                                <div class="cal-number text-success" style="font-size: 40px;">ğŸ‰</div>
                                <div class="cal-label fw-bold text-success">å°±æ˜¯ä»Šå¤©ï¼</div>

                            {% elif days > 0 %}
                                <!-- æœªæ¥ -->
                                <div class="cal-number {{ 'text-danger' if days <= 7 else 'text-dark' }}">
                                    {{ days }}
                                </div>
                                <div class="cal-label">å¤©å</div>

                            {% else %}
                                <!-- [ä¿®å¤] è¿‡å» (å˜æˆç°è‰²ï¼Œä¸”å–ç»å¯¹å€¼) -->
                                <div class="cal-number text-muted" style="opacity: 0.5;">
                                    {{ days | abs }}
                                </div>
                                <div class="cal-label text-muted">å¤©å‰ (å·²ç»“æŸ)</div>
                            {% endif %}

                            <div class="cal-target-date d-flex flex-column gap-1">
                                <span>ç›®æ ‡: {{ fam.top_event.data.date_str }}</span>

                                {% if fam.top_event.data.is_repeat and fam.top_event.data.total > 0 %}
                                    <span class="text-primary"
                                          style="font-size: 10px; border-top: 1px dashed #eee; padding-top: 2px;">
                                        å·²ç›¸ä¼´ {{ fam.top_event.data.total }} å¤© â¤ï¸
                                    </span>
                                {% endif %}
                            </div>
                        </div>

                    {% else %}
                        <!-- B. ç©ºçŠ¶æ€ (å¼•å¯¼æ·»åŠ ) -->
                        <div class="cal-header-bar cal-header-empty">å®¶åº­å¤§äº‹è®°</div>
                        <div class="cal-body" onclick="openAddEventModal('{{ fam.id }}')">
                            <div class="py-3">
                                <i class="fas fa-calendar-plus fa-3x text-muted opacity-25 mb-2"></i>
                                <div class="text-muted small">æ·»åŠ ç”Ÿæ—¥ / çºªå¿µæ—¥</div>
                            </div>
                        </div>
                    {% endif %}
                </div>
                <!-- ================= åŒåŸå¤©æ°”å¡ç‰‡ (æœ¬åœ°å›¾æ ‡ä¿®æ­£ç‰ˆ) ================= -->
                <div class="weather-card fam-item fam-{{ fam.id }}">

                    <!-- å·¦ä¾§ï¼šè€å®¶ -->
                    {% if fam.weather_home %}
                        <div class="weather-col weather-home-bg"
                             onclick="sendReminder('{{ fam.id }}', '{{ fam.location_home_name }}',
                                     '{{ fam.weather_home.now.text }}',
                                     '{{ fam.weather_home.now.temp }}',
                                     '{{ fam.weather_home.indices['3'].text if fam.weather_home.indices else '' }}',
                                     '{{ fam.weather_home.air.category if fam.weather_home.air else '' }}')">

                            <button class="btn btn-sm btn-light bg-white bg-opacity-50 border-0 position-absolute top-0 end-0 m-2 rounded-circle d-flex align-items-center justify-content-center shadow-sm"
                                    style="width:28px;height:28px;z-index:10;"
                                    onclick="event.stopPropagation(); openWeatherModal('{{ fam.id }}', 'home', '{{ fam.location_home_name }}')">
                                <i class="fas fa-cog text-secondary" style="font-size: 12px;"></i>
                            </button>

                            <div class="weather-header mb-2">
                                <div class="d-flex align-items-center">
                                    <span class="weather-city me-2"><i
                                            class="fas fa-home me-1"></i>{{ fam.location_home_name }}</span>
                                    <span class="badge bg-white bg-opacity-50 text-dark border-0 rounded-pill fw-normal"
                                          style="font-size: 10px; transform: scale(0.9);">
                                    <i class="fas fa-bell text-danger"></i> æé†’
                                </span>
                                </div>
                            </div>

                            <div class="weather-main">
                                <div class="weather-temp">{{ fam.weather_home.now.temp }}Â°</div>
                                <!-- [ä¿®æ”¹] ä½¿ç”¨æœ¬åœ° static/weather å›¾æ ‡ -->
                                <img src="/static/weather/{{ fam.weather_home.now.icon }}.svg" class="weather-icon">
                            </div>

                            <div class="weather-footer">
                                <span class="weather-tag">{{ fam.weather_home.now.text }}</span>
                                <!-- [ä¿®æ”¹] å»æ‰äº† 'è¡£:' å‰ç¼€ï¼Œç›´æ¥æ˜¾ç¤º 'è¾ƒå†·' -->
                                {% if fam.weather_home.indices and fam.weather_home.indices['3'] %}
                                    <span class="weather-tag">{{ fam.weather_home.indices['3'].category }}</span>
                                {% endif %}
                                <!-- ç©ºæ°”è´¨é‡ -->
                                {% if fam.weather_home.air %}
                                    <span class="weather-tag"
                                          style="{{ 'background:#ffc107;color:#000;' if 'æ±¡æŸ“' in fam.weather_home.air.category else '' }}">
                                ç©ºæ°”{{ fam.weather_home.air.category }}
                            </span>
                                {% endif %}
                            </div>
                        </div>
                    {% else %}
                        <div class="weather-col weather-empty" onclick="openWeatherModal('{{ fam.id }}', 'home', '')">
                            <i class="fas fa-plus-circle fa-2x mb-2 opacity-50"></i>
                            <small>è®¾ç½®è€å®¶</small>
                        </div>
                    {% endif %}

                    <!-- å³ä¾§ï¼šè¿œæ–¹ -->
                    {% if fam.weather_away %}
                        <div class="weather-col weather-away-bg"
                             onclick="sendReminder('{{ fam.id }}', '{{ fam.location_away_name }}',
                                     '{{ fam.weather_away.now.text }}',
                                     '{{ fam.weather_away.now.temp }}',
                                     '{{ fam.weather_away.indices['3'].text if fam.weather_away.indices else '' }}',
                                     '{{ fam.weather_away.air.category if fam.weather_away.air else '' }}')">

                            <button class="btn btn-sm btn-light bg-white bg-opacity-50 border-0 position-absolute top-0 end-0 m-2 rounded-circle d-flex align-items-center justify-content-center shadow-sm"
                                    style="width:28px;height:28px;z-index:10;"
                                    onclick="event.stopPropagation(); openWeatherModal('{{ fam.id }}', 'away', '{{ fam.location_away_name }}')">
                                <i class="fas fa-cog text-secondary" style="font-size: 12px;"></i>
                            </button>

                            <div class="weather-header mb-2">
                                <div class="d-flex align-items-center">
                                    <span class="weather-city me-2"><i
                                            class="fas fa-plane me-1"></i>{{ fam.location_away_name }}</span>
                                    <span class="badge bg-white bg-opacity-50 text-dark border-0 rounded-pill fw-normal"
                                          style="font-size: 10px; transform: scale(0.9);">
                                    <i class="fas fa-bell text-primary"></i> æé†’
                                </span>
                                </div>
                            </div>

                            <div class="weather-main">
                                <div class="weather-temp">{{ fam.weather_away.now.temp }}Â°</div>
                                <!-- [ä¿®æ”¹] ä½¿ç”¨æœ¬åœ° static/weather å›¾æ ‡ -->
                                <img src="/static/weather/{{ fam.weather_away.now.icon }}.svg" class="weather-icon">
                            </div>

                            <div class="weather-footer">
                                <span class="weather-tag">{{ fam.weather_away.now.text }}</span>
                                {% if fam.weather_away.indices and fam.weather_away.indices['3'] %}
                                    <span class="weather-tag">{{ fam.weather_away.indices['3'].category }}</span>
                                {% endif %}
                                {% if fam.weather_away.air %}
                                    <span class="weather-tag"
                                          style="{{ 'background:#ffc107;color:#000;' if 'æ±¡æŸ“' in fam.weather_away.air.category else '' }}">
                                ç©ºæ°”{{ fam.weather_away.air.category }}
                            </span>
                                {% endif %}
                            </div>
                        </div>
                    {% else %}
                        <div class="weather-col weather-empty" onclick="openWeatherModal('{{ fam.id }}', 'away', '')">
                            <i class="fas fa-plus-circle fa-2x mb-2 opacity-50"></i>
                            <small>è®¾ç½®æˆ‘çš„åŸå¸‚</small>
                        </div>
                    {% endif %}
                </div>
                <!-- ================= è®¸æ„¿èœå• (å‡çº§ç‰ˆ) ================= -->
                <div class="card-box mb-4 p-3 fam-item fam-{{ fam.id }}">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0 fw-bold d-flex align-items-center">
                            <span style="font-size: 20px; margin-right: 8px;">ğŸ±</span> è®¸æ„¿èœå•
                        </h6>
                        <button class="btn btn-sm btn-warning rounded-pill px-3 text-white fw-bold shadow-sm"
                                onclick="openWishModal('{{ fam.id }}')">
                            <i class="fas fa-plus"></i> æˆ‘æƒ³åƒ
                        </button>
                    </div>

                    {% if fam.wishes %}
                        <div class="wish-container">
                            {% for dish in fam.wishes %}
                                <div class="wish-card status-{{ dish.status }} {% if dish.status == 'wanted' %}wish-wanted{% elif dish.status == 'bought' %}wish-bought{% else %}wish-eaten{% endif %}">

                                    <!-- å³ä¸Šè§’åˆ é™¤æŒ‰é’® (é˜²è¯¯è§¦) -->
                                    <form action="/operate_wish" method="POST" class="d-inline"
                                          onsubmit="return confirm('è¦æŠŠè¿™é“èœä»èœå•ä¸Šåˆ’æ‰å—ï¼Ÿ')">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <input type="hidden" name="wish_id" value="{{ dish.id }}">
                                        <input type="hidden" name="action" value="delete">
                                        <button class="wish-delete"><i class="fas fa-times"></i></button>
                                    </form>

                                    <!-- å°ç«  (ä»…åƒå®Œæ˜¾ç¤º) -->
                                    {% if dish.status == 'eaten' %}
                                        <div class="wish-stamp">å¥½åƒ!</div>
                                    {% endif %}

                                    <div class="wish-content">
                                        <div>
                                            <div class="wish-title">{{ dish.content }}</div>
                                            <div class="wish-meta">
                                                <!-- æ ¹æ®çŠ¶æ€æ˜¾ç¤ºä¸åŒçš„æ–‡æ¡ˆ -->
                                                {% if dish.status == 'wanted' %}
                                                    ğŸ¤¤ è°æ¥æ¥å•ï¼Ÿ
                                                {% elif dish.status == 'bought' %}
                                                    ğŸ³ å¤‡èœä¸­...
                                                {% else %}
                                                    ğŸ˜‹ è‚šå­åœ†åœ†
                                                {% endif %}
                                            </div>
                                        </div>

                                        <!-- æ ¸å¿ƒäº¤äº’æŒ‰é’® -->
                                        <button class="wish-status-btn"
                                                onclick="changeWishStatus('{{ dish.id }}', '{{ dish.status }}')">
                                            {% if dish.status == 'wanted' %}
                                                ğŸ‘¨â€ğŸ³ çˆ¸å¦ˆæ¥å•
                                            {% elif dish.status == 'bought' %}
                                                ğŸ¥¢ å¼€é¥­å•¦
                                            {% else %}
                                                ğŸ”„ å†æ¥ä¸€é¡¿
                                            {% endif %}
                                        </button>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <!-- ç©ºçŠ¶æ€ï¼šFlex å®Œç¾å±…ä¸­ -->
                        <div class="d-flex flex-column align-items-center justify-content-center py-4"
                             onclick="openWishModal('{{ fam.id }}')"
                             style="cursor: pointer; background: #f9f9f9; border-radius: 12px; border: 2px dashed #eee; min-height: 160px;">

                            <div style="font-size: 40px; margin-bottom: 10px; opacity: 0.5;">ğŸ½ï¸</div>
                            <div class="text-muted fw-bold">ç©ºç©ºå¦‚ä¹Ÿ</div>
                            <small class="text-muted opacity-75 mt-1">å¿«ç‚¹ä¸€ä¸ªæƒ³åƒçš„èœå§ï¼</small>

                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        {% endif %}
        <!-- é¡¶éƒ¨æ“ä½œæ  -->
        {% if my_families %}
            <div class="d-flex justify-content-between align-items-center mb-3 px-1">
                <span class="text-muted small">å…± {{ pets|length }} åªèŒå® </span>
                <button class="btn btn-sm btn-primary rounded-pill fw-bold shadow-sm" data-bs-toggle="modal"
                        data-bs-target="#addPetModal">
                    <i class="fas fa-plus me-1"></i>æ·»æ–°å® 
                </button>
            </div>
        {% endif %}

        {% for pet in pets %}
            <div class="card-box fam-item fam-{{ pet.family_id }}">
                <!-- å® ç‰©æ ‡é¢˜æ  -->
                <!-- [ä¿®æ”¹] ç»™æ•´ä¸ªæ ‡é¢˜æ åŠ ä¸ª onclick è·³è½¬ -->
                <div class="p-3 d-flex justify-content-between align-items-center border-bottom border-light"
                     onclick="location.href='/pet/{{ pet.id }}'"
                     style="cursor: pointer;">
                    <h5 class="mb-0 fw-bold d-flex align-items-center">
                        {% if pet.type == 'dog' %}
                            <i class="fas fa-dog text-secondary me-2 fa-lg"></i>
                        {% else %}
                            <i class="fas fa-cat text-secondary me-2 fa-lg"></i>
                        {% endif %}
                        {{ pet.name }} <i class="fas fa-chevron-right ms-2 text-muted" style="font-size: 12px;"></i>
                        <!-- åŠ ä¸ªå°ç®­å¤´æç¤ºå¯ç‚¹å‡» -->
                        {% if pet.family_name %}
                            <span class="badge bg-light text-muted border ms-2 fw-normal"
                                  style="font-size: 10px;">{{ pet.family_name }}</span>
                        {% endif %}
                    </h5>

                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-light text-dark border">{{ pet.type }}</span>
                        <!-- ç¼–è¾‘æŒ‰é’® (ä»…ä¸»äººå¯è§) -->
                        {% if pet.is_owner %}
                            <!-- [ä¿®æ”¹] å¢åŠ äº†ç¬¬4ä¸ªå‚æ•°: pet.owner_ids | tojson -->
                            <!-- æ³¨æ„ï¼šonclick= åé¢ç”¨çš„æ˜¯å•å¼•å· ' -->
                            <!-- [æ ¸å¿ƒä¿®å¤] åŠ ä¸Š event.stopPropagation(); é˜»æ­¢ç‚¹å‡»äº‹ä»¶ä¼ ç»™çˆ¶å®¹å™¨ -->
                            <button class="btn btn-sm btn-link text-muted p-0"
                                    onclick='event.stopPropagation(); openEditPetModal("{{ pet.id }}", "{{ pet.name }}", "{{ pet.family_id }}", {{ pet.owner_ids | tojson }})'>
                                <i class="fas fa-cog"></i>
                            </button>
                        {% endif %}
                    </div>
                </div>

                <!-- [ä¿®æ”¹] å® ç‰©ç…§ç‰‡åŒºåŸŸï¼šæ”¯æŒå¤šå›¾è§’æ ‡ + ç‚¹å‡»è·³è½¬è¯¦æƒ… -->
                {% if pet.latest_photo %}
                    <div class="pet-photo-wrapper" onclick="location.href='/pet/{{ pet.id }}'" style="cursor: pointer;">
                        <img src="{{ pet.latest_photo }}">

                        <!-- ä¸Šä¼ è€…æ ‡ç­¾ -->
                        <div class="uploader-badge">
                            <i class="fas fa-camera"></i> {{ pet.photo_uploader }}
                        </div>

                        <!-- [æ–°å¢] å¤šå›¾è®¡æ•°è§’æ ‡ (å¦‚æœå¤§äº1å¼ ) -->
                        {% if pet.photo_count > 1 %}
                            <div class="position-absolute top-0 end-0 m-2 badge bg-dark bg-opacity-75 rounded-pill border border-light border-opacity-50 shadow-sm"
                                 style="font-size: 12px; backdrop-filter: blur(2px);">
                                <i class="fas fa-images me-1"></i> ä»Šæ—¥ {{ pet.photo_count }} å¼ 
                            </div>
                        {% endif %}

                        <!-- [åˆ é™¤] åŸæ¥çš„åˆ é™¤æŒ‰é’®å·²ç§»é™¤ï¼Œå»è¯¦æƒ…é¡µåˆ æ›´å®‰å…¨ -->
                    </div>
                {% endif %}

                <div class="p-3">
                    <!-- å–‚é£ŸåŒºåŸŸ -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="small fw-bold text-muted">ğŸš åƒé¥­äº†å—ï¼Ÿ</span>
                            <span class="badge {% if pet.today_feed %}bg-success text-success bg-opacity-10{% else %}bg-danger text-danger bg-opacity-10{% endif %}">
                                {% if pet.today_feed %}âœ… å·²å–‚é£Ÿ{% else %}â³ å¾…å–‚é£Ÿ{% endif %}
                            </span>
                        </div>
                        {% if not pet.today_feed %}
                            <form action="/action" method="POST">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <input type="hidden" name="pet_id" value="{{ pet.id }}">
                                <button type="submit" name="action" value="feed"
                                        class="btn btn-success w-100 fw-bold py-2"><i
                                        class="fas fa-bone me-1"></i> å–‚é¥­æ‰“å¡
                                </button>
                            </form>
                        {% else %}
                            <div class="alert alert-success py-2 px-3 mb-0 small border-0 bg-success bg-opacity-10 text-success">
                                <i class="fas fa-check-circle me-1"></i> {{ pet.feed_info }}
                            </div>
                        {% endif %}
                    </div>

                    <!-- é›ç‹—åŒºåŸŸ -->
                    {% if pet.type == 'dog' %}
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="small fw-bold text-muted">ğŸ¦® é›å¼¯äº†å—ï¼Ÿ</span>
                                <span class="badge {% if pet.today_walk %}bg-primary text-primary bg-opacity-10{% else %}bg-warning text-dark bg-opacity-10{% endif %}">
                                {% if pet.today_walk %}âœ… å·²é›å¼¯{% else %}â³ å¾…é›å¼¯{% endif %}
                            </span>
                            </div>
                            {% if not pet.today_walk %}
                                <form action="/action" method="POST">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <input type="hidden" name="pet_id" value="{{ pet.id }}">
                                    <button type="submit" name="action" value="walk"
                                            class="btn btn-primary w-100 fw-bold py-2"><i
                                            class="fas fa-running me-1"></i> å‡ºå‘é›ç‹—
                                    </button>
                                </form>
                            {% else %}
                                <div class="alert alert-primary py-2 px-3 mb-0 small border-0 bg-primary bg-opacity-10 text-primary">
                                    <i class="fas fa-check-circle me-1"></i> {{ pet.walk_info }}
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}

                    <!-- æ‹ç…§æŒ‰é’® -->
                    <form action="/upload_pet" method="POST" enctype="multipart/form-data" id="petForm-{{ pet.id }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="pet_id" value="{{ pet.id }}">
                        <label class="btn btn-upload-dashed w-100 rounded-3">
                            <i class="fas fa-camera text-muted me-2"></i> æ‹å¼ ç…§
                            <input type="file" name="photo" class="hidden-input" accept="image/*"
                                   onchange="handleCompressAndSubmit(this, 'petForm-{{ pet.id }}')">
                        </label>
                    </form>
                </div>
            </div>
        {% else %}
            <div class="text-center py-5 text-muted">
                <i class="fas fa-paw fa-3x mb-3 opacity-25"></i>
                <p>è¿˜æ²¡æœ‰å® ç‰©</p>
                {% if not my_families %}
                    <small>è¯·å…ˆåŠ å…¥å®¶åº­</small>
                {% else %}
                    <button class="btn btn-primary btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#addPetModal">
                        æ·»åŠ ç¬¬ä¸€åªå® ç‰©
                    </button>
                {% endif %}
            </div>
        {% endfor %}
        <div style="height: 40px;"></div>
    </div>

    <!-- ================= Tab: åŠ¨æ€ ================= -->
    <div id="tab-life" class="{% if current_tab != 'life' %}d-none{% endif %}">

        <!-- å‘å¸ƒæ¡† (ä¿®æ”¹ç‚¹ï¼šåˆ¤æ–­ my_families æ˜¯å¦å­˜åœ¨) -->
        {% if my_families %}
            <div class="card-box p-3 shadow-sm">
                <form action="/post_moment" method="POST" enctype="multipart/form-data" id="momentForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                    <!-- æ–‡æœ¬æ¡† -->
                    <div class="mb-2">
                        <textarea name="content" class="form-control border-0 bg-light rounded-3" rows="3"
                                  placeholder="åˆ†äº«æ­¤æ—¶æ­¤åˆ»... (æ¯”å¦‚: åˆšä¸‹è¯¾å¥½é¥¿)"
                                  style="resize:none; padding: 12px;"></textarea>
                    </div>

                    <!-- å›¾ç‰‡é¢„è§ˆåŒº (ä¿æŒä¸å˜) -->
                    <div id="preview-container" class="d-none mb-2 position-relative w-fit-content">
                        <img id="preview-img" src="" style="max-height: 150px; border-radius: 8px;">
                        <div onclick="clearPreview()"
                             class="position-absolute top-0 end-0 bg-dark text-white rounded-circle"
                             style="width:20px;height:20px;line-height:18px;text-align:center;cursor:pointer;margin:-5px;">
                            Ã—
                        </div>
                    </div>

                    <!-- [æ ¸å¿ƒä¿®æ”¹] åº•éƒ¨å·¥å…·æ  -->
                    <div class="d-flex justify-content-between align-items-center border-top pt-2">
                        <!-- å·¦ä¾§ï¼šåŠ å›¾ç‰‡ -->
                        <label class="btn btn-sm btn-outline-primary rounded-pill px-3 border-0">
                            <i class="fas fa-image fa-lg"></i>
                            <input type="file" name="photo" id="momentPhotoInput" class="hidden-input" accept="image/*"
                                   onchange="handleCompressAndPreview(this)">
                        </label>

                        <div class="d-flex gap-2">
                            <!-- [æ–°å¢] å¯è§èŒƒå›´é€‰æ‹©å™¨ -->
                            <select name="visibility" class="form-select form-select-sm rounded-pill"
                                    style="width: auto; font-size: 12px; border-color: #dee2e6;">
                                <option value="public">ğŸŒ æ‰€æœ‰å®¶äºº</option>
                                {% for f in my_families %}
                                    <option value="{{ f.id }}">ğŸ”’ ä»… {{ f.name }}</option>
                                {% endfor %}
                            </select>

                            <!-- å‘å¸ƒæŒ‰é’® -->
                            <button type="submit" class="btn btn-sm btn-primary rounded-pill px-3 fw-bold shadow-sm">
                                å‘å¸ƒ
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        {% else %}
            <!-- å¦‚æœæ²¡åŠ å…¥å®¶åº­ï¼Œæ˜¾ç¤ºæç¤º -->
            <div class="alert alert-warning text-center small rounded-4 shadow-sm border-0 mb-3">
                <i class="fas fa-exclamation-circle me-1"></i> åŠ å…¥å®¶åº­åæ‰èƒ½å‘å¸ƒåŠ¨æ€å“¦
            </div>
        {% endif %}

        <!-- åŠ¨æ€åˆ—è¡¨ -->
        <div class="card-box">
            {% for moment in moments %}
                <div class="moment-item">
                    <div class="moment-header">
                        <div class="avatar-circle">
                            {% if moment.user_avatar %}<img src="{{ moment.user_avatar }}">{% else %}
                                {{ moment.user_name[0] }}{% endif %}
                        </div>
                        <div class="flex-grow-1">
                            <div class="moment-user">{{ moment.user_name }}</div>
                            <div class="moment-time">
                                {{ moment.time_str }}
                                {% if moment.target_family_id %}
                                    {% for f in my_families %}
                                        {% if f.id == moment.target_family_id %}
                                            <span class="badge bg-white text-secondary border ms-1 fw-normal"
                                                  style="font-size: 10px; transform: scale(0.95);">
                                        <i class="fas fa-home me-1 text-muted"></i>{{ f.name }}
                                    </span>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <span class="badge bg-transparent text-muted ms-1 fw-normal"
                                          style="font-size: 10px; opacity: 0.5;">
                                <i class="fas fa-globe"></i> å…¬å¼€
                            </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    {% if moment.content %}
                        <div class="moment-content">{{ moment.content }}</div>{% endif %}
                    {% if moment.image_url %}<img src="{{ moment.image_url }}" class="moment-img shadow-sm"
                                                  onclick="window.open(this.src)">{% endif %}

                    <!-- 3. åº•éƒ¨æ“ä½œæ  -->
                    <div class="d-flex justify-content-between align-items-center mt-2 pt-2">
                        <!-- çº¯æŒ‰é’®ï¼Œä¸å¸¦æ•°å­—äº† -->
                        <button class="like-btn {% if moment.is_liked %}liked{% endif %}"
                                onclick="toggleLike(this, '{{ moment.id }}')">
                            <i class="{{ 'fas' if moment.is_liked else 'far' }} fa-heart fa-lg"></i>
                            <span class="small ms-1">{{ 'å–æ¶ˆ' if moment.is_liked else 'ç‚¹èµ' }}</span>
                        </button>

                        <!-- åˆ é™¤æŒ‰é’® (ä¿æŒä¸å˜) -->
                        {% if moment.user_id == current_user_id %}
                            <form action="/delete_moment/{{ moment.id }}" method="POST"
                                  onsubmit="return confirm('ç¡®å®šåˆ é™¤è¿™æ¡åŠ¨æ€å—ï¼Ÿ')">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <button type="submit" class="btn btn-sm text-secondary p-0">
                                    <i class="far fa-trash-alt"></i>
                                </button>
                            </form>
                        {% endif %}
                    </div>

                    <!-- 4. [æ–°å¢] æœ‹å‹åœˆç‚¹èµåˆ—è¡¨ (å¦‚æœæœ‰èµæ‰æ˜¾ç¤º) -->
                    <div class="likes-area" id="likes-area-{{ moment.id }}"
                         style="display: {{ 'flex' if moment.likers else 'none' }};">
                        <i class="far fa-heart like-heart-icon"></i>
                        <div class="liker-list" id="liker-list-{{ moment.id }}">
                            {% for liker in moment.likers %}
                                {% if liker.avatar %}
                                    <img src="{{ liker.avatar }}" class="liker-avatar" title="{{ liker.name }}">
                                {% else %}
                                    <!-- æ²¡å¤´åƒæ˜¾ç¤ºåå­—é¦–å­— -->
                                    <div class="liker-avatar bg-secondary text-white d-flex align-items-center justify-content-center small fw-bold">
                                        {{ liker.name[0] }}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>

            {% else %}
                <div class="text-center p-5 text-muted">
                    <div class="mb-3 opacity-50"><i class="fas fa-seedling fa-3x text-success"></i></div>
                    <p>è¿˜æ²¡æœ‰åŠ¨æ€å“¦</p>
                    {% if not my_families %}
                        <small>å¿«åŠ å…¥å®¶åº­ï¼Œå’Œå®¶äººåˆ†äº«ç”Ÿæ´»ï¼</small>
                    {% else %}
                        <small>å¿«æ¥å‘ç¬¬ä¸€æ¡çŠ¶æ€ï¼Œè®©å®¶äººçŸ¥é“ä½ åœ¨å¹²å˜›ï¼</small>
                    {% endif %}
                </div>

            {% endfor %}
        </div>
        <div style="height: 40px;"></div>
    </div>

    <!-- ================= Tab: ä¸ªäººä¸­å¿ƒ ================= -->
    <div id="tab-mine" class="{% if current_tab != 'mine' %}d-none{% endif %}">

        <div class="card-box p-4 text-center">
            <!-- å¤´åƒä¿®æ”¹ -->
            <form action="/update_profile" method="POST" enctype="multipart/form-data" id="avatarForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <label class="my-avatar-container" style="cursor: pointer;">
                    {% if my_profile.full_avatar_url %}
                        <img src="{{ my_profile.full_avatar_url }}" class="my-avatar">
                    {% else %}
                        <img src="https://ui-avatars.com/api/?name={{ user_name }}&background=random" class="my-avatar">
                    {% endif %}
                    <div class="avatar-edit-icon"><i class="fas fa-camera"></i></div>
                    <input type="file" name="avatar" class="hidden-input" accept="image/*"
                           onchange="handleCompressAndSubmit(this, 'avatarForm')">
                </label>
            </form>

            <!-- æ˜µç§°ä¿®æ”¹ -->
            <form action="/update_profile" method="POST"
                  class="d-flex justify-content-center align-items-center gap-2 mb-2">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="text" name="display_name" value="{{ my_profile.display_name }}"
                       class="form-control form-control-sm text-center fw-bold fs-5"
                       style="width: 150px; border:none; border-bottom: 1px dashed #ccc; background:transparent; padding:0;"
                       onblur="this.form.submit()">
                <i class="fas fa-pen text-muted" style="font-size: 12px;"></i>
            </form>

            <!-- [ç»ˆæé˜²è¯¯è§¦ç‰ˆ] ID æ˜¾ç¤ºåŒºåŸŸ -->
            <!-- [ç»ˆæé€‚é…] ID æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="text-muted small mb-3 opacity-50 font-monospace"
                 onclick="triggerSecret()"
                 style="cursor: pointer;
                        touch-action: none;           /* [æ ¸å¿ƒ] ç¦æ­¢ç¼©æ”¾/æ»šåŠ¨/é•¿æŒ‰èœå• */
                        -webkit-touch-callout: none;  /* iOS ç¦æ­¢é•¿æŒ‰èœå• */
                        -webkit-user-select: none;    /* ç¦æ­¢é€‰ä¸­æ–‡å­— */
                        user-select: none;
                        -webkit-tap-highlight-color: transparent;"> <!-- ç¦æ­¢ç‚¹å‡»é«˜äº®è‰²å— -->
                ID: {{ my_profile.id|truncate(8, True) }}
            </div>
            <!-- [æ–°ç‰ˆ] æ¶ˆæ¯é€šçŸ¥ç»‘å®š -->
            <div class="card-box p-3 mb-3">
                <h6 class="fw-bold mb-3 d-flex align-items-center justify-content-between">
                    <span><i class="fas fa-bell text-warning me-2"></i>æ¶ˆæ¯é€šçŸ¥</span>
                    <!-- å¸®åŠ©æŒ‰é’® -->
                    <button class="btn btn-sm btn-light text-primary small rounded-pill px-2"
                            onclick="new bootstrap.Modal(document.getElementById('wxGuideModal')).show()">
                        <i class="fas fa-book-open"></i> çœ‹æ•™ç¨‹
                    </button>
                </h6>

                <form action="/update_profile" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                    <div class="input-group mb-2">
                        <input type="text" name="wx_uid" class="form-control form-control-sm"
                               value="{{ my_profile.wx_uid or '' }}"
                               placeholder="ç²˜è´´ WxPusher çš„ UID">
                        <button type="submit" class="btn btn-sm btn-dark">ä¿å­˜</button>
                    </div>

                    {% if my_profile.wx_uid %}
                        <div class="text-success small d-flex align-items-center">
                            <i class="fas fa-check-circle me-1"></i> çŠ¶æ€æ­£å¸¸ï¼šå·²ç»‘å®š
                        </div>
                    {% else %}
                        <div class="text-muted small d-flex align-items-center">
                            <i class="fas fa-info-circle me-1"></i> ç»‘å®šåå¯æ¥æ”¶è®¸æ„¿ã€æé†’ç­‰æ¶ˆæ¯é€šçŸ¥
                        </div>
                    {% endif %}
                </form>
            </div>
            <!-- å®¶åº­çŠ¶æ€é€»è¾‘ -->
            <div class="mt-4 text-start">
                <h6 class="fw-bold mb-3"><i class="fas fa-users me-2 text-primary"></i>æˆ‘çš„å®¶åº­åˆ—è¡¨</h6>

                {% if my_families %}
                    <div class="d-grid gap-3">
                        {% for fam in my_families %}
                            <div class="bg-light p-3 rounded-3 border position-relative">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-bold text-dark">{{ fam.name }}</span>
                                    <span class="badge bg-primary bg-opacity-10 text-primary">æˆå‘˜</span>
                                </div>

                                <div class="d-flex align-items-center justify-content-between bg-white p-2 rounded border border-light">
                                    <div class="text-muted small font-monospace"
                                         style="letter-spacing:1px;">{{ fam.invite_code }}
                                    </div>
                                    <button class="btn btn-sm btn-link text-decoration-none p-0"
                                            onclick="copyCode(this.previousElementSibling)" style="font-size:12px;">
                                        å¤åˆ¶é‚€è¯·ç 
                                    </button>
                                </div>

                                <!-- é€€å‡ºå…·ä½“æŸä¸ªå®¶åº­ -->
                                <form action="/leave_family" method="POST"
                                      onsubmit="return confirm('ç¡®å®šè¦é€€å‡º [{{ fam.name }}] å—ï¼Ÿ')"
                                      class="mt-2 text-end">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <input type="hidden" name="family_id" value="{{ fam.id }}">
                                    <button class="btn btn-sm text-danger p-0" style="font-size: 11px; opacity: 0.7;">
                                        <i class="fas fa-sign-out-alt me-1"></i>é€€å‡ºæ­¤å®¶åº­
                                    </button>
                                </form>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-secondary small text-center">
                        ä½ è¿˜æ²¡æœ‰åŠ å…¥ä»»ä½•å®¶åº­
                    </div>
                {% endif %}
            </div>
            <!-- æœªåŠ å…¥å®¶åº­ï¼šæ˜¾ç¤ºåˆ›å»º/åŠ å…¥é€‰é¡¹ -->
            <div class="mt-4 text-start bg-white rounded-3 pt-3 border-top">
                <ul class="nav nav-tabs nav-fill mb-3" id="famTab" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active fw-bold small" data-bs-toggle="tab" data-bs-target="#joinFam">
                            åŠ å…¥æ–°å®¶
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link fw-bold small" data-bs-toggle="tab" data-bs-target="#createFam">
                            åˆ›å»ºæ–°å®¶
                        </button>
                    </li>
                </ul>
                <div class="tab-content p-2">
                    <div class="tab-pane fade show active" id="joinFam">
                        <form action="/join_family" method="POST">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <div class="input-group mb-2">
                                <span class="input-group-text"><i class="fas fa-key"></i></span>
                                <input type="text" name="invite_code" class="form-control text-uppercase"
                                       placeholder="è¾“å…¥6ä½é‚€è¯·ç " required>
                            </div>
                            <button class="btn btn-primary w-100 fw-bold btn-sm">åŠ å…¥</button>
                        </form>
                    </div>
                    <div class="tab-pane fade" id="createFam">
                        <form action="/create_family" method="POST">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <div class="input-group mb-2">
                                <span class="input-group-text"><i class="fas fa-house-user"></i></span>
                                <input type="text" name="family_name" class="form-control" placeholder="ç»™å®¶èµ·ä¸ªåå­—"
                                       required>
                            </div>
                            <button class="btn btn-success w-100 fw-bold btn-sm">åˆ›å»º</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- [æ–°å¢] ğŸ”® èµ›åšè€é»„å† -->
        <div class="card-box p-3 mb-3" style="background: #fffbf0; border: 1px solid #ffeaa7;">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0 fw-bold text-dark"><i class="fas fa-calendar-alt text-warning me-2"></i>ä»Šæ—¥è¿åŠ¿</h6>
                <small class="text-muted" id="almanac-date">Loading...</small>
            </div>
            <div class="row text-center g-2">
                <div class="col-6">
                    <div class="p-2 rounded" style="background:rgba(255, 71, 87, 0.1);">
                        <div class="text-danger fw-bold small mb-1">å®œ</div>
                        <div class="fw-bold" id="almanac-good">...</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="p-2 rounded" style="background:rgba(47, 53, 66, 0.1);">
                        <div class="text-dark fw-bold small mb-1">å¿Œ</div>
                        <div class="fw-bold" id="almanac-bad">...</div>
                    </div>
                </div>
            </div>
            <div class="mt-2 text-center small text-muted fst-italic" id="almanac-tips"></div>
        </div>
        <!-- [æ–°å¢] å…³æ€€æ¨¡å¼å¼€å…³ -->
        <div class="card-box p-3 mb-3">
            <form action="/update_profile" method="POST" id="elderModeForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <!-- è¿™é‡Œçš„ display_name æ˜¯ä¸ºäº†é˜²æ­¢è¦†ç›–åå­—ï¼Œä¼ åŸå€¼ -->
                <input type="hidden" name="display_name" value="{{ my_profile.display_name }}">

                <div class="form-check form-switch d-flex align-items-center justify-content-between ps-0">
                    <label class="form-check-label fw-bold d-flex align-items-center gap-2" for="elderSwitch">
                        <i class="fas fa-eye text-primary fa-lg"></i>
                        <span>é•¿è¾ˆå…³æ€€æ¨¡å¼ (å¤§å­—ç‰ˆ)</span>
                    </label>
                    <input class="form-check-input ms-0" type="checkbox" name="is_elder_mode" id="elderSwitch"
                           style="width: 50px; height: 25px;"
                           {% if my_profile.is_elder_mode %}checked{% endif %}
                           onchange="document.getElementById('elderModeForm').submit()">
                </div>
            </form>
        </div>
        <!-- å®‰å…¨è®¾ç½®å¡ç‰‡ -->
        <div class="card-box p-3">
            <h6 class="mb-3 fw-bold text-dark"><i class="fas fa-lock me-2 text-secondary"></i>å®‰å…¨è®¾ç½®</h6>
            <form action="/change_password" method="POST" class="d-flex gap-2">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="password" name="new_password" class="form-control" placeholder="è¾“å…¥æ–°å¯†ç  (è‡³å°‘6ä½)"
                       required>
                <button class="btn btn-outline-primary px-3">ç¡®è®¤</button>
            </form>
        </div>

        <!-- é€€å‡ºç™»å½•æŒ‰é’® -->
        <div class="d-grid gap-2 mb-4">
            <a href="/logout" class="btn btn-light text-danger fw-bold py-3 rounded-4 shadow-sm border">
                <i class="fas fa-sign-out-alt me-2"></i> é€€å‡ºç™»å½•
            </a>
        </div>

        <div style="height: 20px;"></div>
    </div>

</div>

<!-- åº•éƒ¨å¯¼èˆªæ  -->
<div class="bottom-nav">
    <a href="/?tab=pets" class="nav-item {% if current_tab == 'pets' %}active{% endif %}">
        <i class="fas fa-heart"></i>
        <span>ç‰µæŒ‚</span>
    </a>
    <a href="/?tab=life" class="nav-item {% if current_tab == 'life' %}active{% endif %}">
        <i class="fas fa-camera-retro"></i>
        <span>åŠ¨æ€</span>
    </a>
    <a href="/?tab=mine" class="nav-item {% if current_tab == 'mine' %}active{% endif %}">
        <i class="fas fa-user"></i>
        <span>æˆ‘çš„</span>
    </a>
</div>
<!-- ============ æ”¾åœ¨ body ç»“æŸå‰çš„å¼¹çª—ä»£ç  ============ -->

<!-- æ·»åŠ å® ç‰©å¼¹çª— -->
<div class="modal fade" id="addPetModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">ğŸ¶ æ·»åŠ æ–°æˆå‘˜</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form action="/create_pet" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                    <div class="mb-3">
                        <label class="form-label small text-muted">åå­—</label>
                        <input type="text" name="name" class="form-control" placeholder="å¦‚: æ—ºè´¢" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small text-muted">ç±»å‹</label>
                        <select name="type" class="form-select">
                            <option value="dog">ğŸ¶ ç‹—ç‹—</option>
                            <option value="cat">ğŸ± çŒ«çŒ«</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small text-muted">å½’å±å®¶åº­</label>
                        <select name="family_id" class="form-select">
                            {% for f in my_families %}
                                <option value="{{ f.id }}">{{ f.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary w-100 fw-bold rounded-3 py-2">ç¡®è®¤æ·»åŠ </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ç¼–è¾‘å® ç‰©å¼¹çª— -->
<div class="modal fade" id="editPetModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">âš™ï¸ ç®¡ç†å® ç‰©</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">

                <!-- ä¿®æ”¹åå­—éƒ¨åˆ† -->
                <form action="/update_pet" method="POST" class="mb-4 border-bottom pb-4">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="pet_id" id="edit_pet_id">

                    <label class="form-label small text-muted fw-bold">ä¿®æ”¹èµ„æ–™</label>
                    <div class="input-group mb-2">
                        <input type="text" name="name" id="edit_pet_name" class="form-control" required>
                        <button type="submit" name="action" value="update" class="btn btn-success fw-bold">ä¿å­˜
                        </button>
                    </div>
                    <div class="text-end">
                        <button type="submit" name="action" value="delete"
                                class="btn btn-link text-danger text-decoration-none p-0 small"
                                onclick="return confirm('âš ï¸ ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ')">åˆ é™¤æ­¤å® ç‰©
                        </button>
                    </div>
                </form>

                <!-- æ·»åŠ å…±ç®¡äººéƒ¨åˆ† -->
                <form action="/add_pet_owner" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="pet_id" id="add_owner_pet_id">

                    <label class="form-label small text-muted fw-bold">æ·»åŠ å…±ç®¡ä¸»äºº (å¯¹è±¡/çˆ¶æ¯)</label>
                    <div class="input-group">
                        <select name="new_owner_id" class="form-select">
                            <option value="" disabled selected>é€‰æ‹©å®¶åº­æˆå‘˜...</option>
                            <!-- éå†æ‰€æœ‰å¯è§çš„å®¶åº­æˆå‘˜ -->
                            {% for uid, info in user_map.items() %}
                                <!-- ä¸æ˜¾ç¤ºæˆ‘è‡ªå·± -->
                                {% if uid != current_user_id %}
                                    <option value="{{ uid }}">{{ info.name }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        <button class="btn btn-outline-primary fw-bold">æ·»åŠ </button>
                    </div>
                    <div class="form-text small">æ·»åŠ åï¼Œä»–/å¥¹ä¹Ÿèƒ½ä¿®æ”¹å® ç‰©ä¿¡æ¯ã€‚</div>
                </form>

            </div>
        </div>
    </div>
</div>

<!-- æ›´æ–°å…¬å‘Šå¼¹çª— -->
{% if latest_update %}
    <div class="modal fade" id="updateModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0 shadow-lg">
                <div class="modal-header border-0 bg-success bg-opacity-10">
                    <h5 class="modal-title fw-bold text-success">
                        ğŸš€ æ–°ç‰ˆæœ¬ v{{ latest_update.version }}
                    </h5>
                    <!-- è¿™é‡Œçš„å…³é—­æŒ‰é’®æœ‰ç‰¹æ®Šé€»è¾‘ï¼Œè§JS -->
                    <button type="button" class="btn-close"
                            onclick="closeUpdateModal('{{ latest_update.version }}')"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="fs-6" style="line-height: 1.8;">
                        {{ latest_update.content | safe }}
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-success w-100 rounded-pill fw-bold"
                            onclick="closeUpdateModal('{{ latest_update.version }}')">
                        æˆ‘çŸ¥é“äº†
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endif %}
<!-- è®¾ç½®å€’è®¡æ—¶å¼¹çª— -->
<div class="modal fade" id="reunionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">ğŸ“… ä»€ä¹ˆæ—¶å€™å›¢åœ†ï¼Ÿ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form action="/set_reunion" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="family_id" id="reunion_fam_id">

                    <div class="mb-3">
                        <label class="form-label small text-muted">æ ‡é¢˜</label>
                        <input type="text" name="reunion_name" id="reunion_name" class="form-control"
                               placeholder="ä¾‹å¦‚: å¯’å‡å›å®¶ / çˆ¸å¦ˆæ¥å—äº¬">
                    </div>

                    <div class="mb-4">
                        <label class="form-label small text-muted">ç›®æ ‡æ—¥æœŸ</label>
                        <input type="date" name="reunion_date" id="reunion_date"
                               class="form-control form-control-lg fw-bold text-center">
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary fw-bold">ä¿å­˜è®¾ç½®</button>
                        <button type="button" class="btn btn-light text-danger" onclick="clearReunionDate()">
                            æ¸…é™¤/å–æ¶ˆå€’è®¡æ—¶
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- è®¾ç½®åŸå¸‚å¼¹çª— -->
<div class="modal fade" id="weatherModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">ğŸŒ¤ï¸ è®¾ç½®åŸå¸‚</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form action="/set_weather_city" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="family_id" id="weather_fam_id">
                    <input type="hidden" name="type" id="weather_type"> <!-- home æˆ– away -->

                    <div class="mb-3">
                        <label class="form-label small text-muted" id="weather_label">è¾“å…¥åŸå¸‚åç§°</label>
                        <input type="text" name="city_name" id="weather_city_name"
                               class="form-control form-control-lg text-center" placeholder="ä¾‹å¦‚: é•¿æ²™">
                        <div class="form-text small text-center">æ”¯æŒä¸­æ–‡æˆ–æ‹¼éŸ³ï¼Œç²¾ç¡®åˆ°å¸‚</div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary fw-bold">ä¿å­˜å¹¶æŸ¥è¯¢</button>
                        <button type="submit" class="btn btn-light text-danger"
                                onclick="document.getElementById('weather_city_name').value=''">æ¸…é™¤è®¾ç½®
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- è®¸æ„¿å¼¹çª— -->
<div class="modal fade" id="wishModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">ğŸ˜‹ ä»Šå¤©æƒ³åƒç‚¹å•¥ï¼Ÿ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form action="/add_wish" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="family_id" id="wish_fam_id">

                    <div class="mb-3">
                        <input type="text" name="content" class="form-control form-control-lg"
                               placeholder="çƒ§é¥µå— / ç‚¸æ´‹èŠ‹..." required autofocus>
                    </div>
                    <button type="submit" class="btn btn-warning w-100 fw-bold text-white">ä¸Šå¢™è®¸æ„¿ âœ¨</button>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- åˆ‡æ¢çŠ¶æ€å¼¹çª— -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm"> <!-- å°å¼¹çª— -->
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-center w-100">æˆ‘ç°åœ¨...</h5>
            </div>
            <div class="modal-body">
                <form action="/update_status" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="d-grid gap-2">
                        <button name="status" value="online"
                                class="btn btn-outline-success border-2 fw-bold py-2 text-start px-4">
                            ğŸŸ¢ æœ‰ç©º / åœ¨çº¿ <span class="float-end">ğŸ˜Š</span>
                        </button>
                        <button name="status" value="busy"
                                class="btn btn-outline-warning border-2 fw-bold py-2 text-start px-4 text-dark">
                            ğŸŸ¡ å­¦ä¹  / å·¥ä½œ <span class="float-end">ğŸ“š</span>
                        </button>
                        <button name="status" value="food"
                                class="btn btn-outline-danger border-2 fw-bold py-2 text-start px-4">
                            ğŸ”´ å¹²é¥­ä¸­ <span class="float-end">ğŸš</span>
                        </button>
                        <button name="status" value="game"
                                class="btn btn-outline-info border-2 fw-bold py-2 text-start px-4">
                            ğŸ”µ æ‹¯æ•‘ä¸–ç•Œ <span class="float-end">ğŸ®</span>
                        </button>
                        <button name="status" value="sleep"
                                class="btn btn-outline-secondary border-2 fw-bold py-2 text-start px-4">
                            âšª ç¡äº† / å‹¿æ‰° <span class="float-end">ğŸ’¤</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- æ·»åŠ äº‹ä»¶å¼¹çª— -->
<div class="modal fade" id="addEventModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">ğŸ“… è®°ä¸‹ä¸€ä¸ªæ—¥å­</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form action="/add_family_event" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="family_id" id="add_event_fam_id">

                    <div class="mb-3">
                        <label class="form-label small text-muted">æ ‡é¢˜</label>
                        <input type="text" name="title" class="form-control" placeholder="å¦‚: çˆ¸å¦ˆç»“å©šçºªå¿µæ—¥" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small text-muted">èµ·å§‹æ—¥æœŸ</label>
                        <input type="date" name="event_date" class="form-control form-control-lg" required>
                        <div class="form-text small">å¦‚æœæ˜¯ç”Ÿæ—¥ï¼Œè¯·é€‰å‡ºç”Ÿé‚£å¹´ï¼›å¦‚æœæ˜¯çºªå¿µæ—¥ï¼Œé€‰é¢†è¯é‚£å¹´</div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-6">
                            <label class="form-label small text-muted">ç±»å‹</label>
                            <select name="event_type" class="form-select">
                                <option value="solar">ğŸŒ å…¬å†</option>
                                <option value="lunar">ğŸŒ™ å†œå†</option>
                            </select>
                        </div>
                        <div class="col-6 d-flex align-items-center">
                            <div class="form-check form-switch mt-4">
                                <input class="form-check-input" type="checkbox" name="is_repeat" id="isRepeat" checked>
                                <label class="form-check-label small" for="isRepeat">æ¯å¹´é‡å¤</label>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary w-100 fw-bold">ä¿å­˜</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- åˆ—è¡¨ç®¡ç†å¼¹çª— -->
<div class="modal fade" id="eventListModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">ğŸ“‹ æ‰€æœ‰æ—¥å­</h5>
                <button class="btn btn-sm btn-outline-primary ms-auto" onclick="switchToAddModal()">+ æ–°å¢</button>
            </div>
            <div class="modal-body p-0">
                <div class="list-group list-group-flush" id="eventListBody">
                    <!-- JS åŠ¨æ€å¡«å…… -->
                </div>
            </div>
        </div>
    </div>
</div>
<!-- æ¶ˆæ¯ç»‘å®šæ•™ç¨‹å¼¹çª— (Appæµç¨‹ç‰ˆ) -->
<div class="modal fade" id="wxGuideModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">ğŸ“² å¦‚ä½•å¼€å¯æ¨é€ï¼Ÿ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center pt-2">

                <p class="small text-muted mb-4">
                    ä¸ºäº†æ›´ç¨³å®šåœ°æ¥æ”¶æ¶ˆæ¯ï¼Œæˆ‘ä»¬éœ€è¦å€ŸåŠ©<br><strong>WxPusher</strong> (ä¸€æ¬¾å…è´¹æ¨é€æœåŠ¡)
                </p>

                <!-- æ­¥éª¤ 1 -->
                <div class="d-flex align-items-start mb-3 text-start">
                    <span class="badge bg-light text-dark border me-3 mt-1">1</span>
                    <div>
                        <div class="fw-bold">ä¸‹è½½å®¢æˆ·ç«¯</div>
                        <div class="small text-muted mb-2">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œæˆ–åœ¨åº”ç”¨å•†åº—æœ "WxPusher"</div>
                        <!-- [ä¿®æ”¹] è¿™é‡Œå¡«é‚£ä¸ªä¸å˜çš„é“¾æ¥ï¼Œæˆ–è€…ç›´æ¥è·³å®˜ç½‘ -->
                        <a href="https://wxpusher.zjiecode.com/docs/download.html"
                           target="_blank" class="btn btn-sm btn-outline-primary rounded-pill">
                            <i class="fas fa-download"></i> å»ä¸‹è½½
                        </a>
                    </div>
                </div>

                <!-- æ­¥éª¤ 2 -->
                <div class="d-flex align-items-start mb-3 text-start">
                    <span class="badge bg-light text-dark border me-3 mt-1">2</span>
                    <div>
                        <div class="fw-bold">è·å–ç»‘å®šç </div>
                        <div class="small text-muted">æ‰“å¼€Appç™»å½• -> å¤åˆ¶æ˜¾ç¤ºçš„ <code>BIND_xxx</code> ç»‘å®šç  ->
                            å‘é€ç»™å®ƒçš„å¾®ä¿¡å…¬ä¼—å·ã€‚
                        </div>
                    </div>
                </div>

                <div class="d-flex align-items-start mb-3 text-start">
                    <span class="badge bg-light text-dark border me-3 mt-1">3</span>
                    <div>
                        <div class="fw-bold">å…³æ³¨æ¥æ”¶é€šé“</div>
                        <div class="small text-muted mb-2">
                            ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œè·å–äºŒç»´ç ä»¥å…³æ³¨ã€å…¨å®¶ç‰µæŒ‚ã€‘æ¨é€æœåŠ¡ï¼Œä¿å­˜äºŒç»´ç åä½¿ç”¨å¾®ä¿¡æ‰«ç å…³æ³¨
                        </div>

                        <!-- [é‡ç‚¹] æŠŠ href æ¢æˆä½ é‚£ä¸ª"ä¸å˜çš„é“¾æ¥" -->
                        <a href="https://wxpusher.zjiecode.com/api/qrcode/1b4KA4hXqZ6ffWVLpnG6npiRmUvS91wgyXuHFUE2KKythSBI7JRxklq3gfwxSQxG.jpg"
                           target="_blank" class="btn btn-warning w-100 rounded-pill fw-bold text-dark">
                            <i class="fas fa-qrcode"></i> ç‚¹æˆ‘è·å–äºŒç»´ç 
                        </a>
                    </div>
                </div>
                <!-- æ­¥éª¤ 3 -->
                <div class="d-flex align-items-start mb-3 text-start">
                    <span class="badge bg-light text-dark border me-3 mt-1">4</span>
                    <div>
                        <div class="fw-bold">å›å¡« UID</div>
                        <div class="small text-muted">ä½¿ç”¨ç»‘å®šç ç»‘å®šæˆåŠŸåï¼Œåœ¨Appé‡Œæ‰¾åˆ°
                            <strong>æˆ‘çš„</strong>ï¼Œæ‰¾åˆ°ç¬¬ä¸€è¡Œ<strong>UID</strong>å¤åˆ¶å¹¶ç²˜è´´åˆ°æœ¬ç½‘é¡µçš„è¾“å…¥æ¡†é‡Œä¿å­˜ã€‚
                        </div>
                    </div>
                </div>

                <div class="alert alert-secondary small text-start mb-0">
                    <i class="fas fa-lightbulb text-warning"></i> <strong>æç¤ºï¼š</strong><br>
                    ä»¥ä¸Šæ­¥éª¤ä»…ç”¨äºå¼€å¯æ¶ˆæ¯æé†’åŠŸèƒ½ï¼Œä¸å¼€å¯ä¸ä¼šå½±å“å…¶ä»–ä»»ä½•åŠŸèƒ½çš„ä½¿ç”¨ã€‚
                </div>
                <div class="alert alert-warning small text-start mb-0">
                    <strong>âš ï¸ æ³¨æ„ï¼š</strong><br>
                    è®°å¾—åœ¨æ‰‹æœºè®¾ç½®é‡Œï¼Œç»™ WxPusher å¼€å¯<strong>â€œé€šçŸ¥æƒé™â€</strong>ï¼Œå¦åˆ™æ”¶ä¸åˆ°æ¶ˆæ¯å“¦ï¼
                </div>

            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-primary w-100 rounded-pill" data-bs-dismiss="modal">æ‡‚äº†ï¼Œæˆ‘å»è¯•è¯•
                </button>
            </div>
        </div>
    </div>
</div>
<!-- å¹¸è¿å¤§è½¬ç›˜å¼¹çª— -->
<div class="modal fade" id="wheelModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">ğŸ¡ å‘½è¿çš„é½¿è½®</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">

                <!-- è½¬ç›˜ä¸»ä½“ -->
                <div class="wheel-wrapper">
                    <div class="wheel-pointer"></div>
                    <div class="wheel-container">
                        <canvas id="wheel-canvas" width="600" height="600"></canvas>
                    </div>
                    <div class="wheel-center" onclick="spinWheel()">GO</div>
                </div>

                <!-- æ§åˆ¶å° -->
                <ul class="nav nav-pills nav-fill mb-3 gap-2" id="wheelTab" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active btn-sm border" id="mode-member-tab" data-bs-toggle="pill"
                                data-bs-target="#mode-member" type="button" onclick="setWheelMode('member')">
                            ğŸ‘¥ é€‰äºº (å®¶åº­æˆå‘˜)
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link btn-sm border" id="mode-custom-tab" data-bs-toggle="pill"
                                data-bs-target="#mode-custom" type="button" onclick="setWheelMode('custom')">
                            ğŸ“ è‡ªå®šä¹‰ (åšå•¥/åƒå•¥)
                        </button>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- é€‰äººæ¨¡å¼ï¼šè‡ªåŠ¨åŠ è½½ -->
                    <div class="tab-pane fade show active" id="mode-member">
                        <div class="mb-3">
                            <label class="small text-muted mb-1">è¿™æŠŠè½¬ç›˜æ˜¯ä¸ºäº†å†³å®šè°å»...</label>
                            <input type="text" id="member-task-input" class="form-control"
                                   placeholder="è¾“å…¥ä»»åŠ¡ (å¦‚: æ´—ç¢— / æ‹¿å¤–å– / å€’åƒåœ¾)">
                        </div>
                        <div class="text-muted small mb-3">
                            <i class="fas fa-users"></i> å°†ä»å½“å‰å®¶åº­æˆå‘˜ä¸­éšæœºæŠ½å–
                        </div>
                    </div>

                    <!-- è‡ªå®šä¹‰æ¨¡å¼ï¼šæ‰‹åŠ¨è¾“å…¥ -->
                    <div class="tab-pane fade" id="mode-custom">
                        <textarea id="custom-items" class="form-control mb-2" rows="3"
                                  placeholder="è¾“å…¥é€‰é¡¹ï¼Œç”¨æ¢è¡Œéš”å¼€&#10;ä¾‹å¦‚ï¼š&#10;æ´—ç¢—&#10;æ‹–åœ°&#10;æ‹¿å¿«é€’"
                                  oninput="updateCustomWheel()"></textarea>
                        <div class="text-muted small mb-3">è¾“å…¥å˜åŠ¨ä¼šè‡ªåŠ¨æ›´æ–°è½¬ç›˜</div>
                    </div>
                </div>

                <!-- å¯åŠ¨æŒ‰é’® -->
                <button id="spin-btn" class="btn btn-warning w-100 fw-bold text-white rounded-pill py-2 shadow-sm"
                        onclick="spinWheel()">
                    å¼€å§‹è½¬åŠ¨ï¼
                </button>

                <div class="form-check form-switch d-flex justify-content-center mt-3">
                    <input class="form-check-input me-2" type="checkbox" id="auto-notify" checked>
                    <label class="form-check-label small text-muted" for="auto-notify">ç»“æœè‡ªåŠ¨å‘é€åˆ°å®¶åº­æé†’</label>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- è¶³è¿¹åœ°å›¾å¼¹çª— -->
<div class="modal fade" id="mapModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg"> <!-- å¤§å¼¹çª— -->
        <div class="modal-content rounded-4 border-0" style="overflow: hidden;">

            <!-- åœ°å›¾å®¹å™¨ -->
            <div style="position: relative; height: 450px; background: #fdfdfd;">
                <div id="china-map" style="width: 100%; height: 100%;"></div>

                <!-- é¡¶éƒ¨æµ®å±‚ï¼šå…³é—­æŒ‰é’® -->
                <button type="button" class="btn-close position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"
                        style="z-index: 10;"></button>

                <!-- åº•éƒ¨æµ®å±‚ï¼šæµªæ¼«è·ç¦» -->
                <div id="distance-bar" class="position-absolute bottom-0 start-0 w-100 p-3 text-center"
                     style="background: rgba(255,255,255,0.9); backdrop-filter: blur(5px); border-top: 1px solid #eee;">
                    <div class="fw-bold text-dark" id="distance-text" style="font-family: cursive;">
                        <!-- JS å¡«å……è·ç¦» -->
                    </div>
                </div>
            </div>

            <!-- æ§åˆ¶åŒº -->
            <div class="modal-footer bg-light border-0 justify-content-between">
                <div class="d-flex align-items-center gap-2 w-100">
                    <form action="/add_footprint" method="POST" class="d-flex gap-2 w-100">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="family_id" id="map_fam_id">
                        <input type="text" name="city_name" class="form-control form-control-sm rounded-pill"
                               placeholder="è¾“å…¥å»è¿‡çš„åŸå¸‚ (å¦‚: æ­å·)" required>
                        <button class="btn btn-sm btn-dark rounded-pill px-3" style="white-space: nowrap;">+ ç‚¹äº®
                        </button>
                    </form>
                </div>

                <!-- å·²ç‚¹äº®åˆ—è¡¨å¼€å…³ -->
                <button class="btn btn-sm btn-link text-muted p-0" type="button" data-bs-toggle="collapse"
                        data-bs-target="#footprintList">
                    æŸ¥çœ‹åˆ—è¡¨ <i class="fas fa-chevron-down"></i>
                </button>
            </div>

            <!-- æŠ˜å åˆ—è¡¨ -->
            <div class="collapse bg-light px-3 pb-3" id="footprintList">
                <div id="footprint-tags" class="d-flex flex-wrap gap-2">
                    <!-- JS å¡«å…… -->
                </div>
            </div>
        </div>
    </div>
</div>
<!-- ğŸ§˜â€â™‚ï¸ èµ›åšæœ¨é±¼ (éšè—å±‚) -->
<div id="zen-mode">
    <div class="zen-close" onclick="toggleZenMode()">Ã—</div>

    <!-- æœ¨é±¼æœ¬ä½“ (è¿™é‡Œç”¨ä¸ªæ•²ä»£ç çš„ Emoji æˆ–è€… ğŸŸ) -->
    <div class="muyu-icon" id="muyu" onclick="knockMuyu()">âŒ¨ï¸</div>

    <div class="merit-counter">åŠŸå¾·: <span id="merit-count">0</span></div>
    <div class="small text-muted mt-2">ç‚¹å‡»ç§¯ç´¯æœŸæœ«å¥½è¿</div>
</div>
<!-- [æ–°å¢] ğŸ æ‘¸é±¼è´ªåƒè›‡å¼¹çª— -->
<!-- [å‡çº§ç‰ˆ] ğŸ è´ªåƒè›‡ + æ’è¡Œæ¦œ å¼¹çª— -->
<div id="snake-modal"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:10000; flex-direction:column; align-items:center; justify-content:center;">

    <!-- é¡¶éƒ¨åˆ‡æ¢æ  -->
    <div class="mb-3 d-flex gap-3">
        <button class="btn btn-sm btn-outline-light active" id="btn-game-view" onclick="switchSnakeView('game')">ğŸ®
            æ¸¸æˆ
        </button>
        <button class="btn btn-sm btn-outline-warning" id="btn-rank-view" onclick="switchSnakeView('rank')">ğŸ† æ’è¡Œæ¦œ
        </button>
    </div>

    <!-- A. æ¸¸æˆåŒºåŸŸ -->
    <div id="snake-game-area" style="text-align: center;">
        <canvas id="snake-game" width="300" height="300"
                style="background:#2d3436; border:2px solid #555; border-radius:8px; display:block;"></canvas>

        <div class="text-white mt-3 d-flex justify-content-between px-2">
            <span>å¾—åˆ†: <span id="snake-score" class="fw-bold text-success">0</span></span>
            <span class="small text-muted">å†å²æœ€é«˜: <span id="my-high-score">--</span></span>
        </div>

        <!-- æ‰‹æœºç«¯æ–¹å‘é”® -->
        <div class="mt-4 d-grid gap-2 mx-auto" style="grid-template-columns: 1fr 1fr 1fr; width: 180px;">
            <div></div>
            <button class="btn btn-secondary py-3" onclick="snakeDir('up')">â¬†ï¸</button>
            <div></div>
            <button class="btn btn-secondary py-3" onclick="snakeDir('left')">â¬…ï¸</button>
            <button class="btn btn-secondary py-3" onclick="snakeDir('down')">â¬‡ï¸</button>
            <button class="btn btn-secondary py-3" onclick="snakeDir('right')">â¡ï¸</button>
        </div>
    </div>

    <!-- B. æ’è¡Œæ¦œåŒºåŸŸ -->
    <div id="snake-rank-area"
         style="display:none; width: 300px; height: 400px; background: #fff; border-radius: 12px; overflow: hidden; color: #333; position: relative;">
        <div class="p-3 bg-warning text-dark fw-bold text-center">ğŸ† è´ªåƒè›‡äº‰éœ¸èµ›</div>

        <div id="rank-list" style="overflow-y: auto; height: 280px; padding: 0;">
            <!-- JS å¡«å…… -->
            <div class="text-center py-5 text-muted">åŠ è½½ä¸­...</div>
        </div>

        <!-- [æ–°å¢] åº•éƒ¨æŒ‰é’®åŒº -->
        <div class="p-2 border-top bg-light d-flex justify-content-center">
            <button class="btn btn-success w-75 fw-bold rounded-pill shadow-sm" onclick="restartSnake()">
                ğŸ”„ å†æ¥ä¸€å±€
            </button>
        </div>
    </div>

    <button class="btn btn-danger mt-4 rounded-pill px-4" onclick="closeSnakeGame()">ä¸ç©äº†</button>
</div>

<!-- [ç»ˆæé˜²è¯¯è§¦ç‰ˆ] é¡µè„šéšè—å…¥å£ -->
<!-- [ç»ˆæé€‚é…] é¡µè„šéšè—å…¥å£ -->
<div class="text-center py-4 mb-5"
     onclick="triggerSnake()"
     style="opacity: 0.1;
                cursor: pointer;
                touch-action: none;           /* [æ ¸å¿ƒ] ç¦æ­¢ç¼©æ”¾/æ»šåŠ¨ */
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                user-select: none;
                -webkit-tap-highlight-color: transparent;">
    <small>v{{ app_version }} Â· Python â¤ï¸ Family</small>
</div>
<!-- å¼•å…¥ Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // 1. å®‰å…¨æ¥æ”¶æ•°æ® (åŠ äº†é»˜è®¤å€¼ {})
    const familyMembersMap = {{ family_members_dict | tojson | safe }} || {};
    const userMap = {{ user_map | tojson | safe }} || {};
    const currentUserId = '{{ current_user_id }}';
    const currentUserName = '{{ user_name }}';

    // æ˜¾ç¤ºåŠ è½½å±‚
    function showLoading() {
        const overlay = document.getElementById('loading-overlay');
        if (overlay) overlay.style.display = 'flex';
    }

    // [ä¿®æ”¹] å¢åŠ äº†ç¬¬4ä¸ªå‚æ•° ownerIds (å·²æœ‰ä¸»äººçš„IDåˆ—è¡¨)
    function openEditPetModal(id, name, familyId, ownerIds) {
        console.log("ç‚¹å‡»ç¼–è¾‘:", id, name, familyId, ownerIds);

        // 1. å¡«å……åŸºç¡€ä¿¡æ¯
        document.getElementById('edit_pet_id').value = id;
        document.getElementById('add_owner_pet_id').value = id;
        document.getElementById('edit_pet_name').value = name;

        // 2. åŠ¨æ€ç”Ÿæˆä¸‹æ‹‰æ¡†
        const select = document.querySelector('select[name="new_owner_id"]');
        select.innerHTML = '<option value="" disabled selected>é€‰æ‹©å®¶åº­æˆå‘˜...</option>';

        // ç¡®ä¿ ownerIds æ˜¯ä¸ªæ•°ç»„ (é˜²é”™)
        const currentOwners = ownerIds || [];

        const members = (familyId && familyMembersMap[String(familyId)]) ? familyMembersMap[String(familyId)] : [];

        if (members.length === 0) {
            const opt = new Option("æš‚æ— å…¶ä»–æˆå‘˜", "");
            select.add(opt);
        } else {
            members.forEach(uid => {
                // æ’é™¤æˆ‘è‡ªå·±ï¼Œä¸”ç”¨æˆ·å­˜åœ¨
                if (uid !== currentUserId && userMap[uid]) {
                    let displayName = userMap[uid].name;
                    let isDisabled = false;

                    // [æ ¸å¿ƒé€»è¾‘] å¦‚æœè¯¥ç”¨æˆ·å·²ç»åœ¨ä¸»äººåˆ—è¡¨é‡Œ
                    if (currentOwners.includes(uid)) {
                        displayName += " (å·²æ˜¯ä¸»äºº)";
                        isDisabled = true;
                    }

                    const opt = new Option(displayName, uid);
                    if (isDisabled) {
                        opt.disabled = true; // ç¦ç”¨é€‰æ‹©
                    }
                    select.add(opt);
                }
            });
        }

        // 3. æ˜¾ç¤ºå¼¹çª—
        new bootstrap.Modal(document.getElementById('editPetModal')).show();
    }


    /**
     * åœºæ™¯1ï¼šå‹ç¼©å¹¶è‡ªåŠ¨æäº¤ (ç”¨äºï¼šå® ç‰©æ‹ç…§ã€å¤´åƒä¸Šä¼ )
     * é€‰ä¸­å›¾ç‰‡ -> å‹ç¼© -> æ„é€ æ–°æ–‡ä»¶ -> æ›¿æ¢ Input -> æäº¤ Form
     */
    function handleCompressAndSubmit(input, formId) {
        const file = input.files[0];
        if (!file) return;

        showLoading(); // å¼€å¯ Loading

        new Compressor(file, {
            quality: 0.6, // 0.6 è´¨é‡é€šå¸¸åªæœ‰åŸå›¾ 10% å¤§å°
            maxWidth: 1200, // é™åˆ¶å®½åº¦ï¼Œé˜²æ­¢è¶…å¤§å›¾
            success(result) {
                const dt = new DataTransfer();
                dt.items.add(new File([result], file.name, {type: file.type}));
                input.files = dt.files;
                document.getElementById(formId).submit();
            },
            error(err) {
                console.error('å‹ç¼©å¤±è´¥ï¼Œå°è¯•åŸå›¾ä¸Šä¼ ', err);
                document.getElementById(formId).submit();
            },
        });
    }

    /**
     * åœºæ™¯2ï¼šå‹ç¼©å¹¶é¢„è§ˆ (ç”¨äºï¼šå‘å¸ƒåŠ¨æ€)
     * é€‰ä¸­å›¾ç‰‡ -> å‹ç¼© -> æ›¿æ¢ Input -> æ˜¾ç¤ºé¢„è§ˆå›¾ -> (ç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‘å¸ƒ)
     */
    function handleCompressAndPreview(input) {
        const file = input.files[0];
        if (!file) return;

        new Compressor(file, {
            quality: 0.6,
            maxWidth: 1600,
            success(result) {
                // æ›¿æ¢ input ä¸­çš„æ–‡ä»¶
                const dt = new DataTransfer();
                dt.items.add(new File([result], file.name, {type: file.type}));
                input.files = dt.files;

                // è¯»å–å¹¶é¢„è§ˆ
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('preview-img').src = e.target.result;
                    document.getElementById('preview-container').classList.remove('d-none');
                }
                reader.readAsDataURL(result);
            },
            error(err) {
                console.error(err.message);
            }
        });
    }

    function clearPreview() {
        document.getElementById('momentPhotoInput').value = "";
        document.getElementById('preview-container').classList.add('d-none');
    }

    // å¤åˆ¶é‚€è¯·ç 
    function copyCode(el) {
        const text = el.innerText;
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text).then(() => {
                alert('é‚€è¯·ç  [' + text + '] å·²å¤åˆ¶ï¼');
            }).catch(err => {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é•¿æŒ‰å¤åˆ¶');
            });
        } else {
            alert('è¯·é•¿æŒ‰é‚€è¯·ç æ‰‹åŠ¨å¤åˆ¶');
        }
    }

    // åŠ¨æ€è¡¨å•æ‰‹åŠ¨æäº¤æ—¶ï¼Œä¹Ÿæ˜¾ç¤º loading
    const momentForm = document.getElementById('momentForm');
    if (momentForm) {
        momentForm.addEventListener('submit', function () {
            showLoading();
        });
    }
    // æ›´æ–°æ—¥å¿—é€»è¾‘
    document.addEventListener('DOMContentLoaded', function () {
        {% if latest_update %}
            const serverVersion = '{{ latest_update.version }}';
            // [æ ¸å¿ƒä¿®æ”¹] Key åŠ ä¸Šå½“å‰ç”¨æˆ·IDï¼Œå®ç°å¤šè´¦å·éš”ç¦»
            const storageKey = 'app_version_' + '{{ current_user_id }}';
            const localVersion = localStorage.getItem(storageKey);

            // å¦‚æœæœ¬åœ°æ²¡å­˜ç‰ˆæœ¬ï¼Œæˆ–è€…ç‰ˆæœ¬ä¸ä¸€è‡´ -> å¼¹çª—
            if (localVersion !== serverVersion) {
                const modal = new bootstrap.Modal(document.getElementById('updateModal'));
                modal.show();
            }
        {% endif %}
        const reminders = document.querySelectorAll('[id^="reminder-box-"]');
        reminders.forEach(box => {
            const id = box.id.replace('reminder-box-', '');
            if (localStorage.getItem('dismissed_reminder_' + id)) {
                box.classList.add('d-none'); // æ—¢ç„¶çœ‹è¿‡äº†ï¼Œå°±éšè—
            }
        });
        // å»¶è¿Ÿ 300ms æ¶ˆå¤±ï¼Œè®©åŠ¨ç”»ç¨å¾®å±•ç¤ºä¸€ä¸‹ï¼Œé¿å…é—ªçƒ
        setTimeout(() => {
            const loader = document.getElementById('global-loader');
            if (loader) {
                loader.style.opacity = '0';
                // ç­‰æ·¡å‡ºåŠ¨ç”»æ’­å®Œå†ç§»é™¤å ä½ï¼Œæˆ–è€…éšè—
                setTimeout(() => loader.style.display = 'none', 300);
            }
        }, 300);
        const muyu = document.getElementById('muyu');
        if (muyu) {
            muyu.addEventListener('touchend', function (e) {
                // æ‹¦æˆªæµè§ˆå™¨è¡Œä¸º (ç¼©æ”¾/èœå•)
                if (e.cancelable) e.preventDefault();
                // æ‰‹åŠ¨è§¦å‘æ•²å‡»
                knockMuyu();
            }, {passive: false});
        }

        // 2. ç»™é¡µè„šè´ªåƒè›‡å…¥å£åŠ é”
        // è‡ªåŠ¨æ‰¾åˆ°é‚£ä¸ªç»‘å®šäº† triggerSnake çš„ div
        const footer = document.querySelector('div[onclick="triggerSnake()"]');
        if (footer) {
            footer.addEventListener('touchend', function (e) {
                if (e.cancelable) e.preventDefault();
                triggerSnake();
            }, {passive: false});
        }

        // 3. ç»™ ID å½©è›‹å…¥å£åŠ é”
        // è‡ªåŠ¨æ‰¾åˆ°é‚£ä¸ªç»‘å®šäº† triggerSecret çš„ div
        const idArea = document.querySelector('div[onclick="triggerSecret()"]');
        if (idArea) {
            idArea.addEventListener('touchend', function (e) {
                if (e.cancelable) e.preventDefault();
                triggerSecret();
            }, {passive: false});
        }
    });

    function dismissReminder(id) {
        localStorage.setItem('dismissed_reminder_' + id, 'true');
    }

    function closeUpdateModal(version) {
        // [æ ¸å¿ƒä¿®æ”¹] å­˜çš„æ—¶å€™ä¹Ÿå¸¦ä¸Šç”¨æˆ·ID
        const storageKey = 'app_version_' + '{{ current_user_id }}';
        localStorage.setItem(storageKey, version);

        const modalEl = document.getElementById('updateModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();
    }

    // æ‰“å¼€å€’è®¡æ—¶è®¾ç½®
    function openReunionModal(fid, name, date) {
        document.getElementById('reunion_fam_id').value = fid;
        document.getElementById('reunion_name').value = name;
        document.getElementById('reunion_date').value = date;
        new bootstrap.Modal(document.getElementById('reunionModal')).show();
    }

    // æ¸…é™¤æ—¥æœŸ (é€šè¿‡æŠŠæ—¥æœŸè®¾ä¸ºç©ºæäº¤)
    function clearReunionDate() {
        if (confirm('ç¡®å®šè¦ç§»é™¤è¿™ä¸ªå€’è®¡æ—¶å—ï¼Ÿ')) {
            document.getElementById('reunion_date').value = '';
            // æäº¤è¡¨å•
            document.querySelector('#reunionModal form').submit();
        }
    }

    // æ‰“å¼€å¤©æ°”è®¾ç½®
    function openWeatherModal(fid, type, currentName) {
        document.getElementById('weather_fam_id').value = fid;
        document.getElementById('weather_type').value = type;
        document.getElementById('weather_city_name').value = currentName;

        // åŠ¨æ€æ”¹ä¸€ä¸‹æ ‡é¢˜ï¼Œä½“éªŒæ›´å¥½
        const label = type === 'home' ? 'ğŸ  è®¾ç½®è€å®¶åŸå¸‚ (çˆ¶æ¯)' : 'ğŸ“ è®¾ç½®è¿œæ–¹åŸå¸‚ (æˆ‘)';
        document.getElementById('weather_label').innerText = label;

        new bootstrap.Modal(document.getElementById('weatherModal')).show();
    }

    // [ç»ˆæé€»è¾‘æ¢å¤ç‰ˆ] æ™ºèƒ½å¤©æ°”æé†’
    function sendReminder(famId, city, weather, temp, dressText, airCategory) {
        let msg = "";
        const tempNum = parseInt(temp);
        // å¤„ç†ç©¿è¡£å»ºè®®æ–‡å­— (å»æ‰æœ«å°¾å¥å·)
        const dressTips = dressText ? dressText.replace(/ã€‚$/, '') : '';

        // --- 1. æ¶åŠ£å¤©æ°” (é›¨/é›ª/å†°é›¹/é›·) ---
        if (weather.includes("é›¨")) {
            msg = `ğŸŒ§ï¸ ${city}ä¸‹é›¨å•¦ï¼Œå‡ºé—¨è®°å¾—å¸¦ä¼ï¼Œåˆ«æ·‹æ¹¿äº†ï¼`;
        } else if (weather.includes("é›ª")) {
            msg = `â„ï¸ ${city}ä¸‹é›ªäº†ï¼Œè·¯æ»‘æ³¨æ„å®‰å…¨ï¼Œå¤šç©¿ç‚¹ï¼`;
        } else if (weather.includes("å†°é›¹") || weather.includes("é›·")) {
            msg = `â›ˆï¸ ${city}å¤©æ°”æ¶åŠ£ (${weather})ï¼Œæ³¨æ„å®‰å…¨ï¼Œå°½é‡å¾…åœ¨å®¤å†…ï¼`;
        }

            // --- 2. ç©ºæ°”è´¨é‡ (æ±¡æŸ“) ---
        // åªè¦ä¸æ˜¯ "ä¼˜" æˆ– "è‰¯"ï¼Œéƒ½ç®—ä¸å¤ªå¥½
        else if (airCategory && airCategory !== "ä¼˜" && airCategory !== "è‰¯") {
            msg = `ğŸ˜· ${city}ä»Šå¤©ç©ºæ°”ä¸å¤ªå¥½ï¼ˆ${airCategory}ï¼‰ï¼Œå‡ºé—¨è®°å¾—æˆ´å£ç½©å“¦ï¼`;
        }

        // --- 3. èƒ½è§åº¦ (é›¾/éœ¾/æ²™/å°˜) ---
        else if (weather.includes("é›¾") || weather.includes("éœ¾") || weather.includes("æ²™") || weather.includes("å°˜")) {
            msg = `ğŸŒ«ï¸ ${city}æœ‰${weather}ï¼Œèƒ½è§åº¦ä¸é«˜ï¼Œå‡ºé—¨æ³¨æ„å®‰å…¨ï¼Œæˆ´å¥½å£ç½©ã€‚`;
        }

        // --- 4. æç«¯æ°”æ¸© (å¤ªå†·/å¤ªçƒ­) ---
        else if (tempNum <= 10) {
            // å¦‚æœæœ‰å®˜æ–¹å»ºè®®å°±ç”¨å®˜æ–¹çš„ï¼Œæ²¡æœ‰å°±å…œåº•
            msg = `ğŸ¥¶ ${city}å¾ˆå†· (${temp}â„ƒ)ï¼Œ${dressTips || 'è®°å¾—ç©¿åšç‚¹ä¿æš–'}ã€‚`;
        } else if (tempNum >= 30) {
            msg = `ğŸ¥µ ${city}é«˜æ¸© ${temp}â„ƒï¼Œ${dressTips || 'åˆ«ä¸­æš‘äº†ï¼Œå¤šå–æ°´'}ã€‚`;
        }

        // --- 5. é˜´å¤©/å¤šäº‘ ---
        else if (weather.includes("é˜´")) {
            msg = `â˜ï¸ ${city}ä»Šå¤©æ˜¯é˜´å¤©ï¼Œè™½ç„¶æ²¡æœ‰å¤§å¤ªé˜³ï¼Œä½†å¿ƒæƒ…ä¹Ÿè¦ç¾ç¾çš„å“¦ï¼`;
        } else if (weather.includes("äº‘")) {
            msg = `â›… ${city}å¤šäº‘å¤©æ°”ï¼Œæ°”æ¸©${temp}â„ƒï¼Œå‡ºå»èµ°èµ°é€é€æ°”å§~`;
        }

        // --- 6. æ™´å¤©/èˆ’é€‚ (å…œåº•) ---
        else {
            const airText = airCategory ? `ç©ºæ°”${airCategory}` : '';
            if (dressTips) {
                msg = `ğŸŒ¤ï¸ ${city}å¤©æ°”ä¸é”™ (${weather} ${temp}â„ƒ ${airText})ï¼Œ${dressTips}ã€‚`;
            } else {
                msg = `âœ¨ ${city}å¤©æ°”ä¸é”™ (${weather} ${temp}â„ƒ ${airText})ï¼Œç¥ä½ ä»Šå¤©å¥½å¿ƒæƒ…ï¼`;
            }
        }

        if (!confirm(`è¦å‘é€è¿™æ¡æé†’ç»™å®¶äººå—ï¼Ÿ\n\n"${msg}"`)) return;

        // --- æäº¤è¡¨å• ---
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/send_family_reminder';

        const inputCsrf = document.createElement('input');
        inputCsrf.type = 'hidden';
        inputCsrf.name = 'csrf_token';
        inputCsrf.value = '{{ csrf_token() }}';

        const inputFamId = document.createElement('input');
        inputFamId.type = 'hidden';
        inputFamId.name = 'family_id';
        inputFamId.value = famId;

        const inputContent = document.createElement('input');
        inputContent.type = 'hidden';
        inputContent.name = 'content';
        inputContent.value = msg;

        form.appendChild(inputCsrf);
        form.appendChild(inputFamId);
        form.appendChild(inputContent);
        document.body.appendChild(form);
        showLoading();
        form.submit();
    }

    // æ‰“å¼€è®¸æ„¿
    function openWishModal(fid) {
        document.getElementById('wish_fam_id').value = fid;
        new bootstrap.Modal(document.getElementById('wishModal')).show();
    }

    // åˆ‡æ¢è®¸æ„¿çŠ¶æ€ (ç‚¹å‡»èœåè§¦å‘)
    function changeWishStatus(wishId, currentStatus) {
        // åˆ›å»ºéšè—è¡¨å•æäº¤
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/operate_wish';

        const i1 = document.createElement('input');
        i1.type = 'hidden';
        i1.name = 'csrf_token';
        i1.value = '{{ csrf_token() }}';
        const i2 = document.createElement('input');
        i2.type = 'hidden';
        i2.name = 'wish_id';
        i2.value = wishId;
        const i3 = document.createElement('input');
        i3.type = 'hidden';
        i3.name = 'action';
        i3.value = 'next_status';
        const i4 = document.createElement('input');
        i4.type = 'hidden';
        i4.name = 'current_status';
        i4.value = currentStatus;

        form.appendChild(i1);
        form.appendChild(i2);
        form.appendChild(i3);
        form.appendChild(i4);
        document.body.appendChild(form);
        if (currentStatus === 'bought' || currentStatus === 'wanted') {
            fireConfetti(); // ğŸ‰ å–·å°„å§ï¼
        }
        form.submit();
    }

    // ç‚¹å‡»å¤´åƒå¤„ç† (ä¿®å¤åŠ¨ç”»ç¬é—ªé—®é¢˜)
    function handleMemberClick(uid, name, famId) {

        // 1. è·å–å¤´åƒå…ƒç´ 
        const head = document.getElementById('head-' + famId + '-' + uid);

        // 2. æ’­æ”¾ Qå¼¹åŠ¨ç”» (å…ˆä¸ç®¡æ˜¯ä»€ä¹ˆæ“ä½œï¼Œç‚¹äº†å°±å¾—è·³)
        // ç§»é™¤æ—§ç±»ä»¥é˜²ä¸‡ä¸€ï¼Œå†æ·»åŠ æ–°ç±»è§¦å‘åŠ¨ç”»
        head.classList.remove('shake-animation');
        void head.offsetWidth; // å¼ºåˆ¶æµè§ˆå™¨é‡ç»˜ï¼Œä¿è¯åŠ¨ç”»é‡ç½®
        head.classList.add('shake-animation');

        // 3. éœ‡åŠ¨åé¦ˆ (å¦‚æœæ‰‹æœºæ”¯æŒ)
        if (navigator.vibrate) navigator.vibrate(50);

        // === é€»è¾‘åˆ†æµ ===

        // æƒ…å†µ A: ç‚¹çš„æ˜¯æˆ‘è‡ªå·± -> ç«‹å³å¼¹çª—åˆ‡æ¢çŠ¶æ€
        if (uid === currentUserId) {
            // å»¶è¿Ÿä¸€ç‚¹ç‚¹å‡ºå¼¹çª—ï¼Œä½“éªŒæ›´é¡ºæ»‘
            setTimeout(() => {
                new bootstrap.Modal(document.getElementById('statusModal')).show();
            }, 200);
        }

        // æƒ…å†µ B: ç‚¹çš„æ˜¯åˆ«äºº -> æ‹ä¸€æ‹
        else {
            // è¿™é‡Œçš„ confirm ä¼šæ‰“æ–­åŠ¨ç”»ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠå®ƒæ”¾åœ¨åŠ¨ç”»ä¹‹åï¼Œæˆ–è€…æ¥å—æ‰“æ–­
            if (confirm(`è¦æ‹ä¸€æ‹ ${name} å—ï¼Ÿ`)) {

                // [å…³é”®ä¿®å¤] åˆ›å»ºè¡¨å•ï¼Œä½†ä¸ç«‹å³æäº¤
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/nudge_member';

                const i1 = document.createElement('input');
                i1.type = 'hidden';
                i1.name = 'csrf_token';
                i1.value = '{{ csrf_token() }}';
                const i2 = document.createElement('input');
                i2.type = 'hidden';
                i2.name = 'target_uid';
                i2.value = uid;
                const i3 = document.createElement('input');
                i3.type = 'hidden';
                i3.name = 'target_name';
                i3.value = name;
                const i4 = document.createElement('input');
                i4.type = 'hidden';
                i4.name = 'family_id';
                i4.value = famId;

                form.appendChild(i1);
                form.appendChild(i2);
                form.appendChild(i3);
                form.appendChild(i4);
                document.body.appendChild(form);

                // [æ ¸å¿ƒ] è®©åŠ¨ç”»é£ä¸€ä¼šå„¿ (700ms) å†æäº¤åˆ·æ–°
                setTimeout(() => {
                    showLoading(); // æ˜¾ç¤ºåŠ è½½åœˆ
                    form.submit(); // æäº¤åˆ·æ–°
                }, 700);
            } else {
                // å¦‚æœå–æ¶ˆäº†ï¼Œç§»é™¤åŠ¨ç”»ç±»
                head.classList.remove('shake-animation');
            }
        }
    }

    // ================= å®¶åº­ç­›é€‰é€»è¾‘ (å¸¦è®°å¿†) =================

    // 1. é¡µé¢åŠ è½½å®Œæˆåï¼šè‡ªåŠ¨æ¢å¤ä¸Šæ¬¡çš„é€‰æ‹©
    document.addEventListener('DOMContentLoaded', function () {
        // ... åŸæœ‰çš„å…¶ä»–åˆå§‹åŒ–é€»è¾‘ (å¦‚æ›´æ–°æ—¥å¿—) ...

        // [æ–°å¢] è¯»å–ä¸Šæ¬¡é€‰ä¸­çš„å®¶åº­ ID
        const lastFamId = localStorage.getItem('last_filter_family');

        // å¦‚æœæœ‰è®°å½•ï¼Œä¸”ä¸æ˜¯é»˜è®¤çš„ 'all'ï¼Œä¸”é¡µé¢ä¸Šç¡®å®æœ‰è¿™ä¸ªæŒ‰é’® (é˜²æ­¢é€€ç¾¤åæŠ¥é”™)
        if (lastFamId && lastFamId !== 'all') {
            const targetBtn = document.getElementById('filter-btn-' + lastFamId);
            if (targetBtn) {
                // æ¨¡æ‹Ÿç‚¹å‡»ï¼Œè§¦å‘ç­›é€‰æ•ˆæœ
                filterFamily(lastFamId, targetBtn);
            }
        }
    });

    // 2. ç­›é€‰å‡½æ•°
    function filterFamily(famId, btn) {
        // [æ–°å¢] è®°ä¸‹æ¥ï¼ä¸‹æ¬¡åˆ·æ–°æˆ‘è¿˜é€‰è¿™ä¸ª
        localStorage.setItem('last_filter_family', famId);

        // æ ·å¼åˆ‡æ¢
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // å†…å®¹æ˜¾ç¤º/éšè—
        const allItems = document.querySelectorAll('.fam-item');

        if (famId === 'all') {
            allItems.forEach(item => item.classList.remove('d-none'));
        } else {
            allItems.forEach(item => {
                if (item.classList.contains('fam-' + famId)) {
                    item.classList.remove('d-none');
                } else {
                    item.classList.add('d-none');
                }
            });
        }
    }

    let currentFamId = null;

    // æ‰“å¼€æ·»åŠ å¼¹çª—
    function openAddEventModal(fid) {
        currentFamId = fid;
        document.getElementById('add_event_fam_id').value = fid;
        // å¦‚æœæ˜¯ä»åˆ—è¡¨é¡µè·³è½¬è¿‡æ¥çš„ï¼Œå…ˆå…³åˆ—è¡¨é¡µ
        const listModal = bootstrap.Modal.getInstance(document.getElementById('eventListModal'));
        if (listModal) listModal.hide();

        new bootstrap.Modal(document.getElementById('addEventModal')).show();
    }

    // æ‰“å¼€åˆ—è¡¨å¼¹çª— (ç‚¹å‡»æ—¥å†å¡ç‰‡è§¦å‘)
    function openEventListModal(fid, events) {
        currentFamId = fid;
        const listBody = document.getElementById('eventListBody');
        listBody.innerHTML = '';

        if (!events || events.length === 0) {
            listBody.innerHTML = '<div class="p-5 text-center text-muted"><i class="far fa-calendar-times fa-2x mb-3"></i><br>æš‚æ— è®°å½•</div>';
        } else {
            events.forEach(e => {
                const isReunion = e.type === 'reunion';
                const badge = e.is_lunar ? '<span class="badge bg-light text-secondary border ms-1" style="font-weight:normal;">å†œ</span>' : '';

                // --- 1. è®¡ç®—æ˜¾ç¤ºé€»è¾‘ (æ‹’ç»é˜´é—´è´Ÿæ•°) ---
                let dayDisplayHtml = '';
                let titleClass = 'fw-bold text-dark';

                if (e.data.days === 0) {
                    // ä»Šå¤©
                    dayDisplayHtml = '<span class="badge bg-success rounded-pill px-3">ä»Šå¤©</span>';
                } else if (e.data.days > 0) {
                    // æœªæ¥ (çº¢è‰²/é»‘è‰²)
                    const color = e.data.days <= 7 ? 'text-danger' : 'text-dark';
                    dayDisplayHtml = `<span class="fs-5 fw-bold ${color}">${e.data.days} <small class="fs-6 fw-normal text-muted">å¤©å</small></span>`;
                } else {
                    // [ä¿®å¤] è¿‡å» (ç°è‰²ï¼Œå–ç»å¯¹å€¼)
                    titleClass = 'fw-bold text-muted text-decoration-line-through'; // æ ‡é¢˜åŠ åˆ é™¤çº¿ï¼Œè¡¨ç¤ºå·²è¿‡å»
                    dayDisplayHtml = `<span class="text-muted small">å·²è¿‡ ${Math.abs(e.data.days)} å¤©</span>`;
                }

                // ç´¯è®¡å¤©æ•°æ˜¾ç¤º
                const totalInfo = (e.data.total > 0 && e.data.is_repeat) ?
                    `<div class="text-primary small mt-1" style="font-size:11px;">â¤ï¸ å·²ç´¯è®¡ ${e.data.total} å¤©</div>` : '';

                // --- 2. ç»„è£… HTML (ä¼˜åŒ–æŒ‰é’®ç‚¹å‡»åŒºåŸŸ) ---
                const html = `
                    <div class="list-group-item d-flex justify-content-between align-items-center py-3">
                        <div class="pe-3">
                            <div class="${titleClass}" style="font-size: 15px;">${e.title} ${badge}</div>
                            <div class="small text-muted mt-1" style="font-size: 12px;">ç›®æ ‡: ${e.data.date_str}</div>
                            ${totalInfo}
                        </div>

                        <div class="d-flex align-items-center gap-3">
                            <!-- å¤©æ•°æ˜¾ç¤º -->
                            <div class="text-end" style="min-width: 60px;">
                                ${dayDisplayHtml}
                            </div>

                            <!-- [ä¿®å¤] åˆ é™¤æŒ‰é’®ï¼šåŠ å¤§ç‚¹å‡»èŒƒå›´ (px-2 py-2) -->
                            <form action="/delete_family_event" method="POST" onsubmit="return confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="family_id" value="${fid}">
                                <input type="hidden" name="event_id" value="${e.id || ''}">
                                <input type="hidden" name="type" value="${isReunion ? 'reunion' : 'event'}">

                                <button class="btn btn-sm btn-light text-secondary border-0 px-3 py-2 rounded-3" title="åˆ é™¤">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                `;
                listBody.innerHTML += html;
            });
        }
        new bootstrap.Modal(document.getElementById('eventListModal')).show();
    }

    // åˆ—è¡¨é¡µ -> è·³è½¬æ·»åŠ é¡µ
    function switchToAddModal() {
        openAddEventModal(currentFamId);
    }

    // === ğŸ§˜â€â™‚ï¸ èµ›åšæœ¨é±¼é€»è¾‘ ===
    let merit = parseInt(localStorage.getItem('my_merit') || 0);
    document.getElementById('merit-count').innerText = merit;

    // çŸ­ä¿ƒçš„æœ¨é±¼å£° (Base64)
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function playSound() {
        // ç®€å•çš„åˆæˆéŸ³ï¼Œä¸ç”¨åŠ è½½æ–‡ä»¶
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(800, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.1);
    }

    // æ•²å‡»é€»è¾‘
    function knockMuyu() {
        // 1. æ’­æ”¾å£°éŸ³
        if (audioCtx.state === 'suspended') audioCtx.resume();
        playSound();

        // 2. å¢åŠ æ•°å­—
        merit++;
        document.getElementById('merit-count').innerText = merit;
        localStorage.setItem('my_merit', merit);

        // 3. æ‰‹æœºéœ‡åŠ¨
        if (navigator.vibrate) navigator.vibrate(50);

        // 4. é£˜å­—ç‰¹æ•ˆ
        const texts = ['åŠŸå¾·+1', 'Bug-1', 'ä¸æŒ‚ç§‘', 'å…¨A', 'å‘é‡+1', 'æš´å¯Œ'];
        const text = texts[Math.floor(Math.random() * texts.length)];
        showFloatText(text);

        // 5. å›¾æ ‡åŠ¨ç”»
        const icon = document.getElementById('muyu');
        icon.style.transform = 'scale(0.8)';
        setTimeout(() => icon.style.transform = 'scale(1)', 100);
    }

    function showFloatText(text) {
        const el = document.createElement('div');
        el.className = 'float-text';
        el.innerText = text;

        // éšæœºä½ç½®åç§»
        const x = window.innerWidth / 2 + (Math.random() - 0.5) * 100;
        const y = window.innerHeight / 2 - 100;

        el.style.left = x + 'px';
        el.style.top = y + 'px';

        document.getElementById('zen-mode').appendChild(el);

        // åŠ¨ç”»ç»“æŸååˆ é™¤
        setTimeout(() => el.remove(), 1000);
    }

    // === ğŸšª éšè—å…¥å£é€»è¾‘ ===
    let clickCount = 0;
    let clickTimer = null;

    // ç»‘å®šåˆ°"æˆ‘çš„"é¡µé¢é‡Œçš„ ID æ˜¾ç¤ºå¤„
    function triggerSecret() {
        clickCount++;
        if (clickCount === 5) {
            toggleZenMode();
            clickCount = 0;
        }
        // 2ç§’å†…æ²¡ç‚¹å¤Ÿ5æ¬¡å°±é‡ç½®
        clearTimeout(clickTimer);
        clickTimer = setTimeout(() => clickCount = 0, 2000);
    }

    function toggleZenMode() {
        const panel = document.getElementById('zen-mode');
        panel.style.display = (panel.style.display === 'flex') ? 'none' : 'flex';
    }

    // ================== ğŸ‰ 1. å…¨å±å½©å¸¦ç‰¹æ•ˆ ==================
    function fireConfetti() {
        var count = 200;
        var defaults = {origin: {y: 0.7}};

        function fire(particleRatio, opts) {
            confetti(Object.assign({}, defaults, opts, {
                particleCount: Math.floor(count * particleRatio)
            }));
        }

        fire(0.25, {spread: 26, startVelocity: 55,});
        fire(0.2, {spread: 60,});
        fire(0.35, {spread: 100, decay: 0.91, scalar: 0.8});
        fire(0.1, {spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2});
        fire(0.1, {spread: 120, startVelocity: 45,});
    }

    // [æŒ‚è½½ç‰¹æ•ˆ] ä¿®æ”¹ä¹‹å‰çš„å‡½æ•°ï¼ŒåŠ ä¸Šå½©å¸¦è§¦å‘
    // 1. æ‹ä¸€æ‹æ—¶è§¦å‘
    const originalNudge = window.handleMemberClick; // å‡å¦‚ä½ ä¹‹å‰çš„å‡½æ•°å«è¿™ä¸ª
    // å¦‚æœæ‰¾ä¸åˆ°å¼•ç”¨ï¼Œå°±åœ¨åŸæ¥çš„ handleMemberClick é‡ŒåŠ ä¸€è¡Œ fireConfetti(); å³å¯

    // 2. è®¸æ„¿è¾¾æˆæ—¶è§¦å‘ (ä¿®æ”¹ changeWishStatus å‡½æ•°)
    // æ‰¾åˆ°ä¹‹å‰çš„ changeWishStatusï¼Œåœ¨ form.submit() ä¹‹å‰åŠ å…¥ï¼š
    // if(currentStatus === 'bought') fireConfetti();


    // ================== ğŸ”® 2. èµ›åšè€é»„å† ==================
    document.addEventListener('DOMContentLoaded', function () {
        // åŸºç¡€æ•°æ®æ± 
        const goods = ['å†™ä»£ç ', 'AC', 'å–å¥¶èŒ¶', 'ç¡æ‡’è§‰', 'ç»™å®¶é‡Œæ‰“ç”µè¯', 'åƒçº¢çƒ§è‚‰', 'æ’¸çŒ«', 'é›ç‹—', 'è¡¨ç™½', 'åŠ è–ª', 'ä¸æŒ‚ç§‘'];
        const bads = ['æ”¹éœ€æ±‚', 'å†™Bug', 'é€šå®µ', 'åƒå¤–å–', 'åµæ¶', 'ä¸¢é’¥åŒ™', 'æ–­ç½‘', 'å¿˜è®°ä¿å­˜', 'è¿Ÿåˆ°'];
        const tips = ['ä»Šæ—¥è¿åŠ¿ä»…ä¾›å¨±ä¹ï¼Œçˆ±å’‹å’‹åœ°', 'ä»£ç å†™å¾—å¥½ï¼Œä¸‹ç­å›å®¶æ—©', 'å¤šå–çƒ­æ°´ï¼Œé‡å¯è¯•è¯•', 'è®°å¾—æŒ‰æ—¶åƒé¥­'];

        // éšæœºæ•°ç”Ÿæˆå™¨ (åŸºäºæ—¥æœŸ+ç”¨æˆ·IDï¼Œä¿è¯æ¯å¤©å›ºå®š)
        const dateStr = new Date().toISOString().slice(0, 10);
        const seedStr = dateStr + '{{ current_user_id }}';
        let hash = 0;
        for (let i = 0; i < seedStr.length; i++) {
            hash = ((hash << 5) - hash) + seedStr.charCodeAt(i);
            hash |= 0;
        }
        const random = () => {
            const x = Math.sin(hash++) * 10000;
            return x - Math.floor(x);
        };

        // éšæœºå–å€¼
        const todayGood = goods[Math.floor(random() * goods.length)];
        const todayBad = bads[Math.floor(random() * bads.length)];
        const todayTip = tips[Math.floor(random() * tips.length)];

        // æ¸²æŸ“
        const dateEl = document.getElementById('almanac-date');
        if (dateEl) {
            dateEl.innerText = dateStr;
            document.getElementById('almanac-good').innerText = todayGood;
            document.getElementById('almanac-bad').innerText = todayBad;
            document.getElementById('almanac-tips').innerText = todayTip;
        }
    });


    // ================== ğŸ è´ªåƒè›‡ + æ’è¡Œæ¦œå®Œæ•´é€»è¾‘ (ä¿®å¤ç‰ˆ) ==================

    // [ğŸ”´ è¡¥å›ä¸¢å¤±çš„å˜é‡]
    let snakeClickCount = 0;
    let snakeTimer = null;

    // æ¸¸æˆæ ¸å¿ƒå˜é‡
    let snakeInterval;
    let snake = [{x: 10, y: 10}];
    let food = {x: 15, y: 15};
    let dx = 0;
    let dy = 0;
    let score = 0;
    let isGameRunning = false;
    const gridSize = 15;
    const canvas = document.getElementById('snake-game');
    const ctx = canvas ? canvas.getContext('2d') : null;

    // è§¦å‘å…¥å£ (é¡µè„šç‚¹å‡»)
    function triggerSnake() {
        snakeClickCount++;
        console.log("Debug: ç‚¹å‡»æ¬¡æ•°", snakeClickCount); // æ–¹ä¾¿ä½ è°ƒè¯•

        if (snakeClickCount >= 5) {
            startSnakeGame();
            snakeClickCount = 0;
            // éœ‡åŠ¨æç¤º
            if (navigator.vibrate) navigator.vibrate(100);
        }

        // é‡ç½®è®¡æ—¶å™¨ (1ç§’å†…æ²¡ç‚¹å¤Ÿå°±æ¸…é›¶)
        clearTimeout(snakeTimer);
        snakeTimer = setTimeout(() => {
            snakeClickCount = 0;
        }, 1000);
    }

    function startSnakeGame() {
        const modal = document.getElementById('snake-modal');
        if (modal) {
            modal.style.display = 'flex';
            switchSnakeView('game');
            resetGame();
            window.addEventListener('keydown', handleKey);
            // è·å–ä¸€ä¸‹å½“å‰çš„æœ€é«˜åˆ†å±•ç¤º
            fetchLeaderboard(false);
        } else {
            console.error("æ‰¾ä¸åˆ° snake-modal å…ƒç´ ");
        }
    }

    function closeSnakeGame() {
        document.getElementById('snake-modal').style.display = 'none';
        stopGame();
        window.removeEventListener('keydown', handleKey);
    }

    function resetGame() {
        snake = [{x: 10, y: 10}];
        dx = 0;
        dy = 0;
        score = 0;
        document.getElementById('snake-score').innerText = 0;
        isGameRunning = true;
        if (snakeInterval) clearInterval(snakeInterval);
        snakeInterval = setInterval(gameLoop, 150);
        drawSnake();
    }

    function stopGame() {
        isGameRunning = false;
        if (snakeInterval) clearInterval(snakeInterval);
    }

    // æ¸¸æˆä¸»å¾ªç¯
    function gameLoop() {
        if (!isGameRunning) return;
        const head = {x: snake[0].x + dx, y: snake[0].y + dy};

        if (dx === 0 && dy === 0) return; // è¿˜æ²¡å¼€å§‹åŠ¨

        // æ’å¢™æˆ–æ’è‡ªå·± -> æ¸¸æˆç»“æŸ
        if (head.x < 0 || head.x >= 20 || head.y < 0 || head.y >= 20 || snake.some(s => s.x === head.x && s.y === head.y)) {
            gameOver();
            return;
        }

        snake.unshift(head);

        // åƒé£Ÿç‰©
        if (head.x === food.x && head.y === food.y) {
            score++;
            document.getElementById('snake-score').innerText = score;
            food = {x: Math.floor(Math.random() * 20), y: Math.floor(Math.random() * 20)};
            if (window.fireConfetti) fireConfetti(); // åº†ç¥
        } else {
            snake.pop();
        }
        drawSnake();
    }

    // æ¸¸æˆç»“æŸå¤„ç†
    function gameOver() {
        stopGame();

        // 1. ä¸Šä¼ åˆ†æ•°
        fetch('/api/snake/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}'},
            body: JSON.stringify({score: score})
        })
            .then(res => res.json())
            .then(data => {
                let msg = `Game Over! æœ¬å±€å¾—åˆ†: ${score}`;
                if (data.new_record) msg += "\nğŸ‰ æ­å–œï¼æ‰“ç ´ä¸ªäººçºªå½•ï¼";
                alert(msg);
                // è‡ªåŠ¨åˆ‡åˆ°æ’è¡Œæ¦œçœ‹çœ‹
                switchSnakeView('rank');
            })
            .catch(err => console.error("ä¸Šä¼ åˆ†æ•°å¤±è´¥", err));
    }

    // è§†å›¾åˆ‡æ¢
    function switchSnakeView(view) {
        if (view === 'game') {
            document.getElementById('snake-game-area').style.display = 'block';
            document.getElementById('snake-rank-area').style.display = 'none';
            document.getElementById('btn-game-view').classList.add('active');
            document.getElementById('btn-rank-view').classList.remove('active');
            // å¦‚æœæ¸¸æˆæš‚åœäº†ï¼Œé‡ç½®
            if (!isGameRunning && score === 0) resetGame();
        } else {
            document.getElementById('snake-game-area').style.display = 'none';
            document.getElementById('snake-rank-area').style.display = 'block';
            document.getElementById('btn-game-view').classList.remove('active');
            document.getElementById('btn-rank-view').classList.add('active');
            stopGame(); // çœ‹æ¦œå•æ—¶æš‚åœæ¸¸æˆ
            fetchLeaderboard(true); // åŠ è½½æ•°æ®
        }
    }

    // æ‹‰å–æ’è¡Œæ¦œ
    function fetchLeaderboard(renderHtml) {
        fetch('/api/snake/leaderboard')
            .then(res => res.json())
            .then(list => {
                // æ›´æ–°æˆ‘çš„æœ€é«˜åˆ†
                // æ³¨æ„ï¼šè¿™é‡Œ user_name å¯èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼Œæœ€å¥½åŠ å¼•å·
                const myName = "{{ user_name }}";
                const me = list.find(u => u.display_name === myName);
                if (me) document.getElementById('my-high-score').innerText = me.snake_high_score;

                if (renderHtml) {
                    const el = document.getElementById('rank-list');
                    let html = '';
                    list.forEach((u, index) => {
                        const medal = index === 0 ? 'ğŸ¥‡' : (index === 1 ? 'ğŸ¥ˆ' : (index === 2 ? 'ğŸ¥‰' : index + 1));
                        const avatar = u.avatar_url ? `<img src="${u.avatar_url}" style="width:30px;height:30px;border-radius:50%;object-fit:cover;">` : `<span class="badge bg-secondary rounded-circle d-flex align-items-center justify-content-center" style="width:30px;height:30px;">${u.display_name[0]}</span>`;

                        html += `
                        <div class="d-flex align-items-center justify-content-between p-3 border-bottom">
                            <div class="d-flex align-items-center gap-3">
                                <div class="fw-bold text-muted" style="width:20px;text-align:center;">${medal}</div>
                                ${avatar}
                                <div class="fw-bold text-truncate" style="font-size:14px; max-width: 100px;">${u.display_name}</div>
                            </div>
                            <div class="fw-bold text-warning" style="font-size:18px">${u.snake_high_score}</div>
                        </div>`;
                    });
                    el.innerHTML = html || '<div class="text-center py-5 text-muted">æš‚æ— æ•°æ®ï¼Œå¿«æ¥äº‰ç¬¬ä¸€ï¼</div>';
                }
            })
            .catch(err => console.error("æ’è¡Œæ¦œåŠ è½½å¤±è´¥", err));
    }

    // ç»˜å›¾ä¸æŒ‰é”® (ä¿æŒä¸å˜)
    function drawSnake() {
        if (!ctx) return;
        ctx.fillStyle = '#2d3436';
        ctx.fillRect(0, 0, 300, 300);
        ctx.fillStyle = '#00b894';
        snake.forEach(p => ctx.fillRect(p.x * 15, p.y * 15, 13, 13));
        ctx.fillStyle = '#ff7675';
        ctx.fillRect(food.x * 15, food.y * 15, 13, 13);
    }

    function handleKey(e) {
        if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) e.preventDefault();
        if (e.key === 'ArrowUp') snakeDir('up');
        if (e.key === 'ArrowDown') snakeDir('down');
        if (e.key === 'ArrowLeft') snakeDir('left');
        if (e.key === 'ArrowRight') snakeDir('right');
    }

    function snakeDir(dir) {
        if (dir === 'up' && dy === 0) {
            dx = 0;
            dy = -1;
        }
        if (dir === 'down' && dy === 0) {
            dx = 0;
            dy = 1;
        }
        if (dir === 'left' && dx === 0) {
            dx = -1;
            dy = 0;
        }
        if (dir === 'right' && dx === 0) {
            dx = 1;
            dy = 0;
        }
    }

    // [æ–°å¢] é‡æ–°å¼€å§‹æ¸¸æˆ
    function restartSnake() {
        // åˆ‡æ¢å›æ¸¸æˆè§†å›¾
        switchSnakeView('game');
        // é‡ç½®æ•°æ®å¹¶å¼€å§‹
        resetGame();
    }

    // 2. [ä¿®æ”¹] ç»Ÿä¸€çš„ showLoading å‡½æ•°
    // ä»¥åä¸Šä¼ å›¾ç‰‡ã€å‘å¸ƒåŠ¨æ€ï¼Œéƒ½è°ƒè¿™ä¸ªå‡½æ•°
    function showLoading() {
        const loader = document.getElementById('global-loader');
        if (loader) {
            loader.style.display = 'flex';
            // å¼ºåˆ¶é‡ç»˜ï¼Œç¡®ä¿é€æ˜åº¦å˜å› 1
            requestAnimationFrame(() => {
                loader.style.opacity = '1';
            });
        }
    }

    function preventZoom(e) {
        e.preventDefault(); // é˜»æ­¢æµè§ˆå™¨é»˜è®¤è¡Œä¸º(ç¼©æ”¾)
        e.target.click();   // æ‰‹åŠ¨è§¦å‘ç‚¹å‡»
    }

    // æ³¨å†Œ Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            // æ³¨å†Œåœ¨æ ¹ç›®å½•
            navigator.serviceWorker.register('/sw.js')
                .then(() => console.log('SW Registered'))
                .catch(err => console.log('SW Failed', err));
        });
    }
    // ç‚¹èµåŠŸèƒ½
    // [æœ‹å‹åœˆç‰ˆ] ç‚¹èµé€»è¾‘
    function toggleLike(btn, momentId) {
        const icon = btn.querySelector('i');
        const text = btn.querySelector('span');

        // 1. è§†è§‰é¢„åˆ¤ (UIå˜è‰²)
        const isLiked = btn.classList.contains('liked');
        btn.classList.toggle('liked');
        if (isLiked) {
            icon.classList.remove('fas');
            icon.classList.add('far');
            text.innerText = 'ç‚¹èµ';
        } else {
            icon.classList.remove('far');
            icon.classList.add('fas');
            text.innerText = 'å–æ¶ˆ';
            if (window.fireConfetti) fireConfetti();
            if (navigator.vibrate) navigator.vibrate(50);
        }

        // 2. è¯·æ±‚åç«¯
        fetch('/api/toggle_like', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}'},
            body: JSON.stringify({moment_id: momentId})
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // 3. æ›´æ–°åº•éƒ¨çš„å¤´åƒåˆ—è¡¨
                    const area = document.getElementById('likes-area-' + momentId);
                    const list = document.getElementById('liker-list-' + momentId);

                    if (data.likers && data.likers.length > 0) {
                        area.style.display = 'flex'; // æœ‰èµï¼Œæ˜¾ç¤ºç›’å­

                        // é‡ç»˜å¤´åƒ
                        let html = '';
                        data.likers.forEach(user => {
                            if (user.avatar) {
                                html += `<img src="${user.avatar}" class="liker-avatar" title="${user.name}">`;
                            } else {
                                html += `<div class="liker-avatar bg-secondary text-white d-flex align-items-center justify-content-center small fw-bold">${user.name[0]}</div>`;
                            }
                        });
                        list.innerHTML = html;

                    } else {
                        area.style.display = 'none'; // æ²¡èµäº†ï¼Œéšè—ç›’å­
                    }
                }
            });
    }

    // ================= ğŸ¡ å¹¸è¿å¤§è½¬ç›˜é€»è¾‘ =================
    let wheelCanvas = document.getElementById('wheel-canvas');
    let wheelCtx = wheelCanvas ? wheelCanvas.getContext('2d') : null;
    let currentWheelItems = []; // å½“å‰è½¬ç›˜ä¸Šçš„é€‰é¡¹
    let currentWheelFamId = null;
    let currentRotation = 0;
    let isSpinning = false;
    let currentMode = 'member'; // 'member' æˆ– 'custom'

    // é…è‰²ç›˜ (çº¢é»„è“ç»¿ç´«æ©™)
    const wheelColors = ['#FF6B6B', '#FFD93D', '#6BCB77', '#4D96FF', '#9A6CB9'];

    // 1. æ‰“å¼€å¼¹çª—
    function openWheelModal(fid) {
        currentWheelFamId = fid;
        // é»˜è®¤åˆ‡å›é€‰äººæ¨¡å¼
        document.getElementById('mode-member-tab').click();
        new bootstrap.Modal(document.getElementById('wheelModal')).show();
        // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹ç¡®ä¿æ¨¡æ€æ¡†æ¸²æŸ“å®Œæˆ
        setTimeout(() => setWheelMode('member'), 200);
    }

    // 2. åˆ‡æ¢æ¨¡å¼å¹¶åŠ è½½æ•°æ®
    function setWheelMode(mode) {
        if (isSpinning) return;
        currentMode = mode;
        currentWheelItems = [];

        if (mode === 'member') {
            // ä» familyMembersMap è·å–äººå
            // æ³¨æ„ï¼šfamilyMembersMap çš„ key æ˜¯å­—ç¬¦ä¸²
            const members = familyMembersMap[String(currentWheelFamId)] || [];
            members.forEach(uid => {
                if (userMap[uid]) {
                    // å¦‚æœæ˜¯æˆ‘ï¼Œæ˜¾ç¤º"æˆ‘"ï¼Œå¦åˆ™æ˜¾ç¤ºåå­—
                    currentWheelItems.push(uid === currentUserId ? 'æˆ‘' : userMap[uid].name);
                }
            });
            if (currentWheelItems.length === 0) currentWheelItems = ['æš‚æ— æˆå‘˜'];
        } else {
            // è‡ªå®šä¹‰æ¨¡å¼ï¼šè¯»å–è¾“å…¥æ¡†
            updateCustomWheel();
            return; // updateCustomWheel ä¼šè°ƒç”¨ draw
        }
        drawWheel();
    }

    // 3. è¯»å–è‡ªå®šä¹‰è¾“å…¥
    function updateCustomWheel() {
        const text = document.getElementById('custom-items').value;
        // æŒ‰æ¢è¡Œåˆ†å‰²ï¼Œè¿‡æ»¤ç©ºè¡Œ
        const lines = text.split('\n').map(t => t.trim()).filter(t => t);

        if (lines.length > 0) {
            currentWheelItems = lines;
        } else {
            currentWheelItems = ['è¯·è¾“å…¥', 'é€‰é¡¹'];
        }
        drawWheel();
    }

    // [ä¿®æ”¹] ç»˜åˆ¶å‡½æ•° (å¢åŠ æ–‡å­—æè¾¹ï¼Œæ›´å¥½çœ‹)
    function drawWheel() {
        if (!wheelCtx) return;
        const count = currentWheelItems.length;
        const arc = 2 * Math.PI / count;
        const radius = wheelCanvas.width / 2;

        wheelCtx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);
        wheelCtx.save();
        wheelCtx.translate(radius, radius);
        wheelCtx.rotate(-Math.PI / 2);

        for (let i = 0; i < count; i++) {
            const angle = i * arc;

            // æ‰‡å½¢
            wheelCtx.beginPath();
            wheelCtx.moveTo(0, 0);
            wheelCtx.arc(0, 0, radius, angle, angle + arc);
            wheelCtx.fillStyle = wheelColors[i % wheelColors.length];
            wheelCtx.fill();
            // æ‰‡å½¢åˆ†å‰²çº¿
            wheelCtx.strokeStyle = "#fff";
            wheelCtx.lineWidth = 4;
            wheelCtx.stroke();

            // æ–‡å­—
            wheelCtx.save();
            wheelCtx.rotate(angle + arc / 2);
            wheelCtx.textAlign = "right";
            wheelCtx.fillStyle = "#fff";
            wheelCtx.font = "bold 36px system-ui"; // å­—ä½“æ”¹å°ä¸€ç‚¹ç‚¹
            wheelCtx.shadowColor = "rgba(0,0,0,0.1)";
            wheelCtx.shadowBlur = 4;
            // å‚ç›´å±…ä¸­ä¿®æ­£
            wheelCtx.textBaseline = "middle";
            wheelCtx.fillText(currentWheelItems[i], radius - 30, 0);
            wheelCtx.restore();
        }
        wheelCtx.restore();
        wheelCanvas.style.transform = `rotate(${currentRotation % 360}deg)`;
    }

    // 5. å¼€å§‹è½¬åŠ¨
    function spinWheel() {
        if (isSpinning) return;
        if (currentWheelItems.length < 2) {
            alert("è‡³å°‘éœ€è¦ä¸¤ä¸ªé€‰é¡¹æ‰èƒ½è½¬å“¦ï¼");
            return;
        }

        isSpinning = true;
        // éšæœºæ—‹è½¬åœˆæ•° (5~10åœˆ) + éšæœºè§’åº¦
        // 1440 = 4åœˆ
        const extraSpins = 1800 + Math.random() * 1800;
        currentRotation += extraSpins;

        wheelCanvas.style.transform = `rotate(${currentRotation}deg)`;

        // æ’­æ”¾éŸ³æ•ˆ (å¯é€‰ï¼Œå¤ç”¨æœ¨é±¼çš„éŸ³æ•ˆé€»è¾‘æˆ–è€…éœ‡åŠ¨)
        if (navigator.vibrate) navigator.vibrate(200);

        // 4ç§’ååœä¸‹ (å’Œ CSS transition æ—¶é—´ä¸€è‡´)
        setTimeout(() => {
            isSpinning = false;
            calculateWinner();
        }, 4000);
    }

    // 6. è®¡ç®—ç»“æœ
    function calculateWinner() {
        // è®¡ç®—å®é™…è§’åº¦ (å–ä½™)
        const actualDeg = currentRotation % 360;

        // æ ¸å¿ƒæ•°å­¦é¢˜ï¼š
        // æŒ‡é’ˆå›ºå®šåœ¨ 12ç‚¹é’Ÿ (270åº¦/ -90åº¦ä½ç½®ç›¸å¯¹äºCanvas 0åº¦)
        // æˆ–è€…æ˜¯ï¼šæˆ‘ä»¬Canvasç»˜åˆ¶æ—¶å·²ç»æŠŠ0åº¦æ—‹è½¬åˆ°äº†12ç‚¹ã€‚
        // Canvasæ—‹è½¬äº† N åº¦ã€‚
        // æŒ‡é’ˆæŒ‡å‘çš„ç´¢å¼• = æ€»æ•° - (æ—‹è½¬è§’åº¦ / æ¯ä¸ªæ‰‡åŒºè§’åº¦) % æ€»æ•°
        // è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒé€šç”¨çš„å…¬å¼

        const count = currentWheelItems.length;
        const degPerItem = 360 / count;

        // æŒ‡é’ˆåœ¨æ­£ä¸Šæ–¹ï¼ŒCanvasé¡ºæ—¶é’ˆè½¬äº† actualDeg
        // ä¹Ÿå°±ç›¸å½“äº æŒ‡é’ˆé€†æ—¶é’ˆèµ°äº† actualDeg
        // ç´¢å¼•è®¡ç®—ï¼š
        let index = Math.floor((360 - actualDeg % 360) / degPerItem);
        index = index % count; // é˜²æ­¢æº¢å‡º

        const winner = currentWheelItems[index];

        // åº†ç¥ç‰¹æ•ˆ
        if (window.fireConfetti) fireConfetti();
        alert("ğŸ‰ ç»“æœæ˜¯ï¼š\n\n" + winner);

        // è‡ªåŠ¨å‘é€é€šçŸ¥
        const autoNotify = document.getElementById('auto-notify').checked;
        if (autoNotify && currentWheelFamId) {
            sendWheelResult(winner);
        }
    }

    // [ä¿®å¤ç‰ˆ] å‘é€ç»“æœé€»è¾‘ (ä¿®å¤"æˆ‘"çš„æ˜¾ç¤ºé—®é¢˜)
    function sendWheelResult(winner) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/send_game_result';

        const i1 = document.createElement('input');
        i1.type = 'hidden';
        i1.name = 'csrf_token';
        i1.value = '{{ csrf_token() }}';
        const i2 = document.createElement('input');
        i2.type = 'hidden';
        i2.name = 'family_id';
        i2.value = currentWheelFamId;
        const i3 = document.createElement('input');
        i3.type = 'hidden';
        i3.name = 'content';

        // [æ ¸å¿ƒä¿®å¤] åå­—è½¬æ¢ï¼šå¦‚æœæ˜¯"æˆ‘"ï¼Œæ¢æˆçœŸå®æ˜µç§°
        let finalName = winner;
        if (winner === 'æˆ‘') {
            finalName = currentUserName;
        }

        let msg = "";

        if (currentMode === 'member') {
            // è·å–è¾“å…¥çš„ä»»åŠ¡
            const taskInput = document.getElementById('member-task-input');
            const task = taskInput ? taskInput.value.trim() : '';

            if (task) {
                // æœ‰ä»»åŠ¡
                msg = `ğŸ¡ å‘½è¿å¤§è½¬ç›˜å…¬æ­£è£å†³ï¼š\nğŸ‘‰ æ­å–œ ã€${finalName}ã€‘ å–œæä»»åŠ¡ï¼š\nğŸ”¥ ã€${task}ã€‘ ğŸ”¥\n(å…¨å®¶è§è¯ï¼Œä¸å¯è€èµ–)`;
            } else {
                // æ²¡ä»»åŠ¡
                msg = `ğŸ¡ å‘½è¿å¤§è½¬ç›˜å…¬æ­£è£å†³ï¼š\nğŸ‰ å¤©é€‰ä¹‹å­æ˜¯ â€”â€” ã€${finalName}ã€‘ï¼\n(ä¸è®ºå¹²å•¥ï¼Œéƒ½ä¸è®¸è€èµ–å“¦)`;
            }

        } else {
            // é€‰äº‹æ¨¡å¼
            msg = `ğŸ¡ å‘½è¿å¤§è½¬ç›˜ç»“æœå…¬ç¤ºï¼š\nâœ¨ ä»Šæ™šå†³å®š â€”â€” ã€${finalName}ã€‘ï¼\n(çº ç»“ç—‡ç»ˆç»“è€…)`;
        }

        i3.value = msg;

        form.appendChild(i1);
        form.appendChild(i2);
        form.appendChild(i3);
        document.body.appendChild(form);
        showLoading();
        form.submit();
    }
    // ================= ğŸ—ºï¸ è¶³è¿¹åœ°å›¾é€»è¾‘ =================
    let mapChart = null;

    function openMapModal(fid, homeName, homeLat, homeLon, awayName, awayLat, awayLon, footprints) {
        document.getElementById('map_fam_id').value = fid;

        // 1. åˆå§‹åŒ–å¼¹çª—
        const modal = new bootstrap.Modal(document.getElementById('mapModal'));
        modal.show();

        // 2. æ¸²æŸ“å·²ç‚¹äº®åˆ—è¡¨
        const tagsBox = document.getElementById('footprint-tags');
        tagsBox.innerHTML = '';
        if (footprints.length === 0) tagsBox.innerHTML = '<small class="text-muted">è¿˜æ²¡å»è¿‡åˆ«çš„åœ°æ–¹~</small>';

        footprints.forEach(fp => {
            const tag = document.createElement('div');
            tag.className = 'badge bg-white text-dark border d-flex align-items-center p-2';
            tag.innerHTML = `
                <span class="text-warning me-1">â˜…</span> ${fp.city_name}
                <form action="/delete_footprint" method="POST" class="ms-2 mb-0" onsubmit="return confirm('ç§»é™¤è¿™ä¸ªè¶³è¿¹ï¼Ÿ')">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="fp_id" value="${fp.id}">
                    <button class="btn btn-link text-danger p-0 small" style="line-height:1">Ã—</button>
                </form>
            `;
            tagsBox.appendChild(tag);
        });

        // 3. å‡†å¤‡åœ°å›¾æ•°æ®
        // å¿…é¡»å»¶è¿Ÿä¸€ç‚¹æ¸²æŸ“ï¼Œå¦åˆ™ Modal åŠ¨ç”»ä¼šå¯¼è‡´ ECharts å®½é«˜è®¡ç®—é”™è¯¯
        setTimeout(() => {
            if (!mapChart) mapChart = echarts.init(document.getElementById('china-map'));
            renderMap(homeName, homeLat, homeLon, awayName, awayLat, awayLon, footprints);
        }, 300);
    }

    function renderMap(hName, hLat, hLon, aName, aLat, aLon, footprints) {
        // åŸºç¡€ç‚¹æ•°æ®
        const dataRes = []; // å‘¼å¸çº¢ç‚¹ (å®¶)
        const linesData = []; // è¿çº¿
        const goldPoints = []; // é‡‘è‰²è¶³è¿¹

        // å¤„ç†åŒåŸ
        if (hName && hLat) dataRes.push({name: hName, value: [hLon, hLat, 100]});
        if (aName && aLat) dataRes.push({name: aName, value: [aLon, aLat, 100]});

        // å¤„ç†è¿çº¿
        if (hName && aName && hLat && aLat) {
            linesData.push({
                coords: [[hLon, hLat], [aLon, aLat]]
            });
            // è®¡ç®—è·ç¦» (Haversine å…¬å¼)
            const dist = getDistance(hLat, hLon, aLat, aLon);
            document.getElementById('distance-text').innerHTML =
                `â¤ï¸ ç›¸è· <span class="text-danger fs-5">${dist}</span> kmï¼Œä½†å¿ƒåœ¨ä¸€èµ·`;
        } else {
            document.getElementById('distance-text').innerText = "è¯·å…ˆåœ¨é¦–é¡µè®¾ç½®å¥½åŒåŸï¼Œæ‰èƒ½æ˜¾ç¤ºè¿çº¿å“¦~";
        }

        // å¤„ç†è¶³è¿¹
        footprints.forEach(fp => {
            goldPoints.push({name: fp.city_name, value: [fp.lon, fp.lat, 50]});
        });

        // ECharts é…ç½® (ç²¾è‡´ç‰ˆ)
        const option = {
            backgroundColor: '#fdfdfd',
            geo: {
                map: 'china',
                roam: true, // å…è®¸ç¼©æ”¾å¹³ç§»
                zoom: 1.2,
                label: { show: false },
                itemStyle: {
                    areaColor: '#f1f2f6', // æµ…ç°åº•å›¾
                    borderColor: '#ced6e0', // è¾¹æ¡†
                    borderWidth: 1
                },
                emphasis: {
                    itemStyle: { areaColor: '#dfe4ea' }
                }
            },
            series: [
                // 1. è¿çº¿ (é£çº¿)
                {
                    type: 'lines',
                    coordinateSystem: 'geo',
                    effect: {
                        show: true,
                        period: 6,
                        trailLength: 0.7,
                        color: '#ff6b6b', // çº¢è‰²è½¨è¿¹
                        symbolSize: 3
                    },
                    lineStyle: {
                        color: '#ff6b6b',
                        width: 1,
                        curveness: 0.2
                    },
                    data: linesData
                },
                // 2. åŒåŸ (çº¢è‰²å‘¼å¸ç‚¹)
                {
                    type: 'effectScatter',
                    coordinateSystem: 'geo',
                    rippleEffect: { brushType: 'stroke' },
                    label: { show: true, position: 'right', formatter: '{b}', color: '#333', fontWeight: 'bold' },
                    itemStyle: { color: '#ff4757' },
                    data: dataRes
                },
                // 3. è¶³è¿¹ (é‡‘è‰²å®å¿ƒç‚¹)
                {
                    type: 'scatter',
                    coordinateSystem: 'geo',
                    symbol: 'pin', // å¤§å¤´é’ˆæ ·å¼
                    symbolSize: 15,
                    itemStyle: { color: '#ffa502' }, // é‡‘è‰²
                    label: { show: false },
                    data: goldPoints,
                    tooltip: { formatter: '{b}' } // æ‚¬åœæ˜¾ç¤ºåŸå¸‚å
                }
            ]
        };
        mapChart.setOption(option);
    }

    // è®¡ç®—åœ°çƒä¸¤ç‚¹è·ç¦» (km)
    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return Math.round(R * c);
    }
</script>
</body>
</html>