<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- ËßÜÂè£ËÆæÁΩÆ -->
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>ÂêéÂè∞ - ÂÖ®ÂÆ∂ÁâµÊåÇ</title>

    <!-- PWA Ê†∏ÂøÉÈÖçÁΩÆ (Âä†‰∫ÜÁâàÊú¨Âè∑) -->
    <link rel="manifest" href="/static/manifest.json?v={{ app_version }}">
    <link rel="apple-touch-icon" href="/static/icon.png">

    <!-- iOS ÈÄÇÈÖç -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2c3e50"> <!-- ÂêéÂè∞ÈÄöÂ∏∏Áî®Ê∑±Ëâ≤‰∏ªÈ¢òËâ≤ -->

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            padding-bottom: 50px;
        }

        /* È°∂ÈÉ®ÂØºËà™ */
        .navbar-admin {
            background: #2c3e50;
            color: white;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        /* ÈÄâÈ°πÂç°Ê†∑Âºè */
        .nav-pills .nav-link {
            color: #666;
            font-weight: bold;
            border-radius: 8px;
            padding: 10px 20px;
            margin-right: 5px;
        }

        .nav-pills .nav-link.active {
            background-color: #2c3e50;
            color: white;
        }

        /* Âç°ÁâáÈÄöÁî®Ê†∑Âºè */
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            overflow: hidden;
        }

        /* ÁªüËÆ°Êï∞Â≠ó */
        .stat-num {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        /* ÂéüÂßãÊï∞ÊçÆÈªëÊ°Ü */
        .raw-data-box {
            font-family: monospace;
            font-size: 11px;
            background: #222;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            display: none;
            margin-top: 10px;
            word-break: break-all;
        }

        /* Ë°®Ê†ºÊ†∑Âºè */
        .table-custom th {
            border-top: none;
            color: #888;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .table-custom td {
            vertical-align: middle;
        }

        /* ÈÇÄËØ∑Á†ÅÊ†∑Âºè */
        .invite-code {
            font-family: monospace;
            font-size: 16px;
            letter-spacing: 2px;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            color: #495057;
            border: 1px dashed #ccc;
        }
    </style>
</head>
<body>

<div class="navbar-admin d-flex justify-content-between align-items-center">
    <h5 class="mb-0 fw-bold"><i class="fas fa-user-shield me-2"></i>ÊéßÂà∂Âè∞</h5>
    <a href="/" class="btn btn-sm btn-light text-dark fw-bold rounded-pill px-3">
        <i class="fas fa-home me-1"></i> ËøîÂõûÂâçÂè∞
    </a>
</div>

<div class="container">
    <!-- Êï∞ÊçÆÊåáÊå•Ëà± -->
    <div class="row g-3 mb-4">
        <!-- Â∑¶‰æßÔºöÊúçÂä°Âô®ÂÆûÊó∂ÁõëÊéß -->
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 fw-bold pt-3 pb-0">
                    <i class="fas fa-microchip text-primary me-2"></i>ÂÆûÊó∂Ë¥üËΩΩ
                </div>
                <div class="card-body d-flex justify-content-around align-items-center">
                    <!-- [‰øÆÊîπ] ÂéªÊéâ width:150pxÔºåÊîπÁî® flex Ëá™ÈÄÇÂ∫îÔºåÈ´òÂ∫¶Âä†Â§ßÂà∞ 200px -->
                    <div style="flex: 1; height: 200px;" id="chart-cpu"></div>
                    <div style="flex: 1; height: 200px;" id="chart-mem"></div>
                </div>
            </div>
        </div>

        <!-- Âè≥‰æßÔºöÂ≠òÂÇ®ÈÄèËßÜ -->
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 fw-bold pt-3 pb-0">
                    <i class="fas fa-hdd text-success me-2"></i>Â≠òÂÇ®Á©∫Èó¥ÂàÜÂ∏É
                </div>
                <div class="card-body">
                    <!-- [‰øÆÊîπ] È´òÂ∫¶Âä†Â§ß -->
                    <div id="chart-storage" style="width: 100%; height: 240px;"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3">
            <div class="card p-3 text-center h-100 justify-content-center">
                <div class="stat-num text-primary">{{ stats.users }}</div>
                <div class="small text-muted fw-bold">Áî®Êà∑ÊÄªÊï∞</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card p-3 text-center h-100 justify-content-center">
                <div class="stat-num" style="color: #6f42c1;">{{ stats.families }}</div>
                <div class="small text-muted fw-bold">ÂÆ∂Â∫≠ÊÄªÊï∞</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card p-3 text-center h-100 justify-content-center">
                <div class="stat-num text-success">{{ stats.pets }}</div>
                <div class="small text-muted fw-bold">ÂÆ†Áâ©ÊÄªÊï∞</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card p-3 text-center h-100 justify-content-center">
                <div class="stat-num text-warning">{{ stats.storage_mb }} <small class="fs-6">MB</small></div>
                <div class="small text-muted fw-bold">Â∑≤Áî®Â≠òÂÇ®</div>
            </div>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <ul class="nav nav-pills mb-4 justify-content-center" id="adminTab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button">
                <i class="fas fa-users me-1"></i> Áî®Êà∑
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="families-tab" data-bs-toggle="tab" data-bs-target="#families" type="button">
                <i class="fas fa-house-user me-1"></i> ÂÆ∂Â∫≠
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="pets-tab" data-bs-toggle="tab" data-bs-target="#pets" type="button">
                <i class="fas fa-paw me-1"></i> ÂÆ†Áâ©
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="storage-tab" data-bs-toggle="tab" data-bs-target="#storage" type="button">
                <i class="fas fa-hdd me-1"></i> Â≠òÂÇ®
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="updates-tab" data-bs-toggle="tab" data-bs-target="#updates" type="button">
                <i class="fas fa-bullhorn me-1"></i> ÂÖ¨Âëä
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="codes-tab" data-bs-toggle="tab" data-bs-target="#codes" type="button">
                <i class="fas fa-ticket-alt me-1"></i> ÊöóÂè∑
            </button>
        </li>
    </ul>

    <div class="tab-content">

        <div class="tab-pane fade show active" id="users">
            <div class="card">
                <div class="table-responsive">
                    <table class="table table-custom table-hover mb-0">
                        <thead class="table-light">
                        <tr>
                            <th>ÊòµÁß∞ / ID</th>
                            <th>ÊâÄÂú®ÂÆ∂Â∫≠</th>
                            <th>Ë∫´‰ªΩ</th>
                            <th class="text-end">ÁÆ°ÁêÜÊìç‰Ωú</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for user in users %}
                            <tr>
                                <td>
                                    <div class="fw-bold text-dark">{{ user.display_name }}</div>
                                    <small class="text-muted"
                                           style="font-size:11px; font-family:monospace;">{{ user.id }}</small>
                                </td>
                                <td>
                                    {% if user.families_data %}
                                        <!-- ÈÅçÂéÜËØ•Áî®Êà∑Âä†ÂÖ•ÁöÑÊâÄÊúâÂÆ∂Â∫≠ -->
                                        <div class="d-flex flex-wrap gap-1">
                                            {% for fam in user.families_data %}
                                                <div class="badge bg-primary bg-opacity-10 text-primary border border-primary d-flex align-items-center">
                                                    <i class="fas fa-home me-1"></i> {{ fam.name }}

                                                    <!-- Ë∏¢‰∫∫Â∞èÊåâÈíÆ (ÂµåÂÖ•Âú®Ê†áÁ≠æÈáå) -->
                                                    <form action="/admin/unbind_family" method="POST" class="ms-2"
                                                          onsubmit="return confirm('Á°ÆÂÆöË¶ÅÊää‰ªñ‰ªé [{{ fam.name }}] Ë∏¢Âá∫ÂéªÂêóÔºü')">
                                                        <input type="hidden" name="csrf_token"
                                                               value="{{ csrf_token() }}"/>
                                                        <input type="hidden" name="user_id" value="{{ user.id }}">
                                                        <input type="hidden" name="family_id" value="{{ fam.id }}">
                                                        <button type="submit" class="btn btn-link p-0 text-danger"
                                                                style="line-height: 1;" title="Ë∏¢Âá∫">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <span class="badge bg-secondary bg-opacity-25 text-secondary">
                    <i class="fas fa-wind me-1"></i>ÊµÅÊµ™‰∏≠
                </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.role == 'admin' %}
                                        <span class="badge bg-warning text-dark border border-warning">ÁÆ°ÁêÜÂëò</span>
                                    {% else %}
                                        <span class="badge bg-light text-dark border">ÊàêÂëò</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <div class="d-inline-flex gap-1">
                                        <!--
                                        {% if user.id != session['user'] %}
                                            <a href="/admin/login_as/{{ user.id }}" class="btn btn-sm btn-outline-info"
                                               title="‰ª•ËØ•Ë∫´‰ªΩÁôªÂΩï" onclick="return confirm('Á°ÆÂÆöË¶ÅÂàáÊç¢Ë∫´‰ªΩÂêóÔºü')">
                                                <i class="fas fa-user-secret"></i>
                                            </a>
                                        {% endif %}
                                        -->

                                        <form action="/admin/reset_password/{{ user.id }}" method="POST"
                                              onsubmit="return confirm('Á°ÆÂÆöÈáçÁΩÆ‰∏∫ 123456Ôºü')" class="d-inline">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                            <button type="submit" class="btn btn-sm btn-outline-primary"
                                                    title="ÈáçÁΩÆÂØÜÁ†Å">
                                                <i class="fas fa-key"></i>
                                            </button>
                                        </form>

                                        <button class="btn btn-sm btn-outline-dark"
                                                onclick="toggleRawData('{{ user.id }}')" title="ÂéüÂßãÊï∞ÊçÆ"><i
                                                class="fas fa-eye"></i></button>

                                        {% if user.id != session['user'] %}
                                            <form action="/admin/delete_user/{{ user.id }}" method="POST"
                                                  onsubmit="return confirm('‚ö†Ô∏è ÂΩªÂ∫ïÂà†Èô§ËØ•Áî®Êà∑Ôºü')" class="d-inline">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                <button type="submit" class="btn btn-sm btn-outline-danger"
                                                        title="ÂΩªÂ∫ïÂà†Èô§"><i class="fas fa-trash"></i></button>
                                            </form>
                                        {% endif %}
                                    </div>
                                    <div id="raw-{{ user.id }}" class="raw-data-box text-start mt-2">Âä†ËΩΩ‰∏≠...</div>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="families">
            <div class="card p-3 mb-3 border-0 bg-light shadow-sm">
                <h6 class="fw-bold mb-2"><i class="fas fa-plus-circle text-primary"></i> ÂàõÂª∫Êñ∞ÂÆ∂Â∫≠</h6>
                <form action="/admin/add_family" method="POST" class="d-flex gap-2">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="text" name="name" class="form-control" placeholder="ÂÆ∂Â∫≠ÂêçÁß∞ (Â¶Ç: Âπ∏Á¶è‰∏ÄÂÆ∂‰∫∫)"
                           required>
                    <button type="submit" class="btn text-white px-4 fw-bold" style="background-color: #6f42c1;">
                        ÂàõÂª∫ÂÆ∂Â∫≠
                    </button>
                </form>
            </div>

            <div class="card">
                <table class="table table-custom table-hover mb-0">
                    <thead class="table-light">
                    <tr>
                        <th>ÂÆ∂Â∫≠ÂêçÁß∞</th>
                        <th>ÈÇÄËØ∑Á†Å</th>
                        <th>ÊàêÂëòÊ¶ÇÂÜµ</th>
                        <th>ÂàõÂª∫Êó•Êúü</th>
                        <th class="text-end">Êìç‰Ωú</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for f in families %}
                        <tr>
                            <td><strong>{{ f.name }}</strong></td>
                            <td>
    <span class="invite-code" title="{{ f.invite_code }}">
        {{ f.invite_code[:2] }}****
    </span>
                            </td>
                            <td>
                                    <span class="badge bg-secondary" title="{{ f.members_str }}" style="cursor: help;">
                                        <i class="fas fa-users me-1"></i> {{ f.member_count }} ‰∫∫
                                    </span>
                                {% if f.member_count > 0 %}
                                    <small class="text-muted ms-1 d-none d-md-inline" style="font-size: 11px;">
                                        ({{ f.members_str[:10] }}{% if f.members_str|length > 10 %}...{% endif %})
                                    </small>
                                {% endif %}
                            </td>
                            <td><small class="text-muted">{{ f.created_at[:10] }}</small></td>
                            <td class="text-end">
                                <form action="/admin/delete_family/{{ f.id }}" method="POST"
                                      onsubmit="return confirm('Á°ÆÂÆöËß£Êï£Ëøô‰∏™ÂÆ∂Â∫≠ÂêóÔºü')">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button class="btn btn-sm btn-outline-danger">
                                        <i class="fas fa-trash-alt me-1"></i> Ëß£Êï£
                                    </button>
                                </form>
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="5" class="text-center text-muted py-4">
                                <i class="fas fa-folder-open fa-2x mb-2 d-block opacity-50"></i>
                                ËøòÊ≤°ÊúâÂàõÂª∫‰ªª‰ΩïÂÆ∂Â∫≠
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="pets">
            <div class="card p-3 mb-3 border-0 bg-light shadow-sm">
                <h6 class="fw-bold mb-2"><i class="fas fa-plus-circle text-success"></i> Ê∑ªÂä†Êñ∞ÂÆ†Áâ©</h6>
                <form action="/admin/add_pet" method="POST" class="d-flex gap-2">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="text" name="name" class="form-control" placeholder="ÂÆ†Áâ©ÂêçÂ≠ó (Â¶Ç: Êó∫Ë¥¢)" required>
                    <select name="type" class="form-select" style="width: 140px;">
                        <option value="dog">üê∂ Áãó</option>
                        <option value="cat">üê± Áå´</option>
                    </select>
                    <button type="submit" class="btn btn-success px-4 fw-bold">Ê∑ªÂä†</button>
                </form>
            </div>

            <div class="card">
                <table class="table table-custom table-hover mb-0">
                    <thead class="table-light">
                    <tr>
                        <th>ÂêçÂ≠ó/Á±ªÂûã</th>
                        <th>ÊâÄÂ±ûÂÆ∂Â∫≠</th>
                        <th>ÁõëÊä§‰∫∫ (‰∏ª‰∫∫)</th>
                        <th class="text-end">Êìç‰Ωú</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for pet in pets %}
                        <tr>
                            <td>
                                <strong>{{ pet.name }}</strong>
                                <span class="badge bg-light text-dark border ms-1">{{ pet.type }}</span>
                            </td>
                            <td>
                                {% if 'ÊµÅÊµ™' in pet.family_name %}
                                    <span class="badge bg-danger bg-opacity-10 text-danger">{{ pet.family_name }}</span>
                                {% else %}
                                    <span class="badge bg-primary bg-opacity-10 text-primary">{{ pet.family_name }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <small class="text-muted">{{ pet.owners_str }}</small>
                            </td>
                            <td class="text-end">
                                <form action="/admin/delete_pet/{{ pet.id }}" method="POST"
                                      onsubmit="return confirm('Á°ÆÂÆöÂà†Èô§ÂêóÔºü')">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="storage">
            <div class="alert alert-info small d-flex justify-content-between align-items-center">
                    <span>
                        <i class="fas fa-hdd me-1"></i>
                        Â∑≤Áî®Á©∫Èó¥: <strong>{{ stats.storage_mb }} MB</strong>
                        <span class="ms-2 text-muted">(ÂÖ± {{ stats.file_count }} ‰∏™Êñá‰ª∂)</span>
                    </span>
                <button class="btn btn-sm btn-outline-dark bg-white" onclick="location.reload()">
                    <i class="fas fa-sync-alt me-1"></i> Âà∑Êñ∞ÂàóË°®
                </button>
            </div>

            <div class="card">
                <div class="table-responsive">
                    <table class="table table-custom table-hover align-middle mb-0">
                        <thead class="table-light">
                        <tr>
                            <!-- [‰øÆÊîπ] ‰∏çÂÜçÊòæÁ§∫È¢ÑËßàÂõæÔºåÊîπÊòæÁ§∫Á±ªÂûãÂõæÊ†á -->
                            <th style="width: 50px;">Á±ªÂûã</th>
                            <th>Êñá‰ª∂Âêç / Êó∂Èó¥</th>
                            <th>‰∏ä‰º†ËÄÖ</th>
                            <th>Â§ßÂ∞è</th>
                            <th class="text-end">Êìç‰Ωú</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for f in files[:50] %}
                            <tr>
                                <!-- [‰øÆÊîπ] ÈöêÁßÅÊ®°ÂºèÔºöÂè™ÊòæÁ§∫‰∏Ä‰∏™ÈÄöÁî®ÁöÑÂõæÁâáÂõæÊ†áÔºå‰∏çÂä†ËΩΩÁúüÂÆûÂõæÁâá -->
                                <td class="text-center text-muted">
                                    <i class="fas fa-file-image fa-lg"></i>
                                </td>

                                <td>
                                    <!-- [‰øÆÊîπ] Êñá‰ª∂Âêç‰∏çÂÜçÂÅöÊàêË∂ÖÈìæÊé•ÔºåÊàñËÄÖÂÅö‰∏Ä‰∏™ÂæàÈöêËîΩÁöÑ‚Äú‰∏ãËΩΩ‚ÄùÈìæÊé• -->
                                    <div class="text-truncate" style="max-width: 200px; font-size: 13px;"
                                         title="{{ f.name }}">
                                        {{ f.name }}
                                    </div>
                                    <small class="text-muted" style="font-size: 11px;">
                                        <i class="far fa-clock me-1"></i>{{ f.created_at_fmt }}
                                    </small>
                                </td>

                                <td>
                                    {% if 'Êó†ËÆ∞ÂΩï' in f.uploader %}
                                        <span class="badge bg-secondary text-white-50"
                                              style="font-size: 10px;">Êú™Áü•</span>
                                    {% else %}
                                        <span class="badge bg-info bg-opacity-10 text-info border border-info"
                                              style="font-size: 11px;">
                        {{ f.uploader.replace('‚úÖ ', '') }}
                    </span>
                                    {% endif %}
                                </td>

                                <td>
                                    <span class="text-muted small">{{ f.size_kb }} KB</span>
                                </td>

                                <td class="text-end">
                                    <form action="/admin/delete_file" method="POST"
                                          onsubmit="return confirm('‚ö†Ô∏è Á°ÆÂÆöÂà†Èô§Ëøô‰∏™Êñá‰ª∂ÂêóÔºü\n(Êìç‰Ωú‰∏çÂèØÈÄÜ)')">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <input type="hidden" name="file_name" value="{{ f.name }}">
                                        <button class="btn btn-sm btn-outline-danger border-0" title="Âà†Èô§Êñá‰ª∂">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="5" class="text-center py-5 text-muted">
                                    <i class="fas fa-box-open fa-2x mb-3 opacity-25"></i><br>
                                    Â≠òÂÇ®Ê°∂ÈùûÂ∏∏Âπ≤ÂáÄ
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if files|length > 50 %}
                    <div class="card-footer text-center text-muted small">
                        ‰ªÖÂ±ïÁ§∫ÊúÄÊñ∞ÁöÑ 50 ‰∏™Êñá‰ª∂
                    </div>
                {% endif %}
            </div>
        </div>
        <div class="tab-pane fade" id="updates">
            <div class="card p-4 mb-3 border-0 bg-light shadow-sm">
                <h6 class="fw-bold mb-3"><i class="fas fa-paper-plane text-success me-2"></i>ÂèëÂ∏ÉÊñ∞ÁâàÊú¨ÈÄöÁü•</h6>
                <form action="/admin/publish_update" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <input type="text" name="version" class="form-control" placeholder="ÁâàÊú¨Âè∑ (Â¶Ç 1.2)"
                                   required>
                        </div>
                        <div class="col-md-7">
                            <textarea name="content" class="form-control" rows="1" placeholder="Êõ¥Êñ∞ÂÜÖÂÆπ (ÊîØÊåÅÊç¢Ë°å)"
                                      required></textarea>
                        </div>
                        <div class="col-md-2 d-flex align-items-center">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="is_pushed" id="pushSwitch"
                                       checked>
                                <label class="form-check-label small" for="pushSwitch">È¶ñÈ°µÂºπÁ™ó</label>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success w-100 mt-3 fw-bold">ÂèëÂ∏ÉÂÖ¨Âëä</button>
                </form>
            </div>

            <div class="card">
                <table class="table table-custom table-hover mb-0">
                    <thead>
                    <tr>
                        <th>ÁâàÊú¨</th>
                        <th>ÂÜÖÂÆπ</th>
                        <th>Áä∂ÊÄÅ</th>
                        <th>Êó∂Èó¥</th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for up in updates %}
                        <tr>
                            <td><span class="badge bg-dark">{{ up.version }}</span></td>
                            <td style="white-space: pre-wrap;">{{ up.content }}</td>
                            <td>
                                <!-- Áä∂ÊÄÅÊòæÁ§∫ + ÂàáÊç¢ÊåâÈíÆ -->
                                <form action="/admin/toggle_update_status/{{ up.id }}" method="POST" class="d-inline">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    {% if up.is_pushed %}
                                        <button type="submit" class="btn badge bg-success border-0" title="ÁÇπÂáªÂÖ≥Èó≠">Êé®ÈÄÅ‰∏≠
                                            <i class="fas fa-check-circle"></i></button>
                                    {% else %}
                                        <button type="submit" class="btn badge bg-secondary border-0 opacity-50"
                                                title="ÁÇπÂáªÂºÄÂêØ">Êú™Êé®ÈÄÅ
                                        </button>
                                    {% endif %}
                                </form>
                            </td>
                            <td><small class="text-muted">{{ up.created_at[:10] }}</small></td>
                            <td>
                                <form action="/admin/delete_update/{{ up.id }}" method="POST"
                                      onsubmit="return confirm('Á°ÆÂÆöÂà†Èô§ËØ•ÂÖ¨ÂëäÔºü')">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button class="btn btn-sm btn-link text-danger p-0">Âà†Èô§</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="tab-pane fade" id="codes">
            <div class="card p-4 mb-3 border-0 bg-light shadow-sm">
                <h6 class="fw-bold mb-3"><i class="fas fa-plus-circle text-primary me-2"></i>ÁîüÊàêÊ≥®ÂÜåÊöóÂè∑</h6>
                <form action="/admin/generate_reg_code" method="POST" class="d-flex gap-2 align-items-center">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <span class="text-muted small text-nowrap">ÂèØÁî®Ê¨°Êï∞:</span>
                    <input type="number" name="max_uses" class="form-control" value="3" style="width: 80px;" min="1"
                           max="100">
                    <button type="submit" class="btn btn-primary fw-bold px-4">ÁîüÊàê 6 ‰ΩçÈöèÊú∫ÊöóÂè∑</button>
                </form>
            </div>

            <div class="card">
                <table class="table table-custom table-hover mb-0">
                    <thead>
                    <tr>
                        <th>ÊöóÂè∑</th>
                        <th>Ê∂àËÄóËøõÂ∫¶</th>
                        <th>Áä∂ÊÄÅ</th>
                        <th>ÁîüÊàêÊó∂Èó¥</th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for c in reg_codes %}
                        <tr>
                            <td><span class="fs-5 font-monospace fw-bold text-dark">{{ c.code }}</span></td>
                            <td>
                                <!-- ËøõÂ∫¶Êù°ÂèØËßÜÂåñ -->
                                <div class="d-flex align-items-center gap-2">
                                    <div class="progress" style="width: 80px; height: 6px;">
                                        <div class="progress-bar bg-success" role="progressbar"
                                             style="width: {{ (c.current_uses / c.max_uses) * 100 }}%"></div>
                                    </div>
                                    <small class="text-muted">{{ c.current_uses }} / {{ c.max_uses }}</small>
                                </div>
                            </td>
                            <td>
                                {% if c.current_uses >= c.max_uses %}
                                    <span class="badge bg-secondary">Â∑≤Áî®ÂÆå</span>
                                {% else %}
                                    <span class="badge bg-success">ÊúâÊïà</span>
                                {% endif %}
                            </td>
                            <td><small class="text-muted">{{ c.created_at[:10] }}</small></td>
                            <td>
                                <form action="/admin/delete_reg_code/{{ c.id }}" method="POST"
                                      onsubmit="return confirm('Á°ÆÂÆö‰ΩúÂ∫üÊ≠§ÊöóÂè∑Ôºü')">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button class="btn btn-sm btn-link text-danger p-0">‰ΩúÂ∫ü</button>
                                </form>
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="5" class="text-center py-4 text-muted">ÊöÇÊó†ÊúâÊïàÊöóÂè∑</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const authData = JSON.parse('{{ auth_users | tojson | safe }}');
    const storageData = {{ stats.storage_breakdown | tojson | safe }} || {pet: 0, moment: 0, avatar: 0, other: 0};

    function toggleRawData(uid) {
        const box = document.getElementById('raw-' + uid);
        box.style.display = (box.style.display === 'block') ? 'none' : 'block';
        if (box.style.display === 'block') {
            const userData = authData.find(u => u.id === uid);
            box.innerText = userData ? JSON.stringify(userData, null, 2) : "Êó†Êï∞ÊçÆ";
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        const chartCpu = echarts.init(document.getElementById('chart-cpu'));
        const chartMem = echarts.init(document.getElementById('chart-mem'));
        const chartStorage = echarts.init(document.getElementById('chart-storage'));

        // === 1. ‰ª™Ë°®ÁõòÔºöApple Watch È£éÊ†ºÊ∏êÂèòÁéØ ===
        function getRingOption(title, colorStart, colorEnd) {
            return {
                series: [{
                    type: 'gauge',
                    startAngle: 90, endAngle: -270,
                    pointer: {show: false}, // ‰∏çË¶ÅÊåáÈíà
                    progress: {
                        show: true,
                        overlap: false,
                        roundCap: true, // ÂúÜËßíÁ´ØÁÇπ (È´òÁ∫ßÊÑüÊù•Ê∫ê)
                        clip: false,
                        itemStyle: {
                            // Ê∏êÂèòËâ≤
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                {offset: 0, color: colorStart},
                                {offset: 1, color: colorEnd}
                            ])
                        }
                    },
                    axisLine: {lineStyle: {width: 15, color: [[1, '#f0f2f5']]}}, // Â∫ïËâ≤Ê∑°ÁÅ∞
                    splitLine: {show: false},
                    axisTick: {show: false},
                    axisLabel: {show: false},
                    data: [{
                        value: 0,
                        name: title,
                        title: {offsetCenter: ['0%', '120%'], fontSize: 14, color: '#999'}, // Ê†áÈ¢òÂú®‰∏ãÈù¢
                        detail: {
                            offsetCenter: ['0%', '0%'], // Êï∞Â≠óÂ±Ö‰∏≠
                            fontSize: 30,
                            fontWeight: 'bold',
                            color: '#333',
                            formatter: '{value}%'
                        }
                    }]
                }]
            };
        }

        let optCpu = getRingOption('CPU', '#4facfe', '#00f2fe'); // ËìùÈùíÊ∏êÂèò
        let optMem = getRingOption('ÂÜÖÂ≠ò', '#43e97b', '#38f9d7'); // ÁªøÈùíÊ∏êÂèò

        chartCpu.setOption(optCpu);
        chartMem.setOption(optMem);

        // === 2. Â≠òÂÇ®ÂõæÔºöÂúÜËßíÁîúÁîúÂúà (Ëé´ÂÖ∞Ëø™Ëâ≤) ===
        const storageOption = {
            tooltip: {trigger: 'item', formatter: '{b}: {c}MB ({d}%)'},
            legend: {top: 'middle', right: '0%', orient: 'vertical', icon: 'circle'},
            series: [{
                name: 'Â≠òÂÇ®',
                type: 'pie',
                radius: ['50%', '75%'], // ÁîúÁîúÂúà
                center: ['35%', '50%'], // ÂæÄÂ∑¶Áßª‰∏ÄÁÇπÔºåÁªôÂõæ‰æãÁïô‰ΩçÁΩÆ
                avoidLabelOverlap: false,
                itemStyle: {
                    borderRadius: 8,
                    borderColor: '#fff',
                    borderWidth: 3
                },
                label: {show: false},
                // È´òÁ∫ßÈÖçËâ≤
                color: ['#5470c6', '#91cc75', '#fac858', '#ee6666'],
                data: [
                    {value: storageData.pet, name: 'ÂÆ†Áâ©'},
                    {value: storageData.moment, name: 'Âä®ÊÄÅ'},
                    {value: storageData.avatar, name: 'Â§¥ÂÉè'},
                    {value: storageData.other, name: 'ÂÖ∂‰ªñ'}
                ]
            }]
        };
        chartStorage.setOption(storageOption);

        // === 3. ÂÆûÊó∂Êï∞ÊçÆÊõ¥Êñ∞ ===
        function fetchServerStats() {
            fetch('/api/server_stats')
                .then(res => res.json())
                .then(data => {
                    // Âä®ÊÄÅÊõ¥Êñ∞Êï∞ÊçÆ
                    optCpu.series[0].data[0].value = Math.round(data.cpu);
                    chartCpu.setOption(optCpu);

                    optMem.series[0].data[0].value = Math.round(data.memory);
                    chartMem.setOption(optMem);
                })
                .catch(err => console.error(err));
        }

        setInterval(fetchServerStats, 2000);
        fetchServerStats();

        window.addEventListener('resize', () => {
            chartCpu.resize();
            chartMem.resize();
            chartStorage.resize();
        });
    });
</script>
</body>
</html>