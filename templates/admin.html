<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- è§†å£è®¾ç½® -->
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>åå° - å…¨å®¶ç‰µæŒ‚</title>

    <!-- PWA æ ¸å¿ƒé…ç½® (åŠ äº†ç‰ˆæœ¬å·) -->
    <link rel="manifest" href="/static/manifest.json?v={{ app_version }}">
    <link rel="apple-touch-icon" href="/static/icon.png">

    <!-- iOS é€‚é… -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2c3e50"> <!-- åå°é€šå¸¸ç”¨æ·±è‰²ä¸»é¢˜è‰² -->

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            padding-bottom: 50px;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .navbar-admin {
            background: #2c3e50;
            color: white;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        /* é€‰é¡¹å¡æ ·å¼ */
        .nav-pills .nav-link {
            color: #666;
            font-weight: bold;
            border-radius: 8px;
            padding: 10px 20px;
            margin-right: 5px;
        }

        .nav-pills .nav-link.active {
            background-color: #2c3e50;
            color: white;
        }

        /* å¡ç‰‡é€šç”¨æ ·å¼ */
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            overflow: hidden;
        }

        /* ç»Ÿè®¡æ•°å­— */
        .stat-num {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        /* åŸå§‹æ•°æ®é»‘æ¡† */
        .raw-data-box {
            font-family: monospace;
            font-size: 11px;
            background: #222;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            display: none;
            margin-top: 10px;
            word-break: break-all;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .table-custom th {
            border-top: none;
            color: #888;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .table-custom td {
            vertical-align: middle;
        }

        /* é‚€è¯·ç æ ·å¼ */
        .invite-code {
            font-family: monospace;
            font-size: 16px;
            letter-spacing: 2px;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            color: #495057;
            border: 1px dashed #ccc;
        }
    </style>
</head>
<body>

<div class="navbar-admin d-flex justify-content-between align-items-center">
    <h5 class="mb-0 fw-bold"><i class="fas fa-user-shield me-2"></i>æ§åˆ¶å°</h5>
    <a href="/" class="btn btn-sm btn-light text-dark fw-bold rounded-pill px-3">
        <i class="fas fa-home me-1"></i> è¿”å›å‰å°
    </a>
</div>

<div class="container">
    <!-- æ•°æ®æŒ‡æŒ¥èˆ± -->
    <div class="row g-3 mb-4">
        <!-- å·¦ä¾§ï¼šæœåŠ¡å™¨å®æ—¶ç›‘æ§ -->
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 fw-bold pt-3 pb-0">
                    <i class="fas fa-microchip text-primary me-2"></i>å®æ—¶è´Ÿè½½
                </div>
                <div class="card-body d-flex justify-content-around align-items-center">
                    <!-- [ä¿®æ”¹] å»æ‰ width:150pxï¼Œæ”¹ç”¨ flex è‡ªé€‚åº”ï¼Œé«˜åº¦åŠ å¤§åˆ° 200px -->
                    <div style="flex: 1; height: 200px;" id="chart-cpu"></div>
                    <div style="flex: 1; height: 200px;" id="chart-mem"></div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šå­˜å‚¨é€è§† -->
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 fw-bold pt-3 pb-0">
                    <i class="fas fa-hdd text-success me-2"></i>å­˜å‚¨ç©ºé—´åˆ†å¸ƒ
                </div>
                <div class="card-body">
                    <!-- [ä¿®æ”¹] é«˜åº¦åŠ å¤§ -->
                    <div id="chart-storage" style="width: 100%; height: 240px;"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3">
            <div class="card p-3 text-center h-100 justify-content-center">
                <div class="stat-num text-primary">{{ stats.users }}</div>
                <div class="small text-muted fw-bold">ç”¨æˆ·æ€»æ•°</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card p-3 text-center h-100 justify-content-center">
                <div class="stat-num" style="color: #6f42c1;">{{ stats.families }}</div>
                <div class="small text-muted fw-bold">å®¶åº­æ€»æ•°</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card p-3 text-center h-100 justify-content-center">
                <div class="stat-num text-success">{{ stats.pets }}</div>
                <div class="small text-muted fw-bold">å® ç‰©æ€»æ•°</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card p-3 text-center h-100 justify-content-center">
                <div class="stat-num text-warning">{{ stats.storage_mb }} <small class="fs-6">MB</small></div>
                <div class="small text-muted fw-bold">å·²ç”¨å­˜å‚¨</div>
            </div>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <ul class="nav nav-pills mb-4 justify-content-center" id="adminTab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button">
                <i class="fas fa-users me-1"></i> ç”¨æˆ·
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="families-tab" data-bs-toggle="tab" data-bs-target="#families" type="button">
                <i class="fas fa-house-user me-1"></i> å®¶åº­
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="pets-tab" data-bs-toggle="tab" data-bs-target="#pets" type="button">
                <i class="fas fa-paw me-1"></i> å® ç‰©
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="storage-tab" data-bs-toggle="tab" data-bs-target="#storage" type="button">
                <i class="fas fa-hdd me-1"></i> å­˜å‚¨
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="updates-tab" data-bs-toggle="tab" data-bs-target="#updates" type="button">
                <i class="fas fa-bullhorn me-1"></i> å…¬å‘Š
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="codes-tab" data-bs-toggle="tab" data-bs-target="#codes" type="button">
                <i class="fas fa-ticket-alt me-1"></i> æš—å·
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#config" type="button">
                <i class="fas fa-robot me-1"></i> AIé…ç½®
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="food-tab" data-bs-toggle="tab" data-bs-target="#food" type="button">
                <i class="fas fa-bone me-1"></i> é£Ÿç‰©çº¢é»‘æ¦œ
            </button>
        </li>
    </ul>

    <div class="tab-content">

        <div class="tab-pane fade show active" id="users">
            <div class="card">
                <div class="table-responsive">
                    <table class="table table-custom table-hover mb-0">
                        <thead class="table-light">
                        <tr>
                            <th>æ˜µç§° / ID</th>
                            <th>æ‰€åœ¨å®¶åº­</th>
                            <th>èº«ä»½</th>
                            <th class="text-end">ç®¡ç†æ“ä½œ</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for user in users %}
                            <tr>
                                <td>
                                    <div class="fw-bold text-dark">{{ user.display_name }}</div>
                                    <small class="text-muted"
                                           style="font-size:11px; font-family:monospace;">{{ user.id }}</small>
                                </td>
                                <td>
                                    {% if user.families_data %}
                                        <!-- éå†è¯¥ç”¨æˆ·åŠ å…¥çš„æ‰€æœ‰å®¶åº­ -->
                                        <div class="d-flex flex-wrap gap-1">
                                            {% for fam in user.families_data %}
                                                <div class="badge bg-primary bg-opacity-10 text-primary border border-primary d-flex align-items-center">
                                                    <i class="fas fa-home me-1"></i> {{ fam.name }}

                                                    <!-- è¸¢äººå°æŒ‰é’® (åµŒå…¥åœ¨æ ‡ç­¾é‡Œ) -->
                                                    <form action="/admin/unbind_family" method="POST" class="ms-2"
                                                          onsubmit="return confirm('ç¡®å®šè¦æŠŠä»–ä» [{{ fam.name }}] è¸¢å‡ºå»å—ï¼Ÿ')">
                                                        <input type="hidden" name="csrf_token"
                                                               value="{{ csrf_token() }}"/>
                                                        <input type="hidden" name="user_id" value="{{ user.id }}">
                                                        <input type="hidden" name="family_id" value="{{ fam.id }}">
                                                        <button type="submit" class="btn btn-link p-0 text-danger"
                                                                style="line-height: 1;" title="è¸¢å‡º">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <span class="badge bg-secondary bg-opacity-25 text-secondary">
                    <i class="fas fa-wind me-1"></i>æµæµªä¸­
                </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.role == 'admin' %}
                                        <span class="badge bg-warning text-dark border border-warning">ç®¡ç†å‘˜</span>
                                    {% else %}
                                        <span class="badge bg-light text-dark border">æˆå‘˜</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <div class="d-inline-flex gap-1">
                                        <!--
                                        {% if user.id != session['user'] %}
                                            <a href="/admin/login_as/{{ user.id }}" class="btn btn-sm btn-outline-info"
                                               title="ä»¥è¯¥èº«ä»½ç™»å½•" onclick="return confirm('ç¡®å®šè¦åˆ‡æ¢èº«ä»½å—ï¼Ÿ')">
                                                <i class="fas fa-user-secret"></i>
                                            </a>
                                        {% endif %}
                                        -->

                                        <form action="/admin/reset_password/{{ user.id }}" method="POST"
                                              onsubmit="return confirm('ç¡®å®šé‡ç½®ä¸º 123456ï¼Ÿ')" class="d-inline">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                            <button type="submit" class="btn btn-sm btn-outline-primary"
                                                    title="é‡ç½®å¯†ç ">
                                                <i class="fas fa-key"></i>
                                            </button>
                                        </form>

                                        <button class="btn btn-sm btn-outline-dark"
                                                onclick="toggleRawData('{{ user.id }}')" title="åŸå§‹æ•°æ®"><i
                                                class="fas fa-eye"></i></button>

                                        {% if user.id != session['user'] %}
                                            <form action="/admin/delete_user/{{ user.id }}" method="POST"
                                                  onsubmit="return confirm('âš ï¸ å½»åº•åˆ é™¤è¯¥ç”¨æˆ·ï¼Ÿ')" class="d-inline">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                <button type="submit" class="btn btn-sm btn-outline-danger"
                                                        title="å½»åº•åˆ é™¤"><i class="fas fa-trash"></i></button>
                                            </form>
                                        {% endif %}
                                    </div>
                                    <div id="raw-{{ user.id }}" class="raw-data-box text-start mt-2">åŠ è½½ä¸­...</div>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="families">
            <div class="card p-3 mb-3 border-0 bg-light shadow-sm">
                <h6 class="fw-bold mb-2"><i class="fas fa-plus-circle text-primary"></i> åˆ›å»ºæ–°å®¶åº­</h6>
                <form action="/admin/add_family" method="POST" class="d-flex gap-2">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="text" name="name" class="form-control" placeholder="å®¶åº­åç§° (å¦‚: å¹¸ç¦ä¸€å®¶äºº)"
                           required>
                    <button type="submit" class="btn text-white px-4 fw-bold" style="background-color: #6f42c1;">
                        åˆ›å»ºå®¶åº­
                    </button>
                </form>
            </div>

            <div class="card">
                <table class="table table-custom table-hover mb-0">
                    <thead class="table-light">
                    <tr>
                        <th>å®¶åº­åç§°</th>
                        <th>é‚€è¯·ç </th>
                        <th>æˆå‘˜æ¦‚å†µ</th>
                        <th>åˆ›å»ºæ—¥æœŸ</th>
                        <th class="text-end">æ“ä½œ</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for f in families %}
                        <tr>
                            <td><strong>{{ f.name }}</strong></td>
                            <td>
    <span class="invite-code" title="{{ f.invite_code }}">
        {{ f.invite_code[:2] }}****
    </span>
                            </td>
                            <td>
                                    <span class="badge bg-secondary" title="{{ f.members_str }}" style="cursor: help;">
                                        <i class="fas fa-users me-1"></i> {{ f.member_count }} äºº
                                    </span>
                                {% if f.member_count > 0 %}
                                    <small class="text-muted ms-1 d-none d-md-inline" style="font-size: 11px;">
                                        ({{ f.members_str[:10] }}{% if f.members_str|length > 10 %}...{% endif %})
                                    </small>
                                {% endif %}
                            </td>
                            <td><small class="text-muted">{{ f.created_at[:10] }}</small></td>
                            <td class="text-end">
                                <form action="/admin/delete_family/{{ f.id }}" method="POST"
                                      onsubmit="return confirm('ç¡®å®šè§£æ•£è¿™ä¸ªå®¶åº­å—ï¼Ÿ')">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button class="btn btn-sm btn-outline-danger">
                                        <i class="fas fa-trash-alt me-1"></i> è§£æ•£
                                    </button>
                                </form>
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="5" class="text-center text-muted py-4">
                                <i class="fas fa-folder-open fa-2x mb-2 d-block opacity-50"></i>
                                è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•å®¶åº­
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="pets">
            <div class="card p-3 mb-3 border-0 bg-light shadow-sm">
                <h6 class="fw-bold mb-2"><i class="fas fa-plus-circle text-success"></i> æ·»åŠ æ–°å® ç‰©</h6>
                <form action="/admin/add_pet" method="POST" class="d-flex gap-2">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="text" name="name" class="form-control" placeholder="å® ç‰©åå­— (å¦‚: æ—ºè´¢)" required>
                    <select name="type" class="form-select" style="width: 140px;">
                        <option value="dog">ğŸ¶ ç‹—</option>
                        <option value="cat">ğŸ± çŒ«</option>
                    </select>
                    <button type="submit" class="btn btn-success px-4 fw-bold">æ·»åŠ </button>
                </form>
            </div>

            <div class="card">
                <table class="table table-custom table-hover mb-0">
                    <thead class="table-light">
                    <tr>
                        <th>åå­—/ç±»å‹</th>
                        <th>æ‰€å±å®¶åº­</th>
                        <th>ç›‘æŠ¤äºº (ä¸»äºº)</th>
                        <th class="text-end">æ“ä½œ</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for pet in pets %}
                        <tr>
                            <td>
                                <strong>{{ pet.name }}</strong>
                                <span class="badge bg-light text-dark border ms-1">{{ pet.type }}</span>
                            </td>
                            <td>
                                {% if 'æµæµª' in pet.family_name %}
                                    <span class="badge bg-danger bg-opacity-10 text-danger">{{ pet.family_name }}</span>
                                {% else %}
                                    <span class="badge bg-primary bg-opacity-10 text-primary">{{ pet.family_name }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <small class="text-muted">{{ pet.owners_str }}</small>
                            </td>
                            <td class="text-end">
                                <form action="/admin/delete_pet/{{ pet.id }}" method="POST"
                                      onsubmit="return confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="storage">
            <div class="alert alert-info small d-flex justify-content-between align-items-center">
                    <span>
                        <i class="fas fa-hdd me-1"></i>
                        å·²ç”¨ç©ºé—´: <strong>{{ stats.storage_mb }} MB</strong>
                        <span class="ms-2 text-muted">(å…± {{ stats.file_count }} ä¸ªæ–‡ä»¶)</span>
                    </span>
                <button class="btn btn-sm btn-outline-dark bg-white" onclick="location.reload()">
                    <i class="fas fa-sync-alt me-1"></i> åˆ·æ–°åˆ—è¡¨
                </button>
            </div>

            <div class="card">
                <div class="table-responsive">
                    <table class="table table-custom table-hover align-middle mb-0">
                        <thead class="table-light">
                        <tr>
                            <!-- [ä¿®æ”¹] ä¸å†æ˜¾ç¤ºé¢„è§ˆå›¾ï¼Œæ”¹æ˜¾ç¤ºç±»å‹å›¾æ ‡ -->
                            <th style="width: 50px;">ç±»å‹</th>
                            <th>æ–‡ä»¶å / æ—¶é—´</th>
                            <th>ä¸Šä¼ è€…</th>
                            <th>å¤§å°</th>
                            <th class="text-end">æ“ä½œ</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for f in files[:50] %}
                            <tr>
                                <!-- [ä¿®æ”¹] éšç§æ¨¡å¼ï¼šåªæ˜¾ç¤ºä¸€ä¸ªé€šç”¨çš„å›¾ç‰‡å›¾æ ‡ï¼Œä¸åŠ è½½çœŸå®å›¾ç‰‡ -->
                                <td class="text-center text-muted">
                                    <i class="fas fa-file-image fa-lg"></i>
                                </td>

                                <td>
                                    <!-- [ä¿®æ”¹] æ–‡ä»¶åä¸å†åšæˆè¶…é“¾æ¥ï¼Œæˆ–è€…åšä¸€ä¸ªå¾ˆéšè”½çš„â€œä¸‹è½½â€é“¾æ¥ -->
                                    <div class="text-truncate" style="max-width: 200px; font-size: 13px;"
                                         title="{{ f.name }}">
                                        {{ f.name }}
                                    </div>
                                    <small class="text-muted" style="font-size: 11px;">
                                        <i class="far fa-clock me-1"></i>{{ f.created_at_fmt }}
                                    </small>
                                </td>

                                <td>
                                    {% if 'æ— è®°å½•' in f.uploader %}
                                        <span class="badge bg-secondary text-white-50"
                                              style="font-size: 10px;">æœªçŸ¥</span>
                                    {% else %}
                                        <span class="badge bg-info bg-opacity-10 text-info border border-info"
                                              style="font-size: 11px;">
                        {{ f.uploader.replace('âœ… ', '') }}
                    </span>
                                    {% endif %}
                                </td>

                                <td>
                                    <span class="text-muted small">{{ f.size_kb }} KB</span>
                                </td>

                                <td class="text-end">
                                    <form action="/admin/delete_file" method="POST"
                                          onsubmit="return confirm('âš ï¸ ç¡®å®šåˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ\n(æ“ä½œä¸å¯é€†)')">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <input type="hidden" name="file_name" value="{{ f.name }}">
                                        <button class="btn btn-sm btn-outline-danger border-0" title="åˆ é™¤æ–‡ä»¶">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="5" class="text-center py-5 text-muted">
                                    <i class="fas fa-box-open fa-2x mb-3 opacity-25"></i><br>
                                    å­˜å‚¨æ¡¶éå¸¸å¹²å‡€
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if files|length > 50 %}
                    <div class="card-footer text-center text-muted small">
                        ä»…å±•ç¤ºæœ€æ–°çš„ 50 ä¸ªæ–‡ä»¶
                    </div>
                {% endif %}
            </div>
        </div>
        <div class="tab-pane fade" id="updates">
            <div class="card p-4 mb-3 border-0 bg-light shadow-sm">
                <h6 class="fw-bold mb-3"><i class="fas fa-paper-plane text-success me-2"></i>å‘å¸ƒæ–°ç‰ˆæœ¬é€šçŸ¥</h6>
                <form action="/admin/publish_update" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <input type="text" name="version" class="form-control" placeholder="ç‰ˆæœ¬å· (å¦‚ 1.2)"
                                   required>
                        </div>
                        <div class="col-md-7">
                            <textarea name="content" class="form-control" rows="1" placeholder="æ›´æ–°å†…å®¹ (æ”¯æŒæ¢è¡Œ)"
                                      required></textarea>
                        </div>
                        <div class="col-md-2 d-flex align-items-center">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="is_pushed" id="pushSwitch"
                                       checked>
                                <label class="form-check-label small" for="pushSwitch">é¦–é¡µå¼¹çª—</label>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success w-100 mt-3 fw-bold">å‘å¸ƒå…¬å‘Š</button>
                </form>
            </div>

            <div class="card">
                <table class="table table-custom table-hover mb-0">
                    <thead>
                    <tr>
                        <th>ç‰ˆæœ¬</th>
                        <th>å†…å®¹</th>
                        <th>çŠ¶æ€</th>
                        <th>æ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for up in updates %}
                        <tr>
                            <td><span class="badge bg-dark">{{ up.version }}</span></td>
                            <td style="white-space: pre-wrap;">{{ up.content }}</td>
                            <td>
                                <!-- çŠ¶æ€æ˜¾ç¤º + åˆ‡æ¢æŒ‰é’® -->
                                <form action="/admin/toggle_update_status/{{ up.id }}" method="POST" class="d-inline">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    {% if up.is_pushed %}
                                        <button type="submit" class="btn badge bg-success border-0" title="ç‚¹å‡»å…³é—­">æ¨é€ä¸­
                                            <i class="fas fa-check-circle"></i></button>
                                    {% else %}
                                        <button type="submit" class="btn badge bg-secondary border-0 opacity-50"
                                                title="ç‚¹å‡»å¼€å¯">æœªæ¨é€
                                        </button>
                                    {% endif %}
                                </form>
                            </td>
                            <td><small class="text-muted">{{ up.created_at[:10] }}</small></td>
                            <td>
                                <form action="/admin/delete_update/{{ up.id }}" method="POST"
                                      onsubmit="return confirm('ç¡®å®šåˆ é™¤è¯¥å…¬å‘Šï¼Ÿ')">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button class="btn btn-sm btn-link text-danger p-0">åˆ é™¤</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="tab-pane fade" id="codes">
            <div class="card p-4 mb-3 border-0 bg-light shadow-sm">
                <h6 class="fw-bold mb-3"><i class="fas fa-plus-circle text-primary me-2"></i>ç”Ÿæˆæ³¨å†Œæš—å·</h6>
                <form action="/admin/generate_reg_code" method="POST" class="d-flex gap-2 align-items-center">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <span class="text-muted small text-nowrap">å¯ç”¨æ¬¡æ•°:</span>
                    <input type="number" name="max_uses" class="form-control" value="3" style="width: 80px;" min="1"
                           max="100">
                    <button type="submit" class="btn btn-primary fw-bold px-4">ç”Ÿæˆ 6 ä½éšæœºæš—å·</button>
                </form>
            </div>

            <div class="card">
                <table class="table table-custom table-hover mb-0">
                    <thead>
                    <tr>
                        <th>æš—å·</th>
                        <th>æ¶ˆè€—è¿›åº¦</th>
                        <th>çŠ¶æ€</th>
                        <th>ç”Ÿæˆæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for c in reg_codes %}
                        <tr>
                            <td><span class="fs-5 font-monospace fw-bold text-dark">{{ c.code }}</span></td>
                            <td>
                                <!-- è¿›åº¦æ¡å¯è§†åŒ– -->
                                <div class="d-flex align-items-center gap-2">
                                    <div class="progress" style="width: 80px; height: 6px;">
                                        <div class="progress-bar bg-success" role="progressbar"
                                             style="width: {{ (c.current_uses / c.max_uses) * 100 }}%"></div>
                                    </div>
                                    <small class="text-muted">{{ c.current_uses }} / {{ c.max_uses }}</small>
                                </div>
                            </td>
                            <td>
                                {% if c.current_uses >= c.max_uses %}
                                    <span class="badge bg-secondary">å·²ç”¨å®Œ</span>
                                {% else %}
                                    <span class="badge bg-success">æœ‰æ•ˆ</span>
                                {% endif %}
                            </td>
                            <td><small class="text-muted">{{ c.created_at[:10] }}</small></td>
                            <td>
                                <form action="/admin/delete_reg_code/{{ c.id }}" method="POST"
                                      onsubmit="return confirm('ç¡®å®šä½œåºŸæ­¤æš—å·ï¼Ÿ')">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button class="btn btn-sm btn-link text-danger p-0">ä½œåºŸ</button>
                                </form>
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="5" class="text-center py-4 text-muted">æš‚æ— æœ‰æ•ˆæš—å·</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="tab-pane fade" id="config">
            <div class="card p-4 border-0 bg-light shadow-sm">
                <h6 class="fw-bold mb-3">ğŸ¤– AI å…½åŒ»è®¾ç½® (DeepSeek/OpenAI)</h6>
                <form action="/admin/update_config" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                    <div class="mb-3">
                        <label class="form-label small text-muted">API åœ°å€ (Base URL)</label>
                        <input type="text" name="ai_url" class="form-control" value="{{ ai_config.get('ai_url', '') }}"
                               placeholder="https://api.deepseek.com">
                        <div class="form-text small">å¡«å†™åˆ°åŸŸåå³å¯ï¼Œæ— éœ€ /chat/completions</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small text-muted">API Key (å¯†é’¥)</label>
                        <input type="password" name="ai_key" class="form-control"
                               value="{{ ai_config.get('ai_key', '') }}" placeholder="sk-...">
                    </div>

                    <div class="mb-3">
                        <label class="form-label small text-muted">æ¨¡å‹åç§° (Model Name)</label>
                        <input type="text" name="ai_model" class="form-control"
                               value="{{ ai_config.get('ai_model', '') }}" placeholder="deepseek-chat">
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" name="ai_stream" id="streamSwitch"
                               {% if ai_config.get('ai_stream') == 'true' %}checked{% endif %}>
                        <label class="form-check-label" for="streamSwitch">å¼€å¯æµå¼å›å¤</label>
                    </div>

                    <button type="submit" class="btn btn-primary w-100 fw-bold">ä¿å­˜é…ç½®</button>
                </form>
            </div>
        </div>
        <div class="tab-pane fade" id="food">
            <div class="card p-4 mb-3 border-0 bg-light shadow-sm">
                <h6 class="fw-bold mb-3">ğŸ æ·»åŠ é£Ÿç‰©ç¦å¿Œ</h6>
                <form action="/admin/add_food" method="POST" class="row g-3">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="col-md-3">
                        <input type="text" name="name" class="form-control" placeholder="é£Ÿç‰©å (å¦‚: è‘¡è„)" required>
                    </div>
                    <div class="col-md-3">
                        <select name="status" class="form-select">
                            <option value="danger">â˜ ï¸ ç¦é£Ÿ (Danger)</option>
                            <option value="warn">âš ï¸ æ…é£Ÿ (Warn)</option>
                            <option value="safe">âœ… èƒ½åƒ (Safe)</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="text" name="reason" class="form-control" placeholder="åŸå› /åæœ (å¦‚: å¯¼è‡´è‚¾è¡°ç«­)"
                               required>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100 fw-bold">æ·»åŠ </button>
                    </div>
                </form>
            </div>

            <div class="card">
                <table class="table table-custom table-hover mb-0">
                    <thead>
                    <tr>
                        <th>é£Ÿç‰©</th>
                        <th>å®‰å…¨ç­‰çº§</th>
                        <th>åŸå› </th>
                        <th>æ“ä½œ</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for f in food_list %}
                        <tr>
                            <td class="fw-bold">{{ f.name }}</td>
                            <td>
                                {% if f.status == 'danger' %} <span class="badge bg-danger">ç¦æ­¢</span>
                                {% elif f.status == 'warn' %} <span class="badge bg-warning text-dark">æ…é‡</span>
                                {% else %} <span class="badge bg-success">å®‰å…¨</span>
                                {% endif %}
                            </td>
                            <td>{{ f.reason }}</td>
                            <td>
                                <form action="/admin/delete_food/{{ f.id }}" method="POST"
                                      onsubmit="return confirm('åˆ ï¼Ÿ')">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button class="btn btn-sm btn-link text-danger p-0">åˆ é™¤</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const authData = JSON.parse('{{ auth_users | tojson | safe }}');
    const storageData = {{ stats.storage_breakdown | tojson | safe }} || {pet: 0, moment: 0, avatar: 0, other: 0};

    function toggleRawData(uid) {
        const box = document.getElementById('raw-' + uid);
        box.style.display = (box.style.display === 'block') ? 'none' : 'block';
        if (box.style.display === 'block') {
            const userData = authData.find(u => u.id === uid);
            box.innerText = userData ? JSON.stringify(userData, null, 2) : "æ— æ•°æ®";
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        const chartCpu = echarts.init(document.getElementById('chart-cpu'));
        const chartMem = echarts.init(document.getElementById('chart-mem'));
        const chartStorage = echarts.init(document.getElementById('chart-storage'));

        // === 1. ä»ªè¡¨ç›˜ï¼šApple Watch é£æ ¼æ¸å˜ç¯ ===
        function getRingOption(title, colorStart, colorEnd) {
            return {
                series: [{
                    type: 'gauge',
                    startAngle: 90, endAngle: -270,
                    pointer: {show: false}, // ä¸è¦æŒ‡é’ˆ
                    progress: {
                        show: true,
                        overlap: false,
                        roundCap: true, // åœ†è§’ç«¯ç‚¹ (é«˜çº§æ„Ÿæ¥æº)
                        clip: false,
                        itemStyle: {
                            // æ¸å˜è‰²
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                {offset: 0, color: colorStart},
                                {offset: 1, color: colorEnd}
                            ])
                        }
                    },
                    axisLine: {lineStyle: {width: 15, color: [[1, '#f0f2f5']]}}, // åº•è‰²æ·¡ç°
                    splitLine: {show: false},
                    axisTick: {show: false},
                    axisLabel: {show: false},
                    data: [{
                        value: 0,
                        name: title,
                        title: {offsetCenter: ['0%', '120%'], fontSize: 14, color: '#999'}, // æ ‡é¢˜åœ¨ä¸‹é¢
                        detail: {
                            offsetCenter: ['0%', '0%'], // æ•°å­—å±…ä¸­
                            fontSize: 30,
                            fontWeight: 'bold',
                            color: '#333',
                            formatter: '{value}%'
                        }
                    }]
                }]
            };
        }

        let optCpu = getRingOption('CPU', '#4facfe', '#00f2fe'); // è“é’æ¸å˜
        let optMem = getRingOption('å†…å­˜', '#43e97b', '#38f9d7'); // ç»¿é’æ¸å˜

        chartCpu.setOption(optCpu);
        chartMem.setOption(optMem);

        // === 2. å­˜å‚¨å›¾ï¼šåœ†è§’ç”œç”œåœˆ (è«å…°è¿ªè‰²) ===
        const storageOption = {
            tooltip: {trigger: 'item', formatter: '{b}: {c}MB ({d}%)'},
            legend: {top: 'middle', right: '0%', orient: 'vertical', icon: 'circle'},
            series: [{
                name: 'å­˜å‚¨',
                type: 'pie',
                radius: ['50%', '75%'], // ç”œç”œåœˆ
                center: ['35%', '50%'], // å¾€å·¦ç§»ä¸€ç‚¹ï¼Œç»™å›¾ä¾‹ç•™ä½ç½®
                avoidLabelOverlap: false,
                itemStyle: {
                    borderRadius: 8,
                    borderColor: '#fff',
                    borderWidth: 3
                },
                label: {show: false},
                // é«˜çº§é…è‰²
                color: [
                    '#5470c6', // è“è‰² - å® ç‰©
                    '#91cc75', // ç»¿è‰² - åŠ¨æ€
                    '#fac858', // é»„è‰² - å¤´åƒ
                    '#ee6666', // çº¢è‰² - æ”¶çº³
                    '#9a60b4', // ç´«è‰² - å…¶ä»–
                    '#fc8452', // æ©™è‰² - é¢„ç•™1
                    '#73c0de', // æµ…è“ - é¢„ç•™2
                    '#ea7ccc'  // ç²‰è‰² - é¢„ç•™3
                ],
                data: [
                    {value: storageData.pet, name: 'ğŸ± å® ç‰©'},
                    {value: storageData.moment, name: 'ğŸ“¸ åŠ¨æ€'},
                    {value: storageData.avatar, name: 'ğŸ‘¤ å¤´åƒ'},
                    {value: storageData.inventory, name: 'ğŸ“¦ æ”¶çº³'}, // [æ–°å¢]
                    {value: storageData.other, name: 'ğŸ“‚ å…¶ä»–'}
                ]
            }]
        };
        chartStorage.setOption(storageOption);

        // === 3. å®æ—¶æ•°æ®æ›´æ–° ===
        function fetchServerStats() {
            fetch('/api/server_stats')
                .then(res => res.json())
                .then(data => {
                    // åŠ¨æ€æ›´æ–°æ•°æ®
                    optCpu.series[0].data[0].value = Math.round(data.cpu);
                    chartCpu.setOption(optCpu);

                    optMem.series[0].data[0].value = Math.round(data.memory);
                    chartMem.setOption(optMem);
                })
                .catch(err => console.error(err));
        }

        setInterval(fetchServerStats, 2000);
        fetchServerStats();

        window.addEventListener('resize', () => {
            chartCpu.resize();
            chartMem.resize();
            chartStorage.resize();
        });
    });
</script>
</body>
</html>